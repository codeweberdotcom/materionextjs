# Реомендации Junie RateLimit_01

Дата: 2025-11-13 14:00

Этот документ — обновлённая записка по подсистеме ограничения частоты запросов (rate limiting). Основан на файле «Реомендации Junie RateLimit.md» и текущем состоянии кода.

## Объект анализа
- Сервис: `src/lib/rate-limit.ts` (конфиги, checkLimit, события, статистика, списки/состояния)
- Типы: `src/lib/rate-limit/types.ts`
- Хранилища: `src/lib/rate-limit/stores/*` — Prisma/Redis и фабрика выбора стора
- Применения: чат (`src/lib/sockets/namespaces/chat/index.ts`), REST (`src/app/api/chat/messages/route.ts`)

---

## Что уже исправлено/реализовано
1) Инициализация дефолтных конфигов при старте
- Конструктор `RateLimitService` сначала вызывает `setDefaultConfigs()`, затем `loadConfigs()` — дефолты активны сразу (для известных модулей), закрывая «окно без лимитов».

2) Устойчивый fallback Redis → Prisma
- Введён `ResilientRateLimitStore` (`stores/index.ts`), перехватывающий ошибки primary‑хранилища и автоматически переключающийся на fallback c логом.

3) Атомарность инкремента и устранение гонок в Prisma‑ветке
- `stores/prisma-store.ts` выполняет всё в транзакции c `count: { increment: 1 }`, пересчётом окна и единоразовыми событиями.

4) Дедупликация событий в Prisma‑ветке
- Warning генерируется при пересечении порога, Block — при первом превышении в окне (исключает спам событий).

5) Режим monitor поддержан корректно
- В обоих сторах блоки не применяются, но события фиксируются, `allowed: true`.

6) Единый сервис в потребителях
- И сокеты, и REST используют `rateLimitService.checkLimit(...)`; есть предупреждения и сообщения о блокировке.

---

## Что осталось сделать (разрывы)
1) Неизвестные модули без лимитов
- `checkLimit()` при отсутствии конфига возвращает `allowed: true`. Нужен глобальный дефолт или fail‑fast с логом/алертом.

2) Дедупликация событий в Redis‑ветке
- Сейчас warning пишется при каждом `remaining <= warnThreshold`; block может записываться повторно. Нужна логика «пересечения порога» и «первого выхода за лимит».

3) Политика атрибутов блокировки per‑module
- Сейчас блок активен при совпадении по любому атрибуту (userId/email/ip). Нужна конфигурация стратегии на модуль (например, `chat`: userId; `auth`: userId+IP; публичные: IP).

4) Единый формат `retryAfter`/`blockedUntil` на проводе
- Сокеты/REST возвращают `blockedUntil` как ISO‑строку, а клиент местами ждёт число (ms). Стандартизировать на UNIX ms (number) и обновить контракт.

5) Пагинация смешанных списков в `listStates()`
- Совмещение `state` и `manual` может приводить к повтором/пропускам курсоров. Разнести источники или унифицировать схему курсора.

6) Индексирование БД
- Подтвердить индексы для `rateLimitState`/`rateLimitEvent` и `message(createdAt)` (статистика `chat`). При необходимости — добавить.

7) Нормализация/кардинальность IP‑ключей
- Для публичных модулей возможна высокая кардинальность. Рассмотреть нормализацию (CIDR/укорочение IPv6), TTL для старых состояний.

8) PII в событиях/логах
- Хранятся `email`, `ipAddress`. Согласовать с политикой приватности (маскирование/минимизация).

9) Предварительный connect к Redis при старте (опционально)
- Чтобы заранее зафиксировать отказ и перейти на Prisma до начала трафика.

10) Документация и админ‑UI
- Отразить режимы monitor/enforce, политику OR/AND для блокировок, формат полей `retryAfter/blockedUntil` (ms), стратегию per‑module.

---

## Приоритет внедрения (предложение)
1) Унифицировать формат `retryAfter`/`blockedUntil` (ms number) во всех слоях (сервис → сокеты/REST → клиент).
2) Дедупликация warning/block в `stores/redis-store.ts` по аналогии с Prisma.
3) Конфигурация стратегии блокировок per‑module (userId/email/ip) и документация.
4) Поведение для неизвестных модулей: глобальные дефолты или fail‑fast с алертом.
5) Исправить пагинацию `listStates()` и проверить индексы БД.
6) Нормализация IP‑ключей и пересмотр PII (по требованиям).
7) (Опционально) Примонтировать preconnect к Redis при инициализации.

---

## Чек‑лист
- [ ] Формат ms (number) для `blockedUntil`/`retryAfter` повсеместно
- [ ] Redis‑store: события только при пересечении порога/первом блоке
- [ ] Стратегии блокировок per‑module (конфиг + дока)
- [ ] Неизвестные модули: дефолт или fail‑fast
- [ ] Пагинация `listStates()` без повторов/пропусков
- [ ] Индексы БД подтверждены/добавлены
- [ ] Нормализация IP и TTL для состояний (по потребности)
- [ ] Политика PII/маскирование
- [ ] (Опц.) Preconnect к Redis

---

## Ссылки на ключевые файлы
- `src/lib/rate-limit.ts`
- `src/lib/rate-limit/types.ts`
- `src/lib/rate-limit/stores/prisma-store.ts`
- `src/lib/rate-limit/stores/redis-store.ts`
- `src/lib/rate-limit/stores/index.ts`
- Потребители: `src/app/api/chat/messages/route.ts`, `src/lib/sockets/namespaces/chat/index.ts`
