# –û—Ç—á—ë—Ç –æ —Å—Ç–∞—Ç—É—Å–µ –º–æ–¥—É–ª—è RateLimit
## –î–∞—Ç–∞: 2025-11-16

–ê–Ω–∞–ª–∏–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞ **"Junie Final Ratelimit.MD"** –∏ —Ç–µ–∫—É—â–µ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã.

---

## ‚úÖ –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –ó–ê–î–ê–ß–ò

### –†–∞–∑–¥–µ–ª 1: –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –º–æ–¥—É–ª—è
–í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ –∏–∑ —Ä–∞–∑–¥–µ–ª–∞ 1 –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω—ã –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ:
- ‚úì –°—Ç–∞—Ä—Ç–∞–ø –±–µ–∑ ¬´–¥—ã—Ä¬ª: –¥–µ—Ñ–æ–ª—Ç—ã –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è, `checkLimit()` –∂–¥—ë—Ç –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –∫–æ–Ω—Ñ–∏–≥–æ–≤
- ‚úì Resilient –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞: Redis ‚Üí Prisma fallback —Å –∞–≤—Ç–æ-–≤–æ–∑–≤—Ä–∞—Ç–æ–º
- ‚úì –ê—Ç–æ–º–∞—Ä–Ω–æ—Å—Ç—å –≤ PrismaStore: —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–∞—Å—á—ë—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è
- ‚úì –ó–∞—â–∏—Ç–∞ –æ—Ç schema mismatch: —Ñ–ª–∞–≥–∏ `storeEmailInEvents`/`storeIpInEvents`
- ‚úì –°–æ–∫–µ—Ç—ã: –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è/–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏, `Retry-After`
- ‚úì Fail-fast –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö –º–æ–¥—É–ª–µ–π

### –†–∞–∑–¥–µ–ª 2.1: RedisStore monitor-–¥–µ–¥—É–ø
**‚úÖ –í–´–ü–û–õ–ù–ï–ù–û**
- –§–∞–π–ª: `src/lib/rate-limit/stores/redis-store.ts`
- –°—Ç—Ä–æ–∫–∏ 125-152: –ª–æ–≥–∏–∫–∞ –¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏–∏ block-events –≤ —Ä–µ–∂–∏–º–µ monitor
- –ú–µ—Ç–æ–¥ `blockEventMetaKey()` (251-254): —Å–æ–∑–¥–∞–Ω–∏–µ –º–µ—Ç–∞-–∫–ª—é—á–∞ —Å window bucket
- –ú–µ—Ç–æ–¥ `blockMetaPattern()` (256-261): –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –ø–æ–∏—Å–∫–∞/–æ—á–∏—Å—Ç–∫–∏
- `resetCache()` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —É–¥–∞–ª—è–µ—Ç –º–µ—Ç–∞-–∫–ª—é—á–∏ (—Å—Ç—Ä–æ–∫–∏ 211, 223, 230)

### –†–∞–∑–¥–µ–ª 2.4: –ú–µ—Ç—Ä–∏–∫–∏ resilient-—Å–ª–æ—è
**‚úÖ –í–´–ü–û–õ–ù–ï–ù–û**
- –§–∞–π–ª: `src/lib/metrics/rate-limit.ts`
- –ú–µ—Ç—Ä–∏–∫–∏ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã:
  - `rate_limit_store_backend` (gauge) ‚Äî —Å—Ç—Ä–æ–∫–∏ 7-14
  - `rate_limit_fallback_switch_total{from,to}` (counter) ‚Äî —Å—Ç—Ä–æ–∫–∏ 16-21
  - `rate_limit_redis_failures_total` (counter) ‚Äî —Å—Ç—Ä–æ–∫–∏ 23-27
  - `rate_limit_fallback_duration_seconds` (histogram) ‚Äî —Å—Ç—Ä–æ–∫–∏ 29-34
  - `rate_limit_consume_duration_seconds{backend,module,mode}` (histogram) ‚Äî —Å—Ç—Ä–æ–∫–∏ 36-42
  - `rate_limit_unknown_module_total{module}` (counter) ‚Äî —Å—Ç—Ä–æ–∫–∏ 44-49

### –†–∞–∑–¥–µ–ª 2.5: –ú–µ–ª–∫–∏–µ —Ñ–∏–∫—Å—ã
**‚úÖ –í–°–ï –í–´–ü–û–õ–ù–ï–ù–´**

1. **`getStats()`: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `const blockedCount = activeStates`**
   - –§–∞–π–ª: `src/lib/rate-limit.ts`, —Å—Ç—Ä–æ–∫–∞ 540
   - ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

2. **–ê–¥–º–∏–Ω-API: `stats.filter(Boolean)`**
   - –§–∞–π–ª: `src/app/api/admin/rate-limits/route.ts`, —Å—Ç—Ä–æ–∫–∞ 43
   - ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `stats.filter((stat): stat is RateLimitStats => Boolean(stat))`

3. **`/api/ads/route.ts`: `if (!user)` –≤–º–µ—Å—Ç–æ `if (!session?.user)`, —É–±—Ä–∞—Ç—å `@ts-nocheck`**
   - –§–∞–π–ª: `src/app/api/ads/route.ts`
   - ‚úÖ –°—Ç—Ä–æ–∫–∞ 10: –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `if (!user)`
   - ‚úÖ –ù–µ—Ç `@ts-nocheck` –≤ –Ω–∞—á–∞–ª–µ —Ñ–∞–π–ª–∞

### –ò—Ç–µ—Ä–∞—Ü–∏—è 1 (–±—ã—Å—Ç—Ä—ã–π –ø–∞–∫–µ—Ç)
**üéâ –ü–û–õ–ù–û–°–¢–¨–Æ –í–´–ü–û–õ–ù–ï–ù–ê**
- ‚úÖ RedisStore monitor-–¥–µ–¥—É–ø block-events
- ‚úÖ –ú–µ–ª–∫–∏–µ –ø—Ä–∞–≤–∫–∏ (const, filter(Boolean), —Ñ–∏–∫—Å /api/ads/route.ts)
- ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ resilient-—Å–ª–æ—è + rate_limit_unknown_module_total

---

## ‚ö†Ô∏è –û–°–¢–ê–í–®–ò–ï–°–Ø –ó–ê–î–ê–ß–ò

### –†–∞–∑–¥–µ–ª 2.2: –ü–∞–≥–∏–Ω–∞—Ü–∏—è –∞–¥–º–∏–Ω-—Å–ø–∏—Å–∫–æ–≤
**‚ùå –ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–ü—Ä–æ–±–ª–µ–º–∞:** –¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –≤ `listStates()` (src/lib/rate-limit.ts, —Å—Ç—Ä–æ–∫–∏ 776-1059) –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è RateLimitState –∏ —Ä—É—á–Ω—ã–µ –±–ª–æ–∫–∏ UserBlock, –Ω–æ –ø–∞–≥–∏–Ω–∞—Ü–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–π.

**–í–∞—Ä–∏–∞–Ω—Ç—ã —Ä–µ—à–µ–Ω–∏—è:**
- **–í–∞—Ä–∏–∞–Ω—Ç A (–±—ã—Å—Ç—Ä—ã–π):** –†–∞–∑–¥–µ–ª–∏—Ç—å –Ω–∞ –¥–≤–µ –≤–∫–ª–∞–¥–∫–∏:
  - State (—Ç–æ–ª—å–∫–æ RateLimitState)
  - Manual (—Ç–æ–ª—å–∫–æ UserBlock)
  - –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –∫—É—Ä—Å–æ—Ä—ã –∏ total –¥–ª—è –∫–∞–∂–¥–æ–π –≤–∫–ª–∞–¥–∫–∏
  
- **–í–∞—Ä–∏–∞–Ω—Ç B (—Å–ª–æ–∂–Ω—ã–π):** –£–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫—É—Ä—Å–æ—Ä –¥–ª—è –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ —Å:
  - –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ `blockedUntil DESC, source ASC, id ASC`
  - –ö—É—Ä—Å–æ—Ä —Ö—Ä–∞–Ω–∏—Ç `{lastEntry: {id, source, sortKey, tieKey}}`
  - –¢—Ä–µ–±—É–µ—Ç –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—É—é –ª–æ–≥–∏–∫—É —Å—Ä–∞–≤–Ω–µ–Ω–∏—è

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í—ã–±—Ä–∞—Ç—å –í–∞—Ä–∏–∞–Ω—Ç A –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏, –ª–∏–±–æ —Ç—â–∞—Ç–µ–ª—å–Ω–æ —Å–ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –í–∞—Ä–∏–∞–Ω—Ç B.

---

### –†–∞–∑–¥–µ–ª 2.3: PII-–º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è —Å–æ–±—ã—Ç–∏–π
**‚ùå –ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:**
- –°–æ–±—ã—Ç–∏—è (`RateLimitEvent`) —Ö—Ä–∞–Ω—è—Ç —Å—ã—Ä—ã–µ `ipAddress` –∏ `email`
- –ë–ª–æ–∫–∏ (`UserBlock`) —Ö—Ä–∞–Ω—è—Ç —Å—ã—Ä—ã–µ `ipAddress`
- –û—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –ø–æ–ª—è `ipHash`, `ipPrefix`, `hashVersion`, `cidr`

**–¢—Ä–µ–±—É–µ—Ç—Å—è:**
1. –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –≤ Prisma schema:
   - `RateLimitEvent`: `ipHash`, `ipPrefix`, `hashVersion`
   - `UserBlock`: `cidr`, –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–Ω—ã–π `ipAddress` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —É—Ç–∏–ª–∏—Ç—ã:
   - `hashIpAddress(ip: string, secret: string, version: number): string` ‚Äî HMAC-SHA256
   - `extractIpPrefix(ip: string): string` ‚Äî IPv4 /24, IPv6 /48
   - `encryptIp(ip: string, key: string): string` ‚Äî AES-GCM (–¥–ª—è –¥–æ–ª–≥–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤)

3. –û–±–Ω–æ–≤–∏—Ç—å `recordEvent()` (src/lib/rate-limit.ts, —Å—Ç—Ä–æ–∫–∏ 291-395):
   - –í–º–µ—Å—Ç–æ —Å—ã—Ä–æ–≥–æ IP –∑–∞–ø–∏—Å—ã–≤–∞—Ç—å `ipHash` –∏ `ipPrefix`

4. –û–±–Ω–æ–≤–∏—Ç—å `createManualBlock()` (—Å—Ç—Ä–æ–∫–∏ 1176-1239):
   - –î–ª—è IP-–±–ª–æ–∫–æ–≤ —Ö—Ä–∞–Ω–∏—Ç—å `cidr` –≤–º–µ—Å—Ç–æ/–≤–º–µ—Å—Ç–µ —Å —Å—ã—Ä—ã–º IP

5. –†–µ—Ç–µ–Ω—à–Ω-job:
   - –î–∞—É–Ω–≥—Ä–µ–π–¥: raw ‚Üí hash ‚Üí prefix ‚Üí –∞–≥—Ä–µ–≥–∞—Ç—ã
   - –†–æ—Ç–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–∞ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º `hashVersion`

**–î–æ–∫—É–º–µ–Ω—Ç—ã:** –†–∞–∑–¥–µ–ª 3 "Junie Final Ratelimit.MD"

---

### –†–∞–∑–¥–µ–ª 2.4: –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ë–î
**‚ùì –¢–†–ï–ë–£–ï–¢ –ü–†–û–í–ï–†–ö–ò**

**–ù—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤:**
1. `Message(createdAt)` ‚Äî –¥–ª—è –ø–æ–¥—Å—á—ë—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ `getStats()` (—Å—Ç—Ä–æ–∫–∞ 544)
2. `RateLimitState`:
   - –ö–æ–º–ø–æ–∑–∏—Ç–Ω—ã–π –∏–Ω–¥–µ–∫—Å `(module, blockedUntil)` ‚Äî –¥–ª—è `listStates()` (—Å—Ç—Ä–æ–∫–∞ 794)
   - –ò–Ω–¥–µ–∫—Å `(key, module)` ‚Äî —É–∂–µ –µ—Å—Ç—å (unique constraint)
3. `RateLimitEvent`:
   - –ò–Ω–¥–µ–∫—Å `(createdAt DESC)` ‚Äî –¥–ª—è `listEvents()` (—Å—Ç—Ä–æ–∫–∞ 1113)
   - –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤: `(module)`, `(eventType)`, `(mode)`, `(key)`
4. `UserBlock`:
   - –ò–Ω–¥–µ–∫—Å—ã –¥–ª—è –ø–æ–∏—Å–∫–∞: `(userId)`, `(ipAddress)`, `(module, isActive)`

**–î–µ–π—Å—Ç–≤–∏–µ:** –û—Ç–∫—Ä—ã—Ç—å `prisma/schema.prisma` –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å/–¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã.

---

### –†–∞–∑–¥–µ–ª 2.6: –¢–µ—Å—Ç—ã
**‚ùå –ù–ï –†–ï–ê–õ–ò–ó–û–í–ê–ù–û**

**–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ —Ç–µ—Å—Ç—ã:**
1. **Unit-—Ç–µ—Å—Ç—ã RateLimitService:**
   - –ü–µ—Ä–µ—Ö–æ–¥—ã warn ‚Üí block
   - –ü–æ–≤–µ–¥–µ–Ω–∏–µ monitor vs enforce —Ä–µ–∂–∏–º–æ–≤
   - Fallback –Ω–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –º–æ–¥—É–ª—å (fail-fast)

2. **Unit-—Ç–µ—Å—Ç—ã PrismaStore:**
   - –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∏–Ω–∫—Ä–µ–º–µ–Ω—Ç—ã (race conditions)
   - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏/—Å–±—Ä–æ—Å–∞

3. **Unit-—Ç–µ—Å—Ç—ã RedisStore:**
   - –î–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è block-events –≤ monitor —Ä–µ–∂–∏–º–µ
   - –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å TTL –¥–ª—è –º–µ—Ç–∞-–∫–ª—é—á–µ–π
   - `resetCache()` –æ—á–∏—â–∞–µ—Ç –º–µ—Ç–∞-–∫–ª—é—á–∏

4. **Integration-—Ç–µ—Å—Ç—ã ResilientStore:**
   - Fallback –ø—Ä–∏ –æ—à–∏–±–∫–µ Redis
   - –ê–≤—Ç–æ–≤–æ–∑–≤—Ä–∞—Ç –∫ Redis –ø–æ—Å–ª–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
   - –ú–µ—Ç—Ä–∏–∫–∏ fallback_duration, redis_failures

5. **API-—Ç–µ—Å—Ç—ã:**
   - –ê–¥–º–∏–Ω-—ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (GET/PUT/DELETE `/api/admin/rate-limits`)
   - Rate-limit —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (–ø—Ä–æ–≤–µ—Ä–∫–∞ 429 —Å—Ç–∞—Ç—É—Å–∞, –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –ù–∞—á–∞—Ç—å —Å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —é–Ω–∏—Ç-—Ç–µ—Å—Ç–æ–≤ –¥–ª—è store-—Å–ª–æ—è.

---

### –†–∞–∑–¥–µ–ª 2.7: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è/–æ–ø–µ—Ä–∞—Ü–∏–æ–Ω–∫–∞
**‚ö†Ô∏è –ß–ê–°–¢–ò–ß–ù–û –í–´–ü–û–õ–ù–ï–ù–û**

**–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã:**
- ‚úÖ `docs/api/rate-limits.md` ‚Äî API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- ‚úÖ `docs/monitoring/rate-limit-operations.md` ‚Äî –º–µ—Ç—Ä–∏–∫–∏ –∏ –æ–ø–µ—Ä–∞—Ü–∏–∏
- ‚úÖ `Junie Final Ratelimit.MD` ‚Äî –∏—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á—ë—Ç

**–¢—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç—å:**
1. **–ê–¥–º–∏–Ω-–≥–∞–π–¥:**
   - –†–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É monitor –∏ enforce —Ä–µ–∂–∏–º–∞–º–∏
   - Fail-fast –ø–æ–ª–∏—Ç–∏–∫–∞ –¥–ª—è –Ω–æ–≤—ã—Ö –º–æ–¥—É–ª–µ–π
   - –ö–∞–∫ —Å–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ñ–∏–≥ –¥–æ –¥–µ–ø–ª–æ—è –Ω–æ–≤–æ–≥–æ –º–æ–¥—É–ª—è

2. **Privacy/PII —à–ø–∞—Ä–≥–∞–ª–∫–∞:**
   - –ü–æ–ª–∏—Ç–∏–∫–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è IP (–ø–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–∞–∑–¥–µ–ª–∞ 2.3)
   - –†–µ—Ç–µ–Ω—à–Ω –∏ –¥–∞—É–Ω–≥—Ä–µ–π–¥ –¥–∞–Ω–Ω—ã—Ö
   - –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ GDPR (LIA/DPIA —à–∞–±–ª–æ–Ω—ã)

3. **Runbook:**
   - –ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ —Å—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–∏ –∞–ª–µ—Ä—Ç–∞ `rate_limit_unknown_module_total > 0`
   - –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ —Ä–æ—Ç–∞—Ü–∏–∏ —Å–µ–∫—Ä–µ—Ç–∞ –¥–ª—è ipHash
   - –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ö–µ–º—ã

---

## üìä –ò–¢–û–ì–û–í–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê

| –ö–∞—Ç–µ–≥–æ—Ä–∏—è | –°—Ç–∞—Ç—É—Å |
|-----------|--------|
| **–†–∞–∑–¥–µ–ª 1: –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å** | ‚úÖ 6/6 –≤—ã–ø–æ–ª–Ω–µ–Ω–æ |
| **–ò—Ç–µ—Ä–∞—Ü–∏—è 1 (–±—ã—Å—Ç—Ä—ã–π –ø–∞–∫–µ—Ç)** | ‚úÖ 3/3 –≤—ã–ø–æ–ª–Ω–µ–Ω–æ |
| **–†–∞–∑–¥–µ–ª 2.2: –ü–∞–≥–∏–Ω–∞—Ü–∏—è** | ‚ùå 0/1 –Ω–µ –Ω–∞—á–∞—Ç–æ |
| **–†–∞–∑–¥–µ–ª 2.3: PII-–º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è** | ‚ùå 0/5 –Ω–µ –Ω–∞—á–∞—Ç–æ |
| **–†–∞–∑–¥–µ–ª 2.4: –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è** | ‚ùì —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ |
| **–†–∞–∑–¥–µ–ª 2.6: –¢–µ—Å—Ç—ã** | ‚ùå 0/5 –Ω–µ –Ω–∞—á–∞—Ç–æ |
| **–†–∞–∑–¥–µ–ª 2.7: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** | ‚ö†Ô∏è 3/6 —á–∞—Å—Ç–∏—á–Ω–æ |

**–ü—Ä–æ–≥—Ä–µ—Å—Å:** ~40% –∑–∞–¥–∞—á –≤—ã–ø–æ–ª–Ω–µ–Ω–æ (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ + –ò—Ç–µ—Ä–∞—Ü–∏—è 1)

---

## üéØ –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –ü–†–ò–û–†–ò–¢–ï–¢–ê–ú

### –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–ò—Ç–µ—Ä–∞—Ü–∏—è 2):
1. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å/–¥–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –ë–î** (—Ä–∞–∑–¥–µ–ª 2.4)
   - –ë—ã—Å—Ç—Ä–∞—è –∑–∞–¥–∞—á–∞, –∫—Ä–∏—Ç–∏—á–Ω–∞ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
   
2. **–í—ã–±—Ä–∞—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç –ø–∞–≥–∏–Ω–∞—Ü–∏–∏** (—Ä–∞–∑–¥–µ–ª 2.2)
   - –í–∞—Ä–∏–∞–Ω—Ç A (–≤–∫–ª–∞–¥–∫–∏) ‚Äî –±—ã—Å—Ç—Ä–æ
   - –í–∞—Ä–∏–∞–Ω—Ç B (–µ–¥–∏–Ω—ã–π —Å–ø–∏—Å–æ–∫) ‚Äî —Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

3. **–ù–∞—á–∞—Ç—å PII-–º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—é** (—Ä–∞–∑–¥–µ–ª 2.3)
   - –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—è –≤ —Å—Ö–µ–º—É
   - –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —É—Ç–∏–ª–∏—Ç—ã —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
   - –û–±–Ω–æ–≤–∏—Ç—å –∑–∞–ø–∏—Å—å —Å–æ–±—ã—Ç–∏–π

### –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
4. **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ unit-—Ç–µ—Å—Ç—ã** (—Ä–∞–∑–¥–µ–ª 2.6)
   - PrismaStore (race conditions)
   - RedisStore (–¥–µ–¥—É–ø–ª–∏–∫–∞—Ü–∏—è)
   - ResilientStore (fallback)

### –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç (–ò—Ç–µ—Ä–∞—Ü–∏—è 3):
5. **–§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏** (—Ä–∞–∑–¥–µ–ª 2.7)
   - –ê–¥–º–∏–Ω-–≥–∞–π–¥ –ø–æ monitor/enforce
   - Privacy/PII —à–ø–∞—Ä–≥–∞–ª–∫–∞
   - Runbook –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤

6. **–†–µ—Ç–µ–Ω—à–Ω-job –∏ —Ä–æ—Ç–∞—Ü–∏—è —Å–µ–∫—Ä–µ—Ç–∞** (—Ä–∞–∑–¥–µ–ª 2.3)
   - –ü–æ—Å–ª–µ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –±–∞–∑–æ–≤–æ–≥–æ PII-—Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è

---

## üìù –ó–ê–ö–õ–Æ–ß–ï–ù–ò–ï

**–ò—Ç–µ—Ä–∞—Ü–∏—è 1 (–±—ã—Å—Ç—Ä—ã–π –ø–∞–∫–µ—Ç) –ø–æ–ª–Ω–æ—Å—Ç—å—é –≤—ã–ø–æ–ª–Ω–µ–Ω–∞:**
- ‚úÖ –í—Å–µ –º–µ—Ç—Ä–∏–∫–∏ resilient-—Å–ª–æ—è —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ RedisStore –¥–µ–¥—É–ø–ª–∏—Ü–∏—Ä—É–µ—Ç block-events –≤ monitor —Ä–µ–∂–∏–º–µ
- ‚úÖ –ú–µ–ª–∫–∏–µ —Ñ–∏–∫—Å—ã –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –ë–î (15 –º–∏–Ω—É—Ç)
2. –í—ã–±—Ä–∞—Ç—å –ø–æ–¥—Ö–æ–¥ –∫ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ (–æ–±—Å—É–¥–∏—Ç—å —Å –∫–æ–º–∞–Ω–¥–æ–π)
3. –ù–∞—á–∞—Ç—å –ø—Ä–æ–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ PII-–º–∏–Ω–∏–º–∏–∑–∞—Ü–∏–∏ (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è GDPR)
4. –ù–∞–ø–∏—Å–∞—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ unit-—Ç–µ—Å—Ç—ã –¥–ª—è store-—Å–ª–æ—è

**–ú–æ–¥—É–ª—å –≥–æ—Ç–æ–≤ –∫ production –¥–ª—è –±–∞–∑–æ–≤—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤**, –Ω–æ —Ç—Ä–µ–±—É–µ—Ç –¥–æ—Ä–∞–±–æ—Ç–∫–∏ –¥–ª—è:
- GDPR-–∫–æ–º–ø–ª–∞–µ–Ω—Å–∞ (PII-–º–∏–Ω–∏–º–∏–∑–∞—Ü–∏—è)
- –£–ª—É—á—à–µ–Ω–Ω–æ–≥–æ UX –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏ (–ø–∞–≥–∏–Ω–∞—Ü–∏—è)
- –ù–∞–¥—ë–∂–Ω–æ—Å—Ç–∏ –≤ –¥–æ–ª–≥–æ—Å—Ä–æ—á–Ω–æ–π –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–µ (—Ç–µ—Å—Ç—ã)
