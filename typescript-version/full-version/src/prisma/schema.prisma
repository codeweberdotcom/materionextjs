datasource db {
    provider = "sqlite"
    url      = env("DATABASE_URL")
  }

generator client {
  provider        = "prisma-client-js"
  binaryTargets   = ["native", "debian-openssl-3.0.x", "linux-arm64-openssl-1.1.x", "rhel-openssl-3.0.x"]
}

model Account {
  id                 String  @id @default(cuid())
  userId             String
  type               String
  provider           String
  providerAccountId  String
  refresh_token      String?
  access_token       String?
  expires_at         Int?
  token_type         String?
  scope              String?
  id_token           String?
  session_state      String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expiresAt    DateTime

  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
}

model User {
       id            String    @id @default(cuid())
       name          String?
       email         String    @unique
       password      String
       emailVerified DateTime?
       image         String?
       roleId        String
       language      String    @default("Russian")
       currency      String    @default("RUB")
       country       String    @default("russia")
       isActive      Boolean   @default(true)
       role          Role      @relation(fields: [roleId], references: [id])
       accounts      Account[]
       sessions      Session[]
       sentMessages  Message[] @relation("MessageSender")
       user1Rooms    ChatRoom[] @relation("User1Rooms")
       user2Rooms    ChatRoom[] @relation("User2Rooms")
       notifications Notification[]
       blocks        UserBlock[]
       createdAt     DateTime  @default(now())
       updatedAt     DateTime  @updatedAt
     }

 model Role {
   id          String   @id @default(cuid())
   name        String   @unique
   description String?
   permissions String?  @default("{}")  // JSON: {"module": ["action1", "action2"]}
   users       User[]
   createdAt   DateTime @default(now())
   updatedAt   DateTime @updatedAt
 }

model VerificationToken {
   identifier String
   token      String   @unique
   expires    DateTime

   @@unique([identifier, token])
}

model Language {
   id          String   @id @default(cuid())
   name        String   @unique
   code        String   @unique
   isActive    Boolean  @default(true)
   createdAt   DateTime @default(now())
   updatedAt   DateTime @updatedAt
}

model Country {
      id          String   @id @default(cuid())
      name        String   @unique
      code        String   @unique
      isActive    Boolean  @default(true)
      states      State[]
      createdAt   DateTime @default(now())
      updatedAt   DateTime @updatedAt
  }


model Currency {
   id          String   @id @default(cuid())
   name        String   @unique
   code        String   @unique
   symbol      String
   isActive    Boolean  @default(true)
   createdAt   DateTime @default(now())
   updatedAt   DateTime @updatedAt
}

model State {
       id          String   @id @default(cuid())
       name        String
       code        String
       countryId   String?
       country     Country? @relation(fields: [countryId], references: [id], onDelete: Cascade)
       isActive    Boolean  @default(true)
       createdAt   DateTime @default(now())
       updatedAt   DateTime @updatedAt

       cities      City[]

       @@unique([name, id])
   }

model City {
        id          String   @id @default(cuid())
        name        String
        code        String
        stateId     String?
        state       State?   @relation(fields: [stateId], references: [id], onDelete: Cascade)
        isActive    Boolean  @default(true)
        createdAt   DateTime @default(now())
        updatedAt   DateTime @updatedAt

        districts   District[]

        @@unique([name, id])
    }

model District {
    id          String   @id @default(cuid())
    name        String
    code        String
    cityId      String?
    city        City?    @relation(fields: [cityId], references: [id], onDelete: Cascade)
    isActive    Boolean  @default(true)
    createdAt   DateTime @default(now())
    updatedAt   DateTime @updatedAt

    @@unique([name, id])
}

model Translation {
     id          String   @id @default(cuid())
     key         String   // e.g., "navigation.dashboards"
     language    String   // e.g., "en", "fr", "ar"
     value       String   // The translated text
     namespace   String   @default("common") // e.g., "navigation", "common", "forms"
     isActive    Boolean  @default(true)
     createdAt   DateTime @default(now())
     updatedAt   DateTime @updatedAt

     @@unique([key, language, namespace])
   }

model EmailTemplate {
      id          String   @id @default(cuid())
      name        String   @unique
      subject     String
      content     String
      isActive    Boolean  @default(true)
      createdAt   DateTime @default(now())
      updatedAt   DateTime @updatedAt
    }

model ChatRoom {
  id        String   @id @default(cuid())
  user1Id   String
  user2Id   String
  user1     User     @relation("User1Rooms", fields: [user1Id], references: [id], onDelete: Cascade)
  user2     User     @relation("User2Rooms", fields: [user2Id], references: [id], onDelete: Cascade)
  messages  Message[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([user1Id, user2Id])
}

model Message {
  id        String   @id @default(cuid())
  content   String
  senderId  String
  sender    User     @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  roomId    String
  room      ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  readAt    DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Notification {
   id          String   @id @default(cuid())
   userId      String
   user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
   title       String
   message     String
   type        String   @default("system") // system, chat, email, etc.
   status      String   @default("unread") // unread, read, trash
   avatarImage String?
   avatarIcon  String?
   avatarText  String?
   avatarColor String?
   avatarSkin  String?
   createdAt   DateTime @default(now())
   updatedAt   DateTime @updatedAt
 }

model RateLimit {
  id          String   @id @default(cuid())
  key         String   // IP или userId
  module      String   // 'chat', 'ads', 'upload', 'auth'
  count       Int      @default(0)
  windowStart DateTime @default(now())
  windowEnd   DateTime
  blockedUntil DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([key, module, windowStart])
}

model RateLimitConfig {
  id          String @id @default(cuid())
  module      String @unique // 'chat', 'ads', 'upload', 'auth'
  maxRequests Int    // Максимум запросов
  windowMs    Int    // Окно в миллисекундах
  blockMs     Int    // Блокировка в миллисекундах
  isActive    Boolean @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model RateLimitState {
  id          String   @id @default(cuid())
  key         String   // IP или userId
  module      String   // 'chat', 'ads', 'upload', 'auth'
  count       Int      @default(0) // Текущее количество запросов в окне
  windowStart DateTime @default(now()) // Начало текущего окна
  windowEnd   DateTime // Конец текущего окна
  blockedUntil DateTime? // Время окончания блокировки (если заблокирован)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([key, module])
}

model UserBlock {
  id          String   @id @default(cuid())
  userId      String?
  user        User?    @relation(fields: [userId], references: [id], onDelete: Cascade)
  ipAddress   String?  // IP адрес для блокировки неавторизованных пользователей
  reason      String   // 'spam', 'abuse', 'rate_limit_violation', etc.
  module      String   // 'chat', 'auth', 'registration', 'ads', etc.
  blockedBy   String   // ID администратора, который заблокировал
  blockedAt   DateTime @default(now())
  unblockedAt DateTime? // Время разблокировки (null = permanent)
  isActive    Boolean  @default(true)
  notes       String?  // Дополнительные заметки администратора

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Индексы для быстрого поиска
  @@index([userId])
  @@index([ipAddress])
  @@index([module])
  @@index([isActive])
  @@index([unblockedAt])
}

