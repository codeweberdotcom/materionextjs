# –ê–Ω–∞–ª–∏–∑: –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ S3 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –≤ –º–µ–¥–∏–∞—Ç–µ–∫–µ

**–î–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è:** 2025-12-01  
**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í—ã—Å–æ–∫–∏–π

---

## üéØ –¶–µ–ª—å –∞–Ω–∞–ª–∏–∑–∞

–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –∏ —É—Å—Ç—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –≤ –º–µ–¥–∏–∞—Ç–µ–∫–µ –ø—Ä–∏ —Ä–µ–∂–∏–º–µ —Ö—Ä–∞–Ω–µ–Ω–∏—è "S3 only", –≤–∫–ª—é—á–∞—è:
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –ø—Ä–µ–≤—å—é –¥–ª—è S3 —Ñ–∞–π–ª–æ–≤
- –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ proxy –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ S3

---

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### –ß—Ç–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è:

- –ú–æ–¥—É–ª—å Media (`src/services/media/`)
- –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –º–µ–¥–∏–∞—Ç–µ–∫–∏ (`src/views/admin/media/`)
- API endpoints (`src/app/api/admin/media/`)
- S3 —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è (`src/services/media/sync/`)

### –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è:

- –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤
- –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤ –Ω–∞ S3
- –ü—Ä–æ–≤–µ—Ä–∫–∞ MinIO bucket permissions
- –ê–Ω–∞–ª–∏–∑ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è URL –≤ UI

---

## üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **–í–∞—Ä–∏–∞–Ω—Ç—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –Ω–∞ S3**
   - –û–ø–∏—Å–∞–Ω–∏–µ: –ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã (thumb, medium, large) –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è, —Ç.–∫. —É—Å–ª–æ–≤–∏–µ `!alreadyOnS3` –±–ª–æ–∫–∏—Ä—É–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –µ—Å–ª–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª —É–∂–µ –Ω–∞ S3
   - –í–ª–∏—è–Ω–∏–µ: –í—ã—Å–æ–∫–æ–µ ‚Äî —Å—Å—ã–ª–∫–∏ –Ω–∞ –≤–∞—Ä–∏–∞–Ω—Ç—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç `NoSuchKey` –æ—à–∏–±–∫—É
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π
   - –§–∞–π–ª: `src/services/media/storage/StorageService.ts`

2. **MinIO bucket –Ω–µ –ø—É–±–ª–∏—á–Ω—ã–π**
   - –û–ø–∏—Å–∞–Ω–∏–µ: Bucket `555` –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è, –ø—Ä—è–º—ã–µ URL –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç `AccessDenied`
   - –í–ª–∏—è–Ω–∏–µ: –í—ã—Å–æ–∫–æ–µ ‚Äî –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ —Ñ–∞–π–ª–∞–º
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –í—ã—Å–æ–∫–∏–π

3. **–ú–µ–¥–∏–∞—Ç–µ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç proxy –≤–º–µ—Å—Ç–æ –ø—Ä—è–º–æ–≥–æ S3**
   - –û–ø–∏—Å–∞–Ω–∏–µ: –§—É–Ω–∫—Ü–∏—è `getMediaUrl` –≤ MediaLibrary.tsx –≤—Å–µ–≥–¥–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç proxy URL `/api/admin/media/{id}/file` –¥–ª—è S3 —Ñ–∞–π–ª–æ–≤
   - –í–ª–∏—è–Ω–∏–µ: –°—Ä–µ–¥–Ω–µ–µ ‚Äî —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –Ω–µ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ (–ª–∏—à–Ω—è—è –Ω–∞–≥—Ä—É–∑–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä)
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –°—Ä–µ–¥–Ω–∏–π
   - –§–∞–π–ª: `src/views/admin/media/MediaLibrary.tsx`

4. **s3PublicUrlPrefix –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –≤ MediaLibrary**
   - –û–ø–∏—Å–∞–Ω–∏–µ: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ `s3PublicUrlPrefix` –∏–∑ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ –Ω–µ –ø–µ—Ä–µ–¥–∞—ë—Ç—Å—è –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –º–µ–¥–∏–∞—Ç–µ–∫–∏
   - –í–ª–∏—è–Ω–∏–µ: –°—Ä–µ–¥–Ω–µ–µ ‚Äî –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä—è–º–æ–π S3 URL –¥–∞–∂–µ –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω–æ–º prefix
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –°—Ä–µ–¥–Ω–∏–π
   - –§–∞–π–ª: `src/views/admin/media/MediaLibrary.tsx`

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:

1. **–ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ –ø—É–±–ª–∏—á–Ω–æ–º—É S3**
   - –û–ø–∏—Å–∞–Ω–∏–µ: –ü—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω–æ–º `s3PublicUrlPrefix` –∏ –ø—É–±–ª–∏—á–Ω–æ–º bucket –º–æ–∂–Ω–æ –∑–∞–≥—Ä—É–∂–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–∞–ø—Ä—è–º—É—é —Å S3
   - –ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω–∞—è –≤—ã–≥–æ–¥–∞: –°–Ω–∏–∂–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏ –Ω–∞ Next.js —Å–µ—Ä–≤–µ—Ä, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ CDN –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è

---

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–ò—Å–ø—Ä–∞–≤–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤**
   - –û–ø–∏—Å–∞–Ω–∏–µ: –ò–∑–º–µ–Ω–∏—Ç—å –ª–æ–≥–∏–∫—É `syncToS3` –¥–ª—è –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–∞–∂–¥–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞
   - –û—Ü–µ–Ω–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: –°—Ä–µ–¥–Ω—è—è
   - –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏: 30 –º–∏–Ω—É—Ç

2. **–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ MinIO bucket**
   - –û–ø–∏—Å–∞–Ω–∏–µ: –í—ã–ø–æ–ª–Ω–∏—Ç—å `mc anonymous set download local/555`
   - –û—Ü–µ–Ω–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: –ù–∏–∑–∫–∞—è
   - –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏: 5 –º–∏–Ω—É—Ç

3. **–†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ S3 –≤ –º–µ–¥–∏–∞—Ç–µ–∫–µ**
   - –û–ø–∏—Å–∞–Ω–∏–µ: –î–æ–±–∞–≤–∏—Ç—å state `s3PublicUrlPrefix`, –∑–∞–≥—Ä—É–∂–∞—Ç—å –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ `getMediaUrl`
   - –û—Ü–µ–Ω–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: –°—Ä–µ–¥–Ω—è—è
   - –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏: 20 –º–∏–Ω—É—Ç

---

## üìù –í—ã–≤–æ–¥—ã

–û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ ‚Äî –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–æ–ø—É—Å–∫–∞–µ—Ç –∏—Ö –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏. –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ MinIO –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∏ —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ MediaLibrary –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä—è–º—ã—Ö S3 URL.

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [–ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏](../../plans/completed/plan-media-s3-direct-access-2025-12-01.md)
- [–û—Ç—á—ë—Ç](../../reports/deployment/report-media-s3-direct-access-2025-12-01.md)



