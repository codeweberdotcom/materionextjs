# –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã: Race condition –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ Redis

**–î–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è:** 2025-11-23  
**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í—ã—Å–æ–∫–∏–π

---

## üéØ –¶–µ–ª—å –∞–Ω–∞–ª–∏–∑–∞

–í—ã—è–≤–∏—Ç—å –ø—Ä–∏—á–∏–Ω—É –æ—à–∏–±–∫–∏ "Redis is already connecting/connected" –≤ –º–æ–¥—É–ª–µ rate-limit –∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ.

---

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### –ß—Ç–æ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è:
- –ú–æ–¥—É–ª—å `RedisRateLimitStore` –≤ `src/lib/rate-limit/stores/redis-store.ts`
- –ú–µ—Ö–∞–Ω–∏–∑–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Redis –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ fallback –Ω–∞ Prisma store

### –ú–µ—Ç–æ–¥–æ–ª–æ–≥–∏—è:
- –ê–Ω–∞–ª–∏–∑ –∫–æ–¥–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Redis
- –ò–∑—É—á–µ–Ω–∏–µ –ø–æ–≤–µ–¥–µ–Ω–∏—è ioredis –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è—Ö
- –ê–Ω–∞–ª–∏–∑ –ª–æ–≥–æ–≤ –æ—à–∏–±–æ–∫

---

## üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **Race condition –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ Redis**
   - –û–ø–∏—Å–∞–Ω–∏–µ: –ü—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø–æ—Ç–æ–∫–æ–≤ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –≤—ã–∑—ã–≤–∞—é—Ç `ensureConnected()`, —á—Ç–æ –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –ø–æ–ø—ã—Ç–∫–µ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –æ–¥–Ω–æ–º—É –∏ —Ç–æ–º—É –∂–µ Redis –∫–ª–∏–µ–Ω—Ç—É
   - –í–ª–∏—è–Ω–∏–µ: –í—ã—Å–æ–∫–æ–µ - –ø—Ä–∏–≤–æ–¥–∏—Ç –∫ –Ω–µ–æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω–æ–º—É fallback –Ω–∞ Prisma store, —Å–Ω–∏–∂–∞—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–π
   - –°–∏–º–ø—Ç–æ–º—ã:
     ```
     error: [rate-limit] Redis store failed. Falling back to Prisma store for rate limiting.
     {"error":{"message":"Redis is already connecting/connected","name":"Error"}}
     ```

2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è**
   - –û–ø–∏—Å–∞–Ω–∏–µ: –ú–µ—Ç–æ–¥ `ensureConnected()` –Ω–µ –∑–∞—â–∏—â–µ–Ω –æ—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –≤—ã–∑–æ–≤–æ–≤
   - –í–ª–∏—è–Ω–∏–µ: –°—Ä–µ–¥–Ω–µ–µ - –≤—ã–∑—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏ —Ç–æ–ª—å–∫–æ –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ
   - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: –í—ã—Å–æ–∫–∏–π

---

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–î–æ–±–∞–≤–∏—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è**
   - –û–ø–∏—Å–∞–Ω–∏–µ: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ñ–ª–∞–≥ `connecting: Promise<void> | null` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è. –ï—Å–ª–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É–∂–µ –∏–¥–µ—Ç, –¥—Ä—É–≥–∏–µ –≤—ã–∑–æ–≤—ã –¥–æ–ª–∂–Ω—ã –∂–¥–∞—Ç—å –µ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
   - –û—Ü–µ–Ω–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏: –ù–∏–∑–∫–∞—è
   - –û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏: 30 –º–∏–Ω—É—Ç
   - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è:
     ```typescript
     private connecting: Promise<void> | null = null
     
     private async ensureConnected() {
       if (this.ready) return
       if (this.connecting) await this.connecting
       this.connecting = this.redis.connect().then(() => {
         this.ready = true
         this.connecting = null
       })
       await this.connecting
     }
     ```

---

## üìù –í—ã–≤–æ–¥—ã

–ü—Ä–æ–±–ª–µ–º–∞ –≤—ã–∑–≤–∞–Ω–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ–º —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –ø–æ–ø—ã—Ç–∫–∞—Ö –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Redis. –†–µ—à–µ–Ω–∏–µ - –¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º –æ–∂–∏–¥–∞–Ω–∏—è —É–∂–µ –∏–¥—É—â–µ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≤–º–µ—Å—Ç–æ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ.

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [–ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è](plans/active/plan-fix-redis-connection-race-2025-11-23.md)
- [–û—Ç—á–µ—Ç –æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏](reports/testing/report-fix-redis-connection-race-2025-11-23.md)
- [–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è](fixes/redis-connection-race-fix.md)








