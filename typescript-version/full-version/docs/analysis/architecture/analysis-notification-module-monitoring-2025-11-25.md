# –ê–Ω–∞–ª–∏–∑: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –º–æ–¥—É–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π - –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

**–î–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è:** 2025-11-25  
**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à—ë–Ω  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í—ã—Å–æ–∫–∏–π

---

## üéØ –¶–µ–ª—å –∞–Ω–∞–ª–∏–∑–∞

–û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è –º–æ–¥—É–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Ñ—É–Ω–∫—Ü–∏—è–º–∏:
1. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
2. –ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
3. –î–∞—à–±–æ—Ä–¥ –≤ –∞–¥–º–∏–Ω–∫–µ

---

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-----------|--------|----------|
| NotificationService | ‚úÖ | –ï–¥–∏–Ω—ã–π —Å–µ—Ä–≤–∏—Å –æ—Ç–ø—Ä–∞–≤–∫–∏ —á–µ—Ä–µ–∑ –∫–∞–Ω–∞–ª—ã |
| NotificationQueue | ‚úÖ | Bull + in-memory fallback |
| 4 –∫–∞–Ω–∞–ª–∞ | ‚úÖ | Email, SMS, Browser, Telegram |
| ScenarioEngine | ‚úÖ | –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∞–≤–∏–ª –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ–±—ã—Ç–∏–π |
| ScenarioService | ‚úÖ | CRUD –æ–ø–µ—Ä–∞—Ü–∏–π –¥–ª—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ |
| EventHandlers | ‚úÖ | –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ —Å–æ–±—ã—Ç–∏—è |
| API —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ | ‚úÖ | /api/admin/notification-scenarios |
| –ê–¥–º–∏–Ω–∫–∞ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ | ‚úÖ | /admin/notifications/scenarios |
| Telegram –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ | ‚úÖ | /apps/settings/telegram |
| SMS.ru –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ | ‚úÖ | /apps/settings/sms-ru |

### Prisma –º–æ–¥–µ–ª–∏:

```prisma
model NotificationScenario {
  id          String   @id @default(cuid())
  name        String
  description String?
  enabled     Boolean  @default(true)
  trigger     String   // JSON: EventTrigger
  actions     String   // JSON: ScenarioAction[]
  conditions  String?  // JSON: ScenarioConditions
  priority    Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
}

model NotificationExecution {
  id          String   @id @default(cuid())
  scenarioId  String
  eventId     String?
  status      String   // pending | processing | completed | failed | cancelled
  result      String?  // JSON
  error       String?
  createdAt   DateTime @default(now())
  completedAt DateTime?
}
```

### –ß—Ç–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç:

1. **Prometheus –º–µ—Ç—Ä–∏–∫–∏** –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
2. **UI –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∏—Å—Ç–æ—Ä–∏–∏** –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
3. **–î–∞—à–±–æ—Ä–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏** —Å –≥—Ä–∞—Ñ–∏–∫–∞–º–∏
4. **–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –∏ –ø–æ–∏—Å–∫** –≤ –∏—Å—Ç–æ—Ä–∏–∏

---

## üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞

### –ù–∞–π–¥–µ–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:

#### 1. Prometheus –º–µ—Ç—Ä–∏–∫–∏
- –°—á—ë—Ç—á–∏–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –ø–æ –∫–∞–Ω–∞–ª–∞–º
- Histogram –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏
- –°—á—ë—Ç—á–∏–∫–∏ –æ—à–∏–±–æ–∫
- Gauge —Ä–∞–∑–º–µ—Ä–∞ –æ—á–µ—Ä–µ–¥–∏

#### 2. –ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è
- –¢–∞–±–ª–∏—Ü–∞ —Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è–º–∏ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —Å—Ç–∞—Ç—É—Å—É, —Å—Ü–µ–Ω–∞—Ä–∏—é, –¥–∞—Ç–µ
- –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
- –ü–æ–≤—Ç–æ—Ä–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ

#### 3. –î–∞—à–±–æ—Ä–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
- –ö–∞—Ä—Ç–æ—á–∫–∏ —Å –∫–ª—é—á–µ–≤—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏ (–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è, –æ—à–∏–±–∫–∏, –æ—á–µ—Ä–µ–¥—å)
- –ì—Ä–∞—Ñ–∏–∫ –æ—Ç–ø—Ä–∞–≤–æ–∫ –ø–æ –∫–∞–Ω–∞–ª–∞–º (7 –¥–Ω–µ–π)
- –°–ø–∏—Å–æ–∫ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–π
- –¢–æ–ø —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ –ø–æ –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏

---

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. Prometheus –º–µ—Ç—Ä–∏–∫–∏

**–§–∞–π–ª:** `src/lib/metrics/notifications.ts`

| –ú–µ—Ç—Ä–∏–∫–∞ | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|---------|-----|----------|
| `notifications_sent_total` | Counter | –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø–æ –∫–∞–Ω–∞–ª–∞–º |
| `notifications_failed_total` | Counter | –û—à–∏–±–∫–∏ –ø–æ –∫–∞–Ω–∞–ª–∞–º |
| `notification_send_duration_seconds` | Histogram | –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ |
| `notification_queue_size` | Gauge | –†–∞–∑–º–µ—Ä –æ—á–µ—Ä–µ–¥–∏ |
| `scenario_executions_total` | Counter | –í—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ |

**–û—Ü–µ–Ω–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:** –ù–∏–∑–∫–∞—è  
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** 30 –º–∏–Ω

---

### 2. API –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏

**–≠–Ω–¥–ø–æ–∏–Ω—Ç—ã:**

| –ú–µ—Ç–æ–¥ | –ü—É—Ç—å | –û–ø–∏—Å–∞–Ω–∏–µ |
|-------|------|----------|
| GET | `/api/admin/notifications/stats` | –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥ |
| GET | `/api/admin/notifications/executions` | –ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–π |
| GET | `/api/admin/notifications/executions/[id]` | –î–µ—Ç–∞–ª–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è |
| POST | `/api/admin/notifications/executions/[id]/retry` | –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É |

**–û—Ü–µ–Ω–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:** –°—Ä–µ–¥–Ω—è—è  
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** 1 —á–∞—Å

---

### 3. –î–∞—à–±–æ—Ä–¥ –≤ –∞–¥–º–∏–Ω–∫–µ

**–°—Ç—Ä–∞–Ω–∏—Ü–∞:** `/admin/notifications/dashboard`

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- StatCards ‚Äî 4 –∫–∞—Ä—Ç–æ—á–∫–∏ —Å –∫–ª—é—á–µ–≤—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏
- ChannelChart ‚Äî –≥—Ä–∞—Ñ–∏–∫ –ø–æ –∫–∞–Ω–∞–ª–∞–º (recharts)
- RecentExecutions ‚Äî —Ç–∞–±–ª–∏—Ü–∞ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–π
- TopScenarios ‚Äî —Ç–æ–ø –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

**–û—Ü–µ–Ω–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:** –°—Ä–µ–¥–Ω—è—è  
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** 1.5 —á–∞—Å–∞

---

### 4. –ò—Å—Ç–æ—Ä–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–π

**–°—Ç—Ä–∞–Ω–∏—Ü–∞:** `/admin/notifications/executions`

**–§—É–Ω–∫—Ü–∏–∏:**
- –¢–∞–±–ª–∏—Ü–∞ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
- –§–∏–ª—å—Ç—Ä—ã: —Å—Ç–∞—Ç—É—Å, —Å—Ü–µ–Ω–∞—Ä–∏–π, –∫–∞–Ω–∞–ª, –¥–∞—Ç–∞
- –ü–æ–∏—Å–∫ –ø–æ eventId
- –î–µ—Ç–∞–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –≤ –¥–∏–∞–ª–æ–≥–µ
- –ö–Ω–æ–ø–∫–∞ "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å" –¥–ª—è failed

**–û—Ü–µ–Ω–∫–∞ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏:** –°—Ä–µ–¥–Ω—è—è  
**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** 1 —á–∞—Å

---

## üìù –í—ã–≤–æ–¥—ã

–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –º–æ–¥—É–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–æ–º –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π:
- –ü–æ–≤—ã—Å–∏—Ç –Ω–∞–±–ª—é–¥–∞–µ–º–æ—Å—Ç—å —Å–∏—Å—Ç–µ–º—ã
- –£–ø—Ä–æ—Å—Ç–∏—Ç –æ—Ç–ª–∞–¥–∫—É –ø—Ä–æ–±–ª–µ–º
- –î–∞—Å—Ç –ø–æ–Ω–∏–º–∞–Ω–∏–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤
- –ü–æ–∑–≤–æ–ª–∏—Ç –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –æ—à–∏–±–∫–∏

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** 4 —á–∞—Å–∞

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [–ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏](../../plans/active/plan-notification-monitoring-2025-11-25.md)
- [–ê–Ω–∞–ª–∏–∑ –º–æ–¥—É–ª—è —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤](analysis-notification-scenarios-module-2025-01-24.md)





