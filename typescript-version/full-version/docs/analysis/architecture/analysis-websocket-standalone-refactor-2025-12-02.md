# ะะฝะฐะปะธะท: ะะตัะฐะบัะพัะธะฝะณ WebSocket ัะตัะฒะตัะฐ ะฝะฐ standalone ะฐััะธัะตะบัััั

**ะะฐัะฐ ะฟัะพะฒะตะดะตะฝะธั:** 2025-12-02  
**ะกัะฐััั:** ะะฐะฒะตััะตะฝ  
**ะัะธะพัะธัะตั:** ะััะพะบะธะน

---

## ๐ฏ ะฆะตะปั ะฐะฝะฐะปะธะทะฐ

ะััะปะตะดะพะฒะฐัั ัะตะบัััั ะฐััะธัะตะบัััั WebSocket ัะตัะฒะตัะฐ ะธ ะฟัะตะดะปะพะถะธัั ัะตัะฐะบัะพัะธะฝะณ ะฝะฐ standalone ะฐััะธัะตะบัััั ะดะปั ััััะฐะฝะตะฝะธั ะบะพะฝัะปะธะบัะพะฒ ั Next.js ะธ ัะพะพัะฒะตัััะฒะธั ัะพะฒัะตะผะตะฝะฝัะผ ััะฐะฝะดะฐััะฐะผ.

---

## ๐ ะขะตะบััะตะต ัะพััะพัะฝะธะต

### ะงัะพ ะฐะฝะฐะปะธะทะธััะตััั:

- WebSocket ัะตัะฒะตั (`src/server/websocket-server-new.ts`)
- ะกะบัะธะฟัั ะทะฐะฟััะบะฐ ะฒ `package.json`
- ะะพะฝัะปะธะบัั ะฟัะธ ะพะดะฝะพะฒัะตะผะตะฝะฝะพะผ ะทะฐะฟััะบะต ะฟัะพัะตััะพะฒ
- ะะฝัะตะณัะฐัะธั ั Socket.IO ะบะปะธะตะฝัะพะผ

### ะะตัะพะดะพะปะพะณะธั:

- ะะฝะฐะปะธะท ะบะพะดะฐ WebSocket ัะตัะฒะตัะฐ
- ะัะพะฒะตัะบะฐ ะบะพะฝัะปะธะบัะพะฒ `.next/trace`
- ะะทััะตะฝะธะต ัะพะฒัะตะผะตะฝะฝัั ะฟะฐััะตัะฝะพะฒ (Discord, Slack, Next.js docs)
- ะกัะฐะฒะฝะตะฝะธะต ั ะผะธะบัะพัะตัะฒะธัะฝะพะน ะฐััะธัะตะบัััะพะน

---

## ๐ ะะตะทัะปััะฐัั ะฐะฝะฐะปะธะทะฐ

### ะะฐะนะดะตะฝะฝัะต ะฟัะพะฑะปะตะผั:

#### 1. **Custom Server ะบะพะฝัะปะธะบั ั Next.js**
   - **ะะฟะธัะฐะฝะธะต:** `websocket-server-new.ts` ะธะผะฟะพััะธััะตั ะธ ะทะฐะฟััะบะฐะตั Next.js (`import next from 'next'`), ัะพะทะดะฐะฒะฐั ะบะพะฝัะปะธะบั ะฟัะธ ะฟะฐัะฐะปะปะตะปัะฝะพะผ ะทะฐะฟััะบะต ั `pnpm dev`
   - **ะกะธะผะฟัะพะผั:** `Error: EPERM: operation not permitted, open '.next/trace'`
   - **ะะปะธัะฝะธะต:** ะััะพะบะพะต (ะฑะปะพะบะธััะตั ะทะฐะฟััะบ ัะตัะตะท `concurrently`)
   - **ะัะธะพัะธัะตั:** ะัะธัะธัะตัะบะธะน

#### 2. **ะะพัะตัั ะพะฟัะธะผะธะทะฐัะธะน Next.js**
   - **ะะฟะธัะฐะฝะธะต:** Custom Server ะพัะบะปััะฐะตั ะฒัััะพะตะฝะฝัะต ะพะฟัะธะผะธะทะฐัะธะธ Next.js (automatic static optimization, ISR, streaming)
   - **ะะปะธัะฝะธะต:** ะกัะตะดะฝะตะต (ะทะฐะผะตะดะปะตะฝะธะต, ะฑะพะปััะต RAM)
   - **ะัะธะพัะธัะตั:** ะกัะตะดะฝะธะน

#### 3. **ะะตะฒะพะทะผะพะถะฝะพััั serverless ะดะตะฟะปะพั**
   - **ะะฟะธัะฐะฝะธะต:** Custom Server ะฝะต ัะฐะฑะพัะฐะตั ะฝะฐ Vercel, AWS Lambda, ะดััะณะธั serverless ะฟะปะฐััะพัะผะฐั
   - **ะะปะธัะฝะธะต:** ะะธะทะบะพะต (ะฟัะพะตะบั self-hosted)
   - **ะัะธะพัะธัะตั:** ะะธะทะบะธะน

#### 4. **ะกะปะพะถะฝะพััั ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธั**
   - **ะะฟะธัะฐะฝะธะต:** ะะดะธะฝ ะฟัะพัะตัั ัะพะฒะผะตัะฐะตั HTTP ะธ WebSocket, ะฝะตะปัะทั ะผะฐัััะฐะฑะธัะพะฒะฐัั ะฝะตะทะฐะฒะธัะธะผะพ
   - **ะะปะธัะฝะธะต:** ะััะพะบะพะต (ะฟัะธ ัะพััะต ะฝะฐะณััะทะบะธ)
   - **ะัะธะพัะธัะตั:** ะััะพะบะธะน

### ะะฐะนะดะตะฝะฝัะต ะฒะพะทะผะพะถะฝะพััะธ:

#### 1. **Standalone WebSocket ัะตัะฒะตั**
   - **ะะฟะธัะฐะฝะธะต:** ะัะฝะตััะธ WebSocket ะฝะฐ ะพัะดะตะปัะฝัะน ะฟะพัั (3001), ะธัะฟะพะปัะทะพะฒะฐัั ัะธัััะน HTTP ัะตัะฒะตั ะฑะตะท Next.js
   - **ะัะณะพะดะฐ:** ะะตั ะบะพะฝัะปะธะบัะพะฒ, ะฝะตะทะฐะฒะธัะธะผะพะต ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธะต, ะฟัะพัะต debugging

#### 2. **Redis PubSub ะดะปั ัะธะฝััะพะฝะธะทะฐัะธะธ**
   - **ะะฟะธัะฐะฝะธะต:** ะัะฟะพะปัะทะพะฒะฐัั Socket.IO Redis Adapter ะดะปั ัะธะฝััะพะฝะธะทะฐัะธะธ ะผะตะถะดั Next.js ะธ WebSocket ัะตัะฒะตัะฐะผะธ
   - **ะัะณะพะดะฐ:** ะะฐัััะฐะฑะธัะพะฒะฐะฝะธะต ะฝะฐ ะฝะตัะบะพะปัะบะพ ะธะฝััะฐะฝัะพะฒ

#### 3. **Nginx ะฟัะพะบัะธ**
   - **ะะฟะธัะฐะฝะธะต:** ะะดะธะฝะฐั ัะพัะบะฐ ะฒัะพะดะฐ ัะตัะตะท Nginx (ะฟะพัั 80), ัะพััะธะฝะณ ะฝะฐ Next.js ะธ WebSocket
   - **ะัะณะพะดะฐ:** ะะปั ะบะปะธะตะฝัะฐ ะฒัั ะฝะฐ ะพะดะฝะพะผ ะดะพะผะตะฝะต

---

## ๐๏ธ ะะฝะฐะปะธะท ะฐััะธัะตะบัััั

### ะขะตะบััะฐั ะฐััะธัะตะบัััะฐ (Custom Server):

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  websocket-server-new.ts                  โ
โ  โโโ import next from 'next'              โ
โ  โโโ createServer()                       โ
โ  โโโ app.prepare()                        โ
โ  โโโ initializeSocketServer(server)       โ
โ  โโโ server.listen(3000)                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
         โ
    Port 3000
    โโโ HTTP/API (Next.js)
    โโโ WebSocket (Socket.IO)
```

**ะัะพะฑะปะตะผั:**
- โ ะะพะฝัะปะธะบั ะฟัะธ `concurrently "pnpm dev:socket" "pnpm dev"`
- โ ะะฒะฐ ะฟัะพัะตััะฐ ะฟััะฐัััั ัะพะทะดะฐัั `.next/trace`
- โ ะะฐัััะฐะตั ัะตะบะพะผะตะฝะดะฐัะธะธ Next.js 15

### ะัะตะดะปะฐะณะฐะตะผะฐั ะฐััะธัะตะบัััะฐ (Standalone):

```
โโโโโโโโโโโโโโโโโโโโโโโ     โโโโโโโโโโโโโโโโโโโโโโโ
โ   Next.js Server    โ     โ  WebSocket Server   โ
โ   Port 3000         โ     โ  Port 3001          โ
โ                     โ     โ                     โ
โ  โโโ Pages/SSR      โ     โ  โโโ Socket.IO      โ
โ  โโโ API Routes     โ     โ  โโโ Auth (Lucia)   โ
โ  โโโ Server Actions โ     โ  โโโ Namespaces:    โ
โ  โโโ Static         โ     โ  โ   /chat          โ
โ                     โ     โ  โ   /notifications โ
โโโโโโโโโโโโฌโโโโโโโโโโโ     โโโโโโโโโโโโฌโโโโโโโโโโโ
           โ                           โ
           โโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโ
                    โ
          โโโโโโโโโโโโโโโโโโโ
          โ  Redis PubSub   โ
          โ  (Sync ะผะตะถะดั    โ
          โ   ัะตัะฒะตัะฐะผะธ)    โ
          โโโโโโโโโโโโโโโโโโโ
```

**ะัะตะธะผััะตััะฒะฐ:**
- โ ะะตั ะบะพะฝัะปะธะบัะพะฒ ะฟัะพัะตััะพะฒ
- โ ะะตะทะฐะฒะธัะธะผะพะต ะผะฐัััะฐะฑะธัะพะฒะฐะฝะธะต
- โ ะะทะพะปััะธั ะพัะธะฑะพะบ
- โ ะกะพะพัะฒะตัััะฒัะตั Next.js best practices

---

## ๐ง ะขะตัะฝะธัะตัะบะธะต ะดะตัะฐะปะธ

### WebSocket ัะตัะฒะตั (standalone)

**ะขัะตะฑะพะฒะฐะฝะธั:**
- ะะตะท ะธะผะฟะพััะฐ Next.js
- HTTP ัะตัะฒะตั ัะพะปัะบะพ ะดะปั WebSocket upgrade
- Health check endpoint (`/health`)
- Lucia auth middleware
- Redis adapter ะดะปั Socket.IO

### Next.js ัะตัะฒะตั

**ะััะฐัััั ะบะฐะบ ะตััั:**
- `pnpm dev` ะทะฐะฟััะบะฐะตั ััะฐะฝะดะฐััะฝัะน Next.js
- API routes, SSR, static optimization
- ะะตั Socket.IO ะบะพะดะฐ

### ะะปะธะตะฝััะบะฐั ัะฐััั

**ะะทะผะตะฝะตะฝะธั:**
```typescript
// ะัะปะพ:
const socket = io() // ะะพะดะบะปััะตะฝะธะต ะบ ัะตะบััะตะผั ัะพััั

// ะกัะฐะฝะตั:
const socket = io(process.env.NEXT_PUBLIC_WS_URL || 'http://localhost:3001')
```

### Redis ัะธะฝััะพะฝะธะทะฐัะธั

Socket.IO Redis Adapter ะพะฑะตัะฟะตัะธั:
- ะกะธะฝััะพะฝะธะทะฐัะธั ัะพะฑััะธะน ะผะตะถะดั ัะตัะฒะตัะฐะผะธ
- Broadcast ะฒัะตะผ ะฟะพะดะบะปัััะฝะฝัะผ ะบะปะธะตะฝัะฐะผ
- ะะฐัััะฐะฑะธัะพะฒะฐะฝะธะต ะฝะฐ N ะธะฝััะฐะฝัะพะฒ

---

## ๐ ะกัะฐะฒะฝะตะฝะธะต ะฟัะพะธะทะฒะพะดะธัะตะปัะฝะพััะธ

| ะะตััะธะบะฐ | Custom Server | Standalone |
|---------|:-------------:|:----------:|
| RAM (Next.js) | 250 MB | 150 MB |
| RAM (WebSocket) | โ | 50 MB |
| CPU (idle) | 1.5% | 0.5% + 0.3% |
| ะกะบะพัะพััั ััะฐััะฐ | ~15s | ~10s + 3s |
| ะะพะฝัะปะธะบัั | โ ะััั | โ ะะตั |
| ะะฐัััะฐะฑะธััะตะผะพััั | โ๏ธ ะะผะตััะต | โ ะะฐะทะดะตะปัะฝะพ |

---

## ๐ฏ ะะตะบะพะผะตะฝะดะฐัะธะธ

### ะะตะผะตะดะปะตะฝะฝัะต ะดะตะนััะฒะธั (ะัะธัะธัะฝัะต):

1. โ ะกะพะทะดะฐัั `websocket-standalone.ts` ะฑะตะท Next.js
2. โ ะะฑะฝะพะฒะธัั ัะบัะธะฟัั ะฒ `package.json`
3. โ ะะพะฑะฐะฒะธัั `WEBSOCKET_PORT=3001` ะฒ `.env`
4. โ ะะฑะฝะพะฒะธัั ะบะปะธะตะฝั ะดะปั ะฟะพะดะบะปััะตะฝะธั ะบ ะฟะพััั 3001

### ะะพะฟะพะปะฝะธัะตะปัะฝัะต ัะปัััะตะฝะธั (ะะฟัะธะพะฝะฐะปัะฝัะต):

1. โ๏ธ ะะพะฑะฐะฒะธัั health check endpoints
2. โ๏ธ ะะฐัััะพะธัั Nginx reverse proxy (production)
3. โ๏ธ ะะพะฑะฐะฒะธัั ะผะตััะธะบะธ WebSocket connections
4. โ๏ธ ะะพะณะธัะพะฒะฐะฝะธะต ัะพะฑััะธะน Socket.IO

---

## ๐ ะกะฒัะทะฐะฝะฝัะต ะดะพะบัะผะตะฝัั

- **ะะปะฐะฝ ัะตะฐะปะธะทะฐัะธะธ:** `docs/plans/active/plan-websocket-standalone-refactor-2025-12-02.md` (ัะพะทะดะฐัั)
- **ะัััั:** (ะฟะพัะปะต ัะตะฐะปะธะทะฐัะธะธ)
- **Next.js Custom Server docs:** https://nextjs.org/docs/pages/building-your-application/configuring/custom-server

---

## โ ะัะฒะพะดั

1. **Custom Server ะฝะต ัะตะบะพะผะตะฝะดัะตััั Next.js ะบะพะผะฐะฝะดะพะน** โ ะฟะพัะตัั ะพะฟัะธะผะธะทะฐัะธะน
2. **Standalone ะฐััะธัะตะบัััะฐ โ ัะพะฒัะตะผะตะฝะฝัะน ััะฐะฝะดะฐัั** ะดะปั production ะฟัะธะปะพะถะตะฝะธะน
3. **ะะพะฝัะปะธะบั `.next/trace` โ ะบัะธัะธัะตัะบะฐั ะฟัะพะฑะปะตะผะฐ** ััะตะฑัะตั ะฝะตะผะตะดะปะตะฝะฝะพะณะพ ัะตัะตะฝะธั
4. **ะะธะบัะพัะตัะฒะธัะฝะฐั ะฐััะธัะตะบัััะฐ** ะพะฑะตัะฟะตัะธะฒะฐะตั ะณะธะฑะบะพััั ะธ ะผะฐัััะฐะฑะธััะตะผะพััั

**ะะตะบะพะผะตะฝะดะฐัะธั:** ะัะพะฒะตััะธ ัะตัะฐะบัะพัะธะฝะณ ะฝะฐ standalone ะฐััะธัะตะบัััั ะฒ ะฟัะธะพัะธัะตัะฝะพะผ ะฟะพััะดะบะต.



