# –ê–Ω–∞–ª–∏–∑: –ò—Ç–æ–≥–æ–≤–∞—è —Å–≤–æ–¥–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –º–æ–¥—É–ª–µ–π —Å Rules Engine

**–î–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è:** 2025-11-25  
**–°—Ç–∞—Ç—É—Å:** –ó–∞–≤–µ—Ä—à–µ–Ω  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í—ã—Å–æ–∫–∏–π

---

## ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏

### 1. **User** (–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)
- ‚úÖ **Workflow:** `UserMachine` (XState)
- ‚úÖ **Service:** `UserWorkflowService`
- ‚úÖ **–ü—Ä–∞–≤–∏–ª–∞ –∞–≤—Ç–æ–±–ª–æ–∫–∏—Ä–æ–≤–æ–∫:**
  - `auto-block-on-reports` ‚Äî –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∂–∞–ª–æ–±–∞—Ö
  - `auto-suspend-on-spam` ‚Äî –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏ —Å–ø–∞–º–µ
- ‚úÖ **–ü—Ä–∞–≤–∏–ª–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**
  - `welcome-email` ‚Äî –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ –ø–∏—Å—å–º–æ
  - `password-reset` ‚Äî —Å–±—Ä–æ—Å –ø–∞—Ä–æ–ª—è
  - `phone-verification-sms` ‚Äî SMS –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
  - `verification-completed` ‚Äî –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è –ø—Ä–æ–π–¥–µ–Ω–∞
  - `account-blocked` ‚Äî –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∞–∫–∫–∞—É–Ω—Ç–∞
  - `account-approved` ‚Äî –æ–¥–æ–±—Ä–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞
- ‚úÖ **EventRulesHandler:** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `user.block`, `user.suspend`
- ‚úÖ **Async Facts:** `userFact`, `userStatsFact`

### 2. **Listing** (–û–±—ä—è–≤–ª–µ–Ω–∏—è)
- ‚úÖ **Workflow:** `ListingMachine` (XState)
- ‚úÖ **Service:** `ListingWorkflowService`
- ‚úÖ **–ü—Ä–∞–≤–∏–ª–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**
  - `listing-approved` ‚Äî –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –æ–¥–æ–±—Ä–µ–Ω–æ
  - `listing-returned-for-revision` ‚Äî –≤–æ–∑–≤—Ä–∞—Ç –Ω–∞ –¥–æ—Ä–∞–±–æ—Ç–∫—É
  - `listing-blocked` ‚Äî –æ–±—ä—è–≤–ª–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ
- ‚úÖ **–ü—Ä–∞–≤–∏–ª–∞ –∞–≤—Ç–æ–±–ª–æ–∫–∏—Ä–æ–≤–æ–∫:**
  - `auto-archive-listings-on-owner-block` ‚Äî –∞—Ä—Ö–∏–≤–∞—Ü–∏—è –ø—Ä–∏ –±–ª–æ–∫–∏—Ä–æ–≤–∫–µ –≤–ª–∞–¥–µ–ª—å—Ü–∞
- ‚úÖ **EventRulesHandler:** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `listing.archive`
- ‚úÖ **Async Facts:** `listingFact`, `listingStatsFact`

### 3. **UserAccount** (–ê–∫–∫–∞—É–Ω—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
- ‚úÖ **Workflow:** `AccountMachine` (XState)
- ‚úÖ **Service:** `AccountWorkflowService`
- ‚úÖ **–ü—Ä–∞–≤–∏–ª–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:**
  - `account-approved` ‚Äî –∞–∫–∫–∞—É–Ω—Ç –æ–¥–æ–±—Ä–µ–Ω
  - `tariff-expired` ‚Äî –æ–∫–æ–Ω—á–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–∞
- ‚úÖ **EventRulesHandler:** –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç `account.suspend`, `account.archive`, `account.activate`
- ‚úÖ **Async Facts:** `accountFact` (–¥–æ–±–∞–≤–ª–µ–Ω–æ)

---

## üìã –°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ ‚Äî –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ Async Facts

### ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã (–∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –ø—Ä–∞–≤–∏–ª–∞—Ö –∫–∞–∫ —É—Å–ª–æ–≤–∏—è)
- ‚úÖ **Language** ‚Äî `languageFact` (–ø—Ä–æ–≤–µ—Ä–∫–∞ isActive)
- ‚úÖ **Currency** ‚Äî `currencyFact` (–ø—Ä–æ–≤–µ—Ä–∫–∞ isActive)
- ‚úÖ **Country** ‚Äî `countryFact` (–ø—Ä–æ–≤–µ—Ä–∫–∞ isActive)
- ‚úÖ **TariffPlan** ‚Äî `tariffPlanFact` (–ø—Ä–æ–≤–µ—Ä–∫–∞ isActive)
- ‚úÖ **EmailTemplate** ‚Äî `emailTemplateFact` (–ø—Ä–æ–≤–µ—Ä–∫–∞ isActive)
- ‚úÖ **RateLimitConfig** ‚Äî `rateLimitConfigFact` (–ø—Ä–æ–≤–µ—Ä–∫–∞ isActive)

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:** –≠—Ç–∏ —Ñ–∞–∫—Ç—ã –ø–æ–∑–≤–æ–ª—è—é—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞ —Å —É—Å–ª–æ–≤–∏—è–º–∏ —Ç–∏–ø–∞:
- "–û—Ç–ø—Ä–∞–≤–ª—è—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Ç–æ–ª—å–∫–æ –Ω–∞ –∞–∫—Ç–∏–≤–Ω—ã–µ —è–∑—ã–∫–∏"
- "–ù–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å –æ–±—ä—è–≤–ª–µ–Ω–∏—è —Å –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π –≤–∞–ª—é—Ç–æ–π"
- "–ü—Ä–æ–≤–µ—Ä—è—Ç—å –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ç–∞—Ä–∏—Ñ–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∞–∫–∫–∞—É–Ω—Ç–∞"

### ‚ùå –ù–µ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω—ã (–Ω–µ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ –ø—Ä–∞–≤–∏–ª–∞—Ö)
- `State` ‚Äî —Ä–µ–≥–∏–æ–Ω—ã (–Ω–µ –Ω—É–∂–Ω—ã –≤ –ø—Ä–∞–≤–∏–ª–∞—Ö)
- `City` ‚Äî –≥–æ—Ä–æ–¥–∞ (–Ω–µ –Ω—É–∂–Ω—ã –≤ –ø—Ä–∞–≤–∏–ª–∞—Ö)
- `District` ‚Äî —Ä–∞–π–æ–Ω—ã (–Ω–µ –Ω—É–∂–Ω—ã –≤ –ø—Ä–∞–≤–∏–ª–∞—Ö)
- `Translation` ‚Äî –ø–µ—Ä–µ–≤–æ–¥—ã (–Ω–µ –Ω—É–∂–Ω—ã –≤ –ø—Ä–∞–≤–∏–ª–∞—Ö)

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ (–Ω–µ –±–∏–∑–Ω–µ—Å-—Å—É—â–Ω–æ—Å—Ç–∏)
- `RateLimitConfig` ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è rate limit
- `ServiceConfiguration` ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –≤–Ω–µ—à–Ω–∏—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
- `BusinessRule` ‚Äî —ç—Ç–æ —Å–∞–º–∞ —Å–∏—Å—Ç–µ–º–∞ –ø—Ä–∞–≤–∏–ª
- `NotificationScenario` ‚Äî —Å—Ç–∞—Ä–∞—è —Å–∏—Å—Ç–µ–º–∞ (–æ—Ç–∫–ª—é—á–µ–Ω–∞)

### –ù–µ –±–∏–∑–Ω–µ—Å-—Å—É—â–Ω–æ—Å—Ç–∏
- `Notification` ‚Äî —Å—Ç–∞—Ç—É—Å `unread/read/archived` —ç—Ç–æ UI-—Å–æ—Å—Ç–æ—è–Ω–∏–µ, –Ω–µ workflow
- `UserBlock` ‚Äî –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ IP/–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–Ω–µ —Ç—Ä–µ–±—É—é—Ç workflow)
- `AccountTransfer` ‚Äî –ø–µ—Ä–µ–¥–∞—á–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å workflow)

---

## üîß –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

### EventRulesHandler –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç:

1. **Workflow transitions:**
   - ‚úÖ `user.block` ‚Üí `UserWorkflowService.transition('BLOCK')`
   - ‚úÖ `user.suspend` ‚Üí `UserWorkflowService.transition('SUSPEND')`
   - ‚úÖ `listing.archive` ‚Üí `ListingWorkflowService.transition('ARCHIVE')`
   - ‚úÖ `account.suspend` ‚Üí `AccountWorkflowService.transition('SUSPEND')`
   - ‚úÖ `account.archive` ‚Üí `AccountWorkflowService.transition('ARCHIVE')`
   - ‚úÖ `account.activate` ‚Üí `AccountWorkflowService.transition('ACTIVATE')`

2. **–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:**
   - ‚úÖ `notification.send` ‚Üí `NotificationService.sendMultiple()`
   - ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –∫–∞–Ω–∞–ª–æ–≤: `email`, `sms`, `telegram`, `browser`
   - ‚úÖ –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —á–µ—Ä–µ–∑ Bull Queue

### Async Facts (13 —Ñ–∞–∫—Ç–æ–≤):

1. ‚úÖ `user` ‚Äî –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (11 –ø–æ–ª–µ–π)
2. ‚úÖ `userStats` ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (6 –ø–æ–ª–µ–π)
3. ‚úÖ `listing` ‚Äî –¥–∞–Ω–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è (12 –ø–æ–ª–µ–π)
4. ‚úÖ `listingStats` ‚Äî —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏—è (2 –ø–æ–ª—è)
5. ‚úÖ `account` ‚Äî –¥–∞–Ω–Ω—ã–µ –∞–∫–∫–∞—É–Ω—Ç–∞ (9 –ø–æ–ª–µ–π)
6. ‚úÖ `language` ‚Äî –¥–∞–Ω–Ω—ã–µ —è–∑—ã–∫–∞ + isActive **–ù–û–í–û–ï**
7. ‚úÖ `currency` ‚Äî –¥–∞–Ω–Ω—ã–µ –≤–∞–ª—é—Ç—ã + isActive **–ù–û–í–û–ï**
8. ‚úÖ `country` ‚Äî –¥–∞–Ω–Ω—ã–µ —Å—Ç—Ä–∞–Ω—ã + isActive **–ù–û–í–û–ï**
9. ‚úÖ `tariffPlan` ‚Äî –¥–∞–Ω–Ω—ã–µ —Ç–∞—Ä–∏—Ñ–∞ + isActive **–ù–û–í–û–ï**
10. ‚úÖ `emailTemplate` ‚Äî –¥–∞–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω–∞ + isActive **–ù–û–í–û–ï**
11. ‚úÖ `rateLimit` ‚Äî —Å—Ç–∞—Ç—É—Å rate limit
12. ‚úÖ `rateLimitConfig` ‚Äî –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è rate limit
13. ‚úÖ `time` ‚Äî —Ç–µ–∫—É—â–µ–µ –≤—Ä–µ–º—è

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

- **–í—Å–µ–≥–æ —Å—É—â–Ω–æ—Å—Ç–µ–π —Å workflow:** 3
- **–ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ:** 3 ‚úÖ
- **–ü—Ä–æ—Ü–µ–Ω—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:** 100%

- **–í—Å–µ–≥–æ –ø—Ä–∞–≤–∏–ª —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π:** 14
- **–í—Å–µ–≥–æ –ø—Ä–∞–≤–∏–ª –∞–≤—Ç–æ–±–ª–æ–∫–∏—Ä–æ–≤–æ–∫:** 3
- **–í—Å–µ–≥–æ async —Ñ–∞–∫—Ç–æ–≤:** 13 (8 –¥–ª—è –±–∏–∑–Ω–µ—Å-—Å—É—â–Ω–æ—Å—Ç–µ–π, 5 –¥–ª—è —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤)
- **–í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤:** 20+

---

## ‚úÖ –ò—Ç–æ–≥

**–í—Å–µ –º–æ–¥—É–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞, –∫–æ—Ç–æ—Ä—ã–µ –∏–º–µ—é—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ workflow (XState), –ø–æ–¥–∫–ª—é—á–µ–Ω—ã –∫ –Ω–æ–≤–æ–º—É —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—É Rules Engine!**

–ú–æ–¥—É–ª–∏ —Å–æ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞–º–∏ –∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è–º–∏ (`isActive`/`enabled`) –Ω–µ —Ç—Ä–µ–±—É—é—Ç –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏, —Ç–∞–∫ –∫–∞–∫ —ç—Ç–æ –Ω–µ –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —Å –ø–µ—Ä–µ—Ö–æ–¥–∞–º–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–π, –∞ –ø—Ä–æ—Å—Ç—ã–µ —Ñ–ª–∞–≥–∏ –≤–∫–ª—é—á–µ–Ω–∏—è/–≤—ã–∫–ª—é—á–µ–Ω–∏—è.

**–ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!** üéâ

