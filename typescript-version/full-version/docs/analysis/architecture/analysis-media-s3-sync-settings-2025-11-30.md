# ะะฝะฐะปะธะท: ะะฐัััะพะนะบะธ ัะธะฝััะพะฝะธะทะฐัะธะธ ะผะตะดะธะฐ ั S3

**ะะฐัะฐ ะฟัะพะฒะตะดะตะฝะธั:** 2025-11-30  
**ะกัะฐััั:** ะะฐะฒะตััะตะฝ (ัะพะณะปะฐัะพะฒะฐะฝะพ 2025-11-30)  
**ะัะธะพัะธัะตั:** ะััะพะบะธะน

---

## ๐ฏ ะฆะตะปั ะฐะฝะฐะปะธะทะฐ

ะัะพะฐะฝะฐะปะธะทะธัะพะฒะฐัั ัะตะบััะตะต ัะพััะพัะฝะธะต ะฝะฐัััะพะตะบ ัะธะฝััะพะฝะธะทะฐัะธะธ ะผะตะดะธะฐ ั S3 ะธ ะพะฟัะตะดะตะปะธัั ััะตะฑะพะฒะฐะฝะธั ะบ ะฝะพะฒะพะน ัะธััะตะผะต ะฝะฐัััะพะตะบ ะดะปั ัะฟัะฐะฒะปะตะฝะธั:
1. ะะตััะพะผ ััะฐะฝะตะฝะธั ัะฐะนะปะพะฒ (Storage Location)
2. ะัะตะผะตะฝะตะผ ะธ ัะฟะพัะพะฑะพะผ ัะธะฝััะพะฝะธะทะฐัะธะธ (Sync Behavior)

---

## ๐ ะขะตะบััะตะต ัะพััะพัะฝะธะต

### ะงัะพ ะฐะฝะฐะปะธะทะธััะตััั:

- ะะฐัััะพะนะบะธ ะผะตะดะธะฐ ะฒ `MediaGlobalSettings` (ะะ)
- UI ะฝะฐัััะพะตะบ ะฒ `MediaSettings.tsx`
- ะะพะณะธะบะฐ ัะธะฝััะพะฝะธะทะฐัะธะธ ะฒ `MediaSyncService.ts`
- ะะฑัะฐะฑะพัะบะฐ ะทะฐะณััะทะพะบ ะฒ `MediaProcessingWorker.ts`

### ะขะตะบััะธะต ะฝะฐัััะพะนะบะธ (ะฝะต ัะฐะฑะพัะฐัั):

| ะะพะปะต ะะ | UI | ะัะฟะพะปัะทัะตััั? |
|---------|-----|:-------------:|
| `autoSyncEnabled` | "Auto-sync to S3" | โ ะะตั |
| `autoSyncDelayMinutes` | "Sync delay (min)" | โ ะะตั |
| `autoCleanupLocalEnabled` | "Auto-cleanup local" | โ ะะตั |
| `keepLocalDays` | "Keep local (days)" | โ ะะตั |

### ะขะตะบััะฐั ะปะพะณะธะบะฐ (ัะฐััะธัะฝะพ ัะฐะฑะพัะฐะตั):

ะ `MediaProcessingWorker.ts` ะตััั ะบะพะด ะดะปั ะฐะฒัะพ-ัะธะฝััะพะฝะธะทะฐัะธะธ:

```typescript
// ะกััะพะบะธ 97-126
if (storageStrategy === 'local_first' && media.localPath) {
  if (s3Available) {
    await mediaSyncQueue.add({
      operation: 'upload_to_s3',
      mediaId: media.id,
      deleteSource: false,
    })
  }
}
```

**ะัะพะฑะปะตะผั:**
1. ะะฐะฑะพัะฐะตั ัะพะปัะบะพ ะดะปั `storageStrategy === 'local_first'`
2. ะะต ััะธััะฒะฐะตั `autoSyncEnabled`
3. ะะต ััะธััะฒะฐะตั `autoSyncDelayMinutes`
4. `deleteSource` ะฒัะตะณะดะฐ `false` โ ะฝะตั ะฐะฒัะพ-ะพัะธััะบะธ

### ะขะตะบััะธะต ัััะฐัะตะณะธะธ ััะฐะฝะตะฝะธั:

| ะกััะฐัะตะณะธั | ะะฟะธัะฐะฝะธะต | ะะดะต ะทะฐะดะฐัััั |
|-----------|----------|--------------|
| `local_only` | ะขะพะปัะบะพ ะปะพะบะฐะปัะฝะพ | ะะพ entityType ะฒ `ImageSettings` |
| `local_first` | ะกะฝะฐัะฐะปะฐ ะปะพะบะฐะปัะฝะพ โ ะฟะพัะพะผ S3 | ะะพ entityType ะฒ `ImageSettings` |
| `s3_only` | ะขะพะปัะบะพ S3 | ะะพ entityType ะฒ `ImageSettings` |
| `both` | ะ ะพะฑะฐ ะผะตััะฐ ััะฐะทั | ะะพ entityType ะฒ `ImageSettings` |

---

## ๐ ะะตะทัะปััะฐัั ะฐะฝะฐะปะธะทะฐ

### ะะฐะนะดะตะฝะฝัะต ะฟัะพะฑะปะตะผั:

1. **ะัะพะฑะปะตะผะฐ 1: ะะฐัััะพะนะบะธ UI ะฝะต ัะฒัะทะฐะฝั ั ะปะพะณะธะบะพะน**
   - ะะฟะธัะฐะฝะธะต: ะะตัะตะบะปััะฐัะตะปะธ ะฒ UI ัะพััะฐะฝััััั ะฒ ะะ, ะฝะพ ะฝะต ะฒะปะธััั ะฝะฐ ะฟะพะฒะตะดะตะฝะธะต
   - ะะปะธัะฝะธะต: ะััะพะบะพะต โ ะฟะพะปัะทะพะฒะฐัะตะปั ะดัะผะฐะตั ััะพ ะฝะฐัััะพะนะบะธ ัะฐะฑะพัะฐัั
   - ะัะธะพัะธัะตั: ะัะธัะธัะตัะบะธะน

2. **ะัะพะฑะปะตะผะฐ 2: ะะตั ะณะปะพะฑะฐะปัะฝะพะณะพ ะบะพะฝััะพะปั ัะธะฝััะพะฝะธะทะฐัะธะธ**
   - ะะฟะธัะฐะฝะธะต: ะะตั ะตะดะธะฝะพะน ัะพัะบะธ ัะฟัะฐะฒะปะตะฝะธั โ ะบะพะณะดะฐ ะธ ะบะฐะบ ัะธะฝััะพะฝะธะทะธัะพะฒะฐัั
   - ะะปะธัะฝะธะต: ะกัะตะดะฝะตะต โ ัะปะพะถะฝะพ ัะฟัะฐะฒะปััั ะฟะพะฒะตะดะตะฝะธะตะผ ัะธััะตะผั
   - ะัะธะพัะธัะตั: ะััะพะบะธะน

3. **ะัะพะฑะปะตะผะฐ 3: ะัะฑะปะธัะพะฒะฐะฝะธะต ะบะพะฝัะตะฟัะธะน**
   - ะะฟะธัะฐะฝะธะต: `storageStrategy` per-entityType + ะณะปะพะฑะฐะปัะฝัะต ะฝะฐัััะพะนะบะธ = ะฟััะฐะฝะธัะฐ
   - ะะปะธัะฝะธะต: ะกัะตะดะฝะตะต โ ัะปะพะถะฝะพััั ะบะพะฝัะธะณััะฐัะธะธ
   - ะัะธะพัะธัะตั: ะกัะตะดะฝะธะน

4. **ะัะพะฑะปะตะผะฐ 4: ะะตั ะทะฐะดะตัะถะบะธ ัะธะฝััะพะฝะธะทะฐัะธะธ**
   - ะะฟะธัะฐะฝะธะต: ะคะฐะนะปั ััะฐะทั ััะฐะฒัััั ะฒ ะพัะตัะตะดั, ะฝะตั ะฒะพะทะผะพะถะฝะพััะธ "ะพัััะพััั"
   - ะะปะธัะฝะธะต: ะะธะทะบะพะต โ ะฒัะตะผะตะฝะฝัะต ัะฐะนะปั ัะธะฝััะพะฝะธะทะธัััััั
   - ะัะธะพัะธัะตั: ะกัะตะดะฝะธะน

### ะะฐะนะดะตะฝะฝัะต ะฒะพะทะผะพะถะฝะพััะธ:

1. **ะะพะทะผะพะถะฝะพััั 1: ะฃะฟัะพัะตะฝะธะต UI**
   - ะะฟะธัะฐะฝะธะต: ะะผะตััะพ ะผะฝะพะถะตััะฒะฐ ะฟะตัะตะบะปััะฐัะตะปะตะน โ ะพะดะธะฝ Select ะดะปั Storage Location ะธ ะพะดะธะฝ ะดะปั Sync Mode
   - ะะพัะตะฝัะธะฐะปัะฝะฐั ะฒัะณะพะดะฐ: ะัะพัะต ะฟะพะฝััั, ะผะตะฝััะต ะพัะธะฑะพะบ ะบะพะฝัะธะณััะฐัะธะธ

2. **ะะพะทะผะพะถะฝะพััั 2: ะัะฟะพะปัะทะพะฒะฐะฝะธะต Sync Delay ะดะปั delayed ัะตะถะธะผะฐ**
   - ะะฟะธัะฐะฝะธะต: ะัะปะธ Sync Delay = 0 โ ััะฐะทั ะฒ ะพัะตัะตะดั, ะตัะปะธ > 0 โ delayed
   - ะะพัะตะฝัะธะฐะปัะฝะฐั ะฒัะณะพะดะฐ: ะะตะฝััะต ะฝะฐัััะพะตะบ, ะปะพะณะธัะฝะตะต

---

## ๐ก ะะตะบะพะผะตะฝะดะฐัะธะธ

### ะะตะบะพะผะตะฝะดะฐัะธั 1: ะะพะฒะฐั ััััะบัััะฐ ะฝะฐัััะพะตะบ

**ะจะฐะณ 1: Storage Location (ะณะดะต ััะฐะฝะธัั)**

| ะะฝะฐัะตะฝะธะต | ะะฟะธัะฐะฝะธะต |
|----------|----------|
| `local` | ะขะพะปัะบะพ ะปะพะบะฐะปัะฝะพ, S3 ะฝะต ะธัะฟะพะปัะทัะตััั |
| `s3` | ะขะพะปัะบะพ S3, ะฑะตะท ะปะพะบะฐะปัะฝัั ะบะพะฟะธะน |
| `both` | Local + S3 (ะผะฐะบัะธะผะฐะปัะฝะฐั ะฝะฐะดัะถะฝะพััั) |

**ะจะฐะณ 2: Sync Mode (ะบะพะณะดะฐ ัะธะฝััะพะฝะธะทะธัะพะฒะฐัั)**

| ะะฝะฐัะตะฝะธะต | ะะฟะธัะฐะฝะธะต |
|----------|----------|
| `auto` | ะะฒัะพะผะฐัะธัะตัะบะธ (ั ััััะพะผ Sync Delay) |
| `immediate` | ะกะธะฝััะพะฝะฝะพ ะฒ ัะพะผ ะถะต ะทะฐะฟัะพัะต |
| `manual` | ะขะพะปัะบะพ ะฒัััะฝัั ัะตัะตะท UI |

**ะะพะฟะพะปะฝะธัะตะปัะฝัะต ะฝะฐัััะพะนะบะธ:**
- `syncDelayMinutes` โ ะทะฐะดะตัะถะบะฐ ะฟะตัะตะด ัะธะฝััะพะฝะธะทะฐัะธะตะน (0 = ััะฐะทั)
- `autoCleanupLocal` โ ัะดะฐะปััั ะปะพะบะฐะปัะฝัะต ะฟะพัะปะต ััะฟะตัะฝะพะน ัะธะฝััะพะฝะธะทะฐัะธะธ
- `keepLocalDays` โ ัะตัะตะท ัะบะพะปัะบะพ ะดะฝะตะน ัะดะฐะปััั ะปะพะบะฐะปัะฝัะต

**ะัะตะฝะบะฐ ัะปะพะถะฝะพััะธ:** ะกัะตะดะฝัั  
**ะัะตะฝะบะฐ ะฒัะตะผะตะฝะธ:** 4-6 ัะฐัะพะฒ

### ะะตะบะพะผะตะฝะดะฐัะธั 2: ะะฑะฝะพะฒะธัั MediaProcessingWorker

ะะทะผะตะฝะธัั ะปะพะณะธะบั ั `storageStrategy === 'local_first'` ะฝะฐ ะฟัะพะฒะตัะบั ะณะปะพะฑะฐะปัะฝัั ะฝะฐัััะพะตะบ:

```typescript
const settings = await getGlobalSettings()

// Storage Location ะพะฟัะตะดะตะปัะตั ะฝัะถะฝะฐ ะปะธ ัะธะฝััะพะฝะธะทะฐัะธั
if (settings.storageLocation !== 'local' && media.localPath) {
  // Sync Mode ะพะฟัะตะดะตะปัะตั ะบะฐะบ ัะธะฝััะพะฝะธะทะธัะพะฒะฐัั
  if (settings.syncMode === 'auto') {
    const delay = settings.syncDelayMinutes * 60 * 1000
    await mediaSyncQueue.add({
      operation: 'upload_to_s3',
      mediaId: media.id,
      deleteSource: settings.autoCleanupLocal,
    }, { delay })
  }
  // immediate ะพะฑัะฐะฑะฐััะฒะฐะตััั ะฒ StorageService ะฟัะธ ะทะฐะณััะทะบะต
  // manual โ ะฝะธัะตะณะพ ะฝะต ะดะตะปะฐะตะผ
}
```

**ะัะตะฝะบะฐ ัะปะพะถะฝะพััะธ:** ะะธะทะบะฐั  
**ะัะตะฝะบะฐ ะฒัะตะผะตะฝะธ:** 1-2 ัะฐัะฐ

### ะะตะบะพะผะตะฝะดะฐัะธั 3: ะะฑะฝะพะฒะธัั UI ะฝะฐัััะพะตะบ

ะะฐะผะตะฝะธัั ัะตะบัััั ัะตะบัะธั "Auto-sync" ะฝะฐ ะดะฒะต ะปะพะณะธัะตัะบะธะต ะณััะฟะฟั:

```
โโ ๐ฆ Storage Location โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ [โผ] Local + S3 (recommended)                              โ
โ     โ Local Only โ Server disk only                       โ
โ     โ S3 Only โ Cloud storage only                        โ
โ     โ Local + S3 โ Both (recommended)                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโ ๐ Sync Behavior โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ Sync Mode: [โผ] Auto (recommended)                         โ
โ                                                           โ
โ Sync Delay: [0] minutes  (0 = immediate queue)            โ
โ                                                           โ
โ โ Delete local files after successful S3 sync            โ
โ   Keep for [7] days before deletion                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

**ะัะตะฝะบะฐ ัะปะพะถะฝะพััะธ:** ะกัะตะดะฝัั  
**ะัะตะฝะบะฐ ะฒัะตะผะตะฝะธ:** 2-3 ัะฐัะฐ

---

## ๐ ะัะฒะพะดั

1. **ะขะตะบััะธะต ะฝะฐัััะพะนะบะธ Auto-sync ะฝะต ัะฐะฑะพัะฐัั** โ ััะพ "ะทะฐะณะปััะบะธ" ะฒ UI
2. **ะัะถะฝะฐ ะฝะพะฒะฐั ััััะบัััะฐ ะฝะฐัััะพะตะบ** โ Storage Location + Sync Mode
3. **ะัะถะฝะพ ัะฒัะทะฐัั UI ั ะปะพะณะธะบะพะน** โ MediaProcessingWorker ะดะพะปะถะตะฝ ัะธัะฐัั ะฝะฐัััะพะนะบะธ
4. **Sync Delay** ะผะพะถะฝะพ ะธัะฟะพะปัะทะพะฒะฐัั ะดะปั delayed ัะตะถะธะผะฐ (0 = ััะฐะทั)

---

## ๐ ะกะฒัะทะฐะฝะฝัะต ะดะพะบัะผะตะฝัั

- [ะะปะฐะฝ ัะตะฐะปะธะทะฐัะธะธ](../../plans/active/plan-media-s3-sync-settings-2025-11-30.md)
- [ะะพะดัะปั Media](../../ROOT_FILES_DESCRIPTION.md#-ะผะพะดัะปั-media-ะพะฑะฝะพะฒะปะตะฝะพ-2025-11-26)

---

## โ ะกะพะณะปะฐัะพะฒะฐะฝะฝัะต ัะตัะตะฝะธั (2025-11-30)

### S3 Enable/Disable + Server Selection
| ะะฐัััะพะนะบะฐ | ะะฟะธัะฐะฝะธะต |
|-----------|----------|
| `s3Enabled: false` | S3 ะพัะบะปััะตะฝ, ัะพะปัะบะพ ะปะพะบะฐะปัะฝะพะต ััะฐะฝะธะปะธัะต |
| `s3Enabled: true` | S3 ะฒะบะปััะตะฝ, ะดะพัััะฟะฝั ะฒัะต ะพะฟัะธะธ Storage Location |
| `s3ServiceId: null` | ะัะฟะพะปัะทะพะฒะฐัั S3 ะฝะฐัััะพะนะบะธ ะธะท `.env` |
| `s3ServiceId: 'cm...'` | ะัะฟะพะปัะทะพะฒะฐัั ะบะพะฝัะธะณ ะธะท ServiceConfiguration (External Services) |

**ะะฝัะตะณัะฐัะธั ั External Services:**
- Dropdown ัะพ ัะฟะธัะบะพะผ S3 ัะตัะฒะธัะพะฒ ะธะท `/admin/settings/services`
- ะะพะบะฐะท ััะฐัััะฐ ะฟะพะดะบะปััะตะฝะธั (connected/error/disabled)
- ะะตัะฒัะน ะฒะฐัะธะฐะฝั โ "Default (from .env)"

### Storage Location (3 ัะตะถะธะผะฐ, ะดะพัััะฟะฝั ะตัะปะธ s3Enabled=true)
| ะะฝะฐัะตะฝะธะต | ะะพะบะฐะปัะฝัะต ัะฐะนะปั | S3 | ะะพัะปะต sync |
|----------|-----------------|-----|------------|
| `local` | โ ะฅัะฐะฝะธัั | โ ะะตั | โ |
| `s3` | ๐๏ธ ะฃะดะฐะปะธัั | โ ะฅัะฐะฝะธัั | ะฃะดะฐะปัะตะผ ะปะพะบะฐะปัะฝัะต |
| `both` | โ ะฅัะฐะฝะธัั | โ ะฅัะฐะฝะธัั | ะััะฐะฒะปัะตะผ ะพะฑะฐ |

### Sync Mode (4 ัะตะถะธะผะฐ)
| ะะตะถะธะผ | ะะฟะธัะฐะฝะธะต |
|-------|----------|
| `immediate` | ะกะธะฝััะพะฝะฝะพ ะฒ ัะพะผ ะถะต HTTP ะทะฐะฟัะพัะต |
| `background` | ะกัะฐะทั ะฒ ะพัะตัะตะดั Bull (ะฐัะธะฝััะพะฝะฝะพ) |
| `delayed` | ะ ะพัะตัะตะดั ั ะทะฐะดะตัะถะบะพะน N ะผะธะฝัั |
| `manual` | ะขะพะปัะบะพ ะฒัััะฝัั ัะตัะตะท UI |

### Trash (ัะฟัะพััะฝะฝะพ)
| ะะฐัััะพะนะบะฐ | ะะฝะฐัะตะฝะธะต |
|-----------|----------|
| `deleteMode` | `'soft'` ะฟะพ ัะผะพะปัะฐะฝะธั |
| `trashRetentionDays` | `30` (0 = ะฝะธะบะพะณะดะฐ ะฝะต ัะดะฐะปััั) |
| `s3DeleteWithLocal` | `true` |

+ Scheduler ะดะปั ะฐะฒัะพ-ะพัะธััะบะธ ะตะถะตะดะฝะตะฒะฝะพ ะฒ 03:00

### Orphan files
- โ ะขะพะปัะบะพ ััะฐัะธััะธะบะฐ (ะบะพะปะธัะตััะฒะพ, ัะฐะทะผะตั)
- โ ะะฝะพะฟะบะธ "View orphans" ะธ "Export CSV"
- โ ะะตะท ะฐะฒัะพัะดะฐะปะตะฝะธั

### ะฃะดะฐะปัะฝะฝัะต ะฝะฐัััะพะนะบะธ
ะกะปะตะดัััะธะต ะฝะฐัััะพะนะบะธ ะฑะพะปััะต ะฝะต ะฝัะถะฝั:
- `autoSyncEnabled` โ ะทะฐะผะตะฝะตะฝะพ ะฝะฐ `syncMode`
- `autoSyncDelayMinutes` โ ะฟะตัะตะธะผะตะฝะพะฒะฐะฝะพ ะฒ `syncDelayMinutes`
- `autoCleanupLocalEnabled` โ ะพะฟัะตะดะตะปัะตััั `storageLocation`
- `keepLocalDays` โ ะพะฟัะตะดะตะปัะตััั `storageLocation`
- `softDeleteRetentionDays` โ ะทะฐะผะตะฝะตะฝะพ ะฝะฐ `trashRetentionDays`
- `autoCleanupEnabled` โ ะทะฐะผะตะฝะตะฝะพ ะฝะฐ `trashRetentionDays > 0`
- `autoDeleteOrphans` โ ัะดะฐะปะตะฝะพ (ะฑะตะท ะฐะฒัะพัะดะฐะปะตะฝะธั)
- `orphanRetentionDays` โ ัะดะฐะปะตะฝะพ

---

## ๐ ะะฐััะธัะฐ ะบะพะผะฑะธะฝะฐัะธะน (ะพะฑะฝะพะฒะปัะฝะฝะฐั)

| Storage | Sync Mode | Delay | ะะพะบะฐะปัะฝัะน ัะฐะนะป | S3 |
|---------|-----------|-------|----------------|-----|
| `local` | โ | โ | โ ะฅัะฐะฝะธัั | โ ะะตั |
| `s3` | `immediate` | โ | ๐๏ธ ะฃะดะฐะปะธัั ััะฐะทั | โ ะกัะฐะทั |
| `s3` | `background` | โ | ๐๏ธ ะฃะดะฐะปะธัั ะฟะพัะปะต sync | โ ะัะตัะตะดั |
| `s3` | `delayed` | 30 | ๐๏ธ ะฃะดะฐะปะธัั ะฟะพัะปะต sync | โ ะงะตัะตะท 30 ะผะธะฝ |
| `s3` | `manual` | โ | โ ะฅัะฐะฝะธัั | โณ ะะดัั |
| `both` | `immediate` | โ | โ ะฅัะฐะฝะธัั | โ ะกัะฐะทั |
| `both` | `background` | โ | โ ะฅัะฐะฝะธัั | โ ะัะตัะตะดั |
| `both` | `delayed` | 30 | โ ะฅัะฐะฝะธัั | โ ะงะตัะตะท 30 ะผะธะฝ |
| `both` | `manual` | โ | โ ะฅัะฐะฝะธัั | โณ ะะดัั |

