# –ê–Ω–∞–ª–∏–∑: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Bull Queue —Å –º–æ–¥—É–ª–µ–º Media

**–î–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è:** 2025-11-26  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à—ë–Ω  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –°—Ä–µ–¥–Ω–∏–π

---

## üéØ –¶–µ–ª—å –∞–Ω–∞–ª–∏–∑–∞

–ò—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Bull Queue —Å –º–æ–¥—É–ª–µ–º Media –¥–ª—è:
- –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ
- –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ –º–Ω–æ–∂–µ—Å—Ç–≤–∞ —Ñ–∞–π–ª–æ–≤
- –ü–æ–≤—ã—à–µ–Ω–∏—è –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏ (retry –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö)

---

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### –ú–æ–¥—É–ª—å Media (—Ç–µ–∫—É—â–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞)

```
User ‚Üí API Route ‚Üí Sharp (sync) ‚Üí Storage ‚Üí Response
         ‚Üì
      ‚è±Ô∏è 2-5 —Å–µ–∫ –Ω–∞ —Ñ–∞–π–ª
      üíÄ –ë–ª–æ–∫–∏—Ä—É–µ—Ç worker
```

**–ü—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏ –≤—ã—Å–æ–∫–æ–π –Ω–∞–≥—Ä—É–∑–∫–µ:**

| –ú–µ—Ç—Ä–∏–∫–∞ | 10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π | 100 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π | 1000 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π |
|---------|------------------|-------------------|-------------------|
| –ó–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω | ~50 | ~500 | ~5000 |
| CPU –∑–∞–≥—Ä—É–∑–∫–∞ | 30% | 80% | 100%+ timeout |
| –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ | 2-3 —Å–µ–∫ | 5-10 —Å–µ–∫ | timeout |

### Bull Queue (—Å—É—â–µ—Å—Ç–≤—É—é—â–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞)

**–§–∞–π–ª:** `src/services/notifications/NotificationQueue.ts`

–£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:
- ‚úÖ Singleton –ø–∞—Ç—Ç–µ—Ä–Ω
- ‚úÖ Redis —á–µ—Ä–µ–∑ `serviceConfigResolver`
- ‚úÖ In-memory fallback
- ‚úÖ Retry —Å exponential backoff
- ‚úÖ Prometheus –º–µ—Ç—Ä–∏–∫–∏
- ‚úÖ Sentry –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- ‚úÖ Graceful shutdown

---

## üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ —Å Bull Queue

```
User ‚Üí API Route ‚Üí Save temp file ‚Üí Bull Queue ‚Üí Response (fast!)
                                        ‚Üì
                                   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
                                   ‚îÇ Worker  ‚îÇ ‚Üí Sharp ‚Üí Storage ‚Üí DB update
                                   ‚îÇ Worker  ‚îÇ ‚Üí Sharp ‚Üí Storage ‚Üí DB update
                                   ‚îÇ Worker  ‚îÇ ‚Üí Sharp ‚Üí Storage ‚Üí DB update
                                   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                        ‚Üì
                                   WebSocket ‚Üí User "–≥–æ—Ç–æ–≤–æ!"
```

### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

| –ê—Å–ø–µ–∫—Ç | –ë–µ–∑ Queue | –° Queue |
|--------|-----------|---------|
| –í—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ API | 2-5 —Å–µ–∫ | 50-100 –º—Å |
| –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ—Å—Ç—å | 1 —Ñ–∞–π–ª | N workers |
| Retry –ø—Ä–∏ –æ—à–∏–±–∫–µ | ‚ùå | ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ |
| –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ | –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ | –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ |
| –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ | –õ–æ–≥–∏ | Prometheus + Grafana |

### –ß—Ç–æ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –û–ø–∏—Å–∞–Ω–∏–µ | –û—Ü–µ–Ω–∫–∞ |
|-----------|----------|--------|
| `MediaProcessingQueue.ts` | –û—á–µ—Ä–µ–¥—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–ø–æ –æ–±—Ä–∞–∑—Ü—É NotificationQueue) | 2 —á–∞—Å–∞ |
| `MediaProcessingWorker.ts` | Worker –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ | 1 —á–∞—Å |
| API –∏–∑–º–µ–Ω–µ–Ω–∏—è | –ë—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç + —Å—Ç–∞—Ç—É—Å | 1 —á–∞—Å |
| WebSocket/SSE | –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ | 1 —á–∞—Å |
| –ú–µ—Ç—Ä–∏–∫–∏ | Prometheus –¥–ª—è media queue | 30 –º–∏–Ω |
| –¢–µ—Å—Ç—ã | Unit + Integration | 1.5 —á–∞—Å–∞ |

**–û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞:** ~7 —á–∞—Å–æ–≤

---

## üìã –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

–î–ª—è –ø—Ä–æ–µ–∫—Ç–æ–≤ —Å –æ–∂–∏–¥–∞–µ–º–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π 100+ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–≥—Ä—É–∑–æ–∫.

```typescript
// API: –±—ã—Å—Ç—Ä—ã–π –æ—Ç–≤–µ—Ç
POST /api/media ‚Üí { jobId, status: 'processing' }

// WebSocket: —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏
ws.on('media:processed', { jobId, mediaId, urls })
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ì–∏–±—Ä–∏–¥–Ω—ã–π –ø–æ–¥—Ö–æ–¥

–î–ª—è –ø—Ä–æ–µ–∫—Ç–æ–≤ —Å –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π.

```typescript
// –ú–∞–ª–æ —Ñ–∞–π–ª–æ–≤ ‚Üí —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ (–∫–∞–∫ —Å–µ–π—á–∞—Å)
// –ú–Ω–æ–≥–æ —Ñ–∞–π–ª–æ–≤ ‚Üí —á–µ—Ä–µ–∑ Queue

if (concurrentUploads < 10) {
  await processSync(file)
} else {
  await mediaQueue.add(file)
}
```

### –í–∞—Ä–∏–∞–Ω—Ç 3: –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è

–ï—Å–ª–∏ –Ω–∞–≥—Ä—É–∑–∫–∞ –ø–æ–∫–∞ –Ω–µ–±–æ–ª—å—à–∞—è ‚Äî –æ—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é, –¥–æ–±–∞–≤–∏—Ç—å Queue –∫–æ–≥–¥–∞ –ø–æ–Ω–∞–¥–æ–±–∏—Ç—Å—è.

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----------|
| `src/services/notifications/NotificationQueue.ts` | –û–±—Ä–∞–∑–µ—Ü —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ Queue |
| `src/lib/config/serviceConfigResolver.ts` | –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Redis |
| `src/lib/metrics/notifications.ts` | –û–±—Ä–∞–∑–µ—Ü –º–µ—Ç—Ä–∏–∫ |
| `src/services/media/MediaService.ts` | –¢–µ–∫—É—â–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ |

---

## ‚úÖ –í—ã–≤–æ–¥

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –°–æ–∑–¥–∞—Ç—å `MediaProcessingQueue` –ø–æ –æ–±—Ä–∞–∑—Ü—É `NotificationQueue` —Å:
- –¢–µ–º –∂–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–º (Singleton, fallback, retry)
- –¢–µ–º–∏ –∂–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º–∏ (Redis, Prometheus, Sentry)
- –ì–∏–±—Ä–∏–¥–Ω—ã–º –ø–æ–¥—Ö–æ–¥–æ–º (sync –¥–ª—è –º–∞–ª—ã—Ö –æ–±—ä—ë–º–æ–≤, async –¥–ª—è –±–æ–ª—å—à–∏—Ö)

**–°–ª–µ–¥—É—é—â–∏–π —à–∞–≥:** –°–æ–∑–¥–∞—Ç—å –ø–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏.

