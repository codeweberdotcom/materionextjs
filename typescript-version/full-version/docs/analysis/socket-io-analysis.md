# üìä –ê–Ω–∞–ª–∏–∑ Socket.IO –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

**–î–∞—Ç–∞ –∞–Ω–∞–ª–∏–∑–∞:** 2025-01-24  
**–í–µ—Ä—Å–∏—è:** 5.0.0  
**–°—Ç–∞—Ç—É—Å:** –ê–∫—Ç—É–∞–ª—å–Ω—ã–π

## üéØ –¶–µ–ª—å –∞–Ω–∞–ª–∏–∑–∞

–ü—Ä–æ–≤–µ—Å—Ç–∏ –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã Socket.IO –≤ –ø—Ä–æ–µ–∫—Ç–µ, –≤—ã—è–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—ã —Å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é Socket.IO —Å–µ—Ä–≤–µ—Ä–∞ –≤ API routes –∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Ä–µ—à–µ–Ω–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π.

---

## üìã –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. [–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Socket.IO](#–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞-socketio)
2. [–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞](#–∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è-—Å–µ—Ä–≤–µ—Ä–∞)
3. [–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Next.js](#–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è-—Å-nextjs)
4. [–ü—Ä–æ–±–ª–µ–º—ã –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è](#–ø—Ä–æ–±–ª–µ–º—ã-–∏-–æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è)
5. [–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏](#—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏)

---

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Socket.IO

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª–µ–π

```
src/lib/sockets/
‚îú‚îÄ‚îÄ index.ts                    # –ì–ª–∞–≤–Ω—ã–π –º–æ–¥—É–ª—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
‚îú‚îÄ‚îÄ middleware/
‚îÇ   ‚îú‚îÄ‚îÄ auth.ts                 # –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ Lucia
‚îÇ   ‚îú‚îÄ‚îÄ errorHandler.ts         # –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∏ heartbeat
‚îÇ   ‚îî‚îÄ‚îÄ rateLimit.ts            # Rate limiting
‚îú‚îÄ‚îÄ namespaces/
‚îÇ   ‚îú‚îÄ‚îÄ chat/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts            # Namespace –¥–ª—è —á–∞—Ç–∞
‚îÇ   ‚îî‚îÄ‚îÄ notifications/
‚îÇ       ‚îî‚îÄ‚îÄ index.ts            # Namespace –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îú‚îÄ‚îÄ common.ts               # –û–±—â–∏–µ —Ç–∏–ø—ã
‚îÇ   ‚îú‚îÄ‚îÄ chat.ts                 # –¢–∏–ø—ã –¥–ª—è —á–∞—Ç–∞
‚îÇ   ‚îî‚îÄ‚îÄ notifications.ts        # –¢–∏–ø—ã –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
‚îî‚îÄ‚îÄ utils/
    ‚îú‚îÄ‚îÄ jwt.ts                  # JWT —É—Ç–∏–ª–∏—Ç—ã
    ‚îî‚îÄ‚îÄ permissions.ts          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
```

### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

#### 1. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞** (`src/lib/sockets/index.ts`)

```typescript
// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è io instance
let io: TypedIOServer | null = null

export const initializeSocketServer = (httpServer: HTTPServer): TypedIOServer => {
  if (io) {
    logger.warn('Socket.IO server already initialized')
    return io
  }

  io = new Server<ClientToServerEvents, ServerToClientEvents>(httpServer, {
    cors: { /* ... */ },
    pingTimeout: 60000,
    pingInterval: 25000,
    // ...
  })

  globalThis.io = io  // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è middleware, namespaces, –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
  return io!
}
```

**–û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**
- Socket.IO –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞
- –≠–∫–∑–µ–º–ø–ª—è—Ä —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –º–æ–¥—É–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π `io` –∏ –≤ `globalThis.io`
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ TypeScript generics

#### 2. **Namespaces**

- **`/chat`** - –¥–ª—è —á–∞—Ç–∞ (502 —Å—Ç—Ä–æ–∫–∏ –∫–æ–¥–∞)
- **`/notifications`** - –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- –ö–∞–∂–¥—ã–π namespace –∏–º–µ–µ—Ç —Å–≤–æ—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –∏ middleware

#### 3. **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** (`src/lib/sockets/middleware/auth.ts`)

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç **Lucia Auth** –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Å–µ—Å—Å–∏–π
- –¢–æ–∫–µ–Ω –ø–µ—Ä–µ–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ `handshake.auth.token` –∏–ª–∏ `Authorization` header
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–æ–ª–µ–π: `admin`, `moderator`, `user`, `guest`
- –°–∏—Å—Ç–µ–º–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π (permissions)

#### 4. **–ú–µ—Ç—Ä–∏–∫–∏** (`src/lib/sockets/index.ts`)

```typescript
const metrics = {
  activeConnections: 0,
  messagesPerSecond: 0,
  averageResponseTime: 0,
  failedConnections: 0,
  totalConnections: 0,
  totalMessages: 0,
  startTime: Date.now()
}
```

- –ú–µ—Ç—Ä–∏–∫–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏
- –û–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏/–æ—Ç–∫–ª—é—á–µ–Ω–∏–∏
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Prometheus —á–µ—Ä–µ–∑ `websocketConnections` Gauge

---

## üöÄ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–µ—Ä–∞

### –°–ø–æ—Å–æ–±—ã –∑–∞–ø—É—Å–∫–∞

#### 1. **–° Socket.IO** (`dev:with-socket`)

```bash
pnpm run dev:with-socket
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç: tsx src/server/websocket-server-new.ts
```

**–ü—Ä–æ—Ü–µ—Å—Å:**
1. –°–æ–∑–¥–∞–µ—Ç—Å—è –∫–∞—Å—Ç–æ–º–Ω—ã–π HTTP —Å–µ—Ä–≤–µ—Ä (`createServer`)
2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è Next.js –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (`next({ dev })`)
3. Socket.IO —Å–µ—Ä–≤–µ—Ä –ø—Ä–∏–≤—è–∑—ã–≤–∞–µ—Ç—Å—è –∫ HTTP —Å–µ—Ä–≤–µ—Ä—É
4. –°–µ—Ä–≤–µ—Ä —Å–ª—É—à–∞–µ—Ç –Ω–∞ –ø–æ—Ä—Ç—É 3000

**–§–∞–π–ª:** `src/server/websocket-server-new.ts`

```typescript
const server = createServer((req, res) => {
  const parsedUrl = parse(req.url || '/', true)
  handle(req, res, parsedUrl)
})

const io = initializeSocketServer(server)
globalThis.io = io

server.listen(PORT, () => {
  logger.info(`üöÄ Next.js server with Socket.IO running on port ${PORT}`)
})
```

#### 2. **–ë–µ–∑ Socket.IO** (`dev`)

```bash
pnpm run dev
# –ò—Å–ø–æ–ª—å–∑—É–µ—Ç: next dev
```

**–ü—Ä–æ—Ü–µ—Å—Å:**
- –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π Next.js dev —Å–µ—Ä–≤–µ—Ä
- Socket.IO —Å–µ—Ä–≤–µ—Ä **–ù–ï –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è**
- API routes —Ä–∞–±–æ—Ç–∞—é—Ç, –Ω–æ Socket.IO –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

### Production

```bash
pnpm run build
pnpm run start  # –ò—Å–ø–æ–ª—å–∑—É–µ—Ç websocket-server-new.ts
```

---

## üîå –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Next.js

### –ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å

**–§–∞–π–ª:** `src/contexts/SocketProvider.tsx`

- React Context –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Socket.IO –∫–ª–∏–µ–Ω—Ç–∞–º–∏
- –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ namespaces: `/chat`, `/notifications`
- –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Ç–æ–∫–µ–Ω —Å–µ—Å—Å–∏–∏
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

### –°–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å (API Routes)

**–ü—Ä–æ–±–ª–µ–º–∞:** Socket.IO —Å–µ—Ä–≤–µ—Ä –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ API routes, –µ—Å–ª–∏:
1. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ —á–µ—Ä–µ–∑ `next dev` (–±–µ–∑ Socket.IO)
2. API routes –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –≤ serverless —Ä–µ–∂–∏–º–µ (—Ä–∞–∑–Ω—ã–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç—ã)

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π:**

```typescript
// src/app/api/admin/monitoring/dashboard/route.ts
const { getSocketServer } = await import('@/lib/sockets')
const io = getSocketServer()

if (io) {
  const realConnections = io.sockets.sockets.size || io.engine?.clientsCount || 0
  // ...
}
```

**–§—É–Ω–∫—Ü–∏—è `getSocketServer()`:**

```typescript
export const getSocketServer = (): Server | null => {
  return io  // –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –º–æ–¥—É–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
}
```

---

## ‚ö†Ô∏è –ü—Ä–æ–±–ª–µ–º—ã –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### 1. **–ü—Ä–æ–±–ª–µ–º–∞ —Å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å—é Socket.IO –≤ API routes**

**–°–∏–º–ø—Ç–æ–º—ã:**
- WebSocket Connections –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 0, —Ö–æ—Ç—è –µ—Å—Ç—å –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
- `getSocketServer()` –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç `null` –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–ª—É—á–∞—è—Ö

**–ü—Ä–∏—á–∏–Ω—ã:**

#### A. –†–∞–∑–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –∑–∞–ø—É—Å–∫–∞
- `next dev` - Socket.IO –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è
- `dev:with-socket` - Socket.IO –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è

#### B. Serverless –∫–æ–Ω—Ç–µ–∫—Å—Ç Next.js
- –í production (serverless) –∫–∞–∂–¥—ã–π API route –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º –ø—Ä–æ—Ü–µ—Å—Å–µ
- –ú–æ–¥—É–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `io` –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
- `globalThis.io` –º–æ–∂–µ—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å –≤ serverless —Ä–µ–∂–∏–º–µ

#### C. –ù–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
- –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –º–µ—Ç—Ä–∏–∫–∞ `metrics.activeConnections` –º–æ–∂–µ—Ç —Ä–∞—Å—Ö–æ–¥–∏—Ç—å—Å—è —Å —Ä–µ–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
- Prometheus –º–µ—Ç—Ä–∏–∫–∞ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∞

### 2. **–ü—Ä–æ–±–ª–µ–º–∞ —Å –ø–æ–ª—É—á–µ–Ω–∏–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π**

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```typescript
const realConnections = io.sockets.sockets.size || io.engine?.clientsCount || 0
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- `io.sockets.sockets.size` - —Ç–æ–ª—å–∫–æ –∫–æ—Ä–Ω–µ–≤–æ–π namespace `/`
- –ù–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –≤ `/chat` –∏ `/notifications` namespaces
- `io.engine?.clientsCount` –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –≤–µ—Ä—Å–∏—è—Ö Socket.IO

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π —Å–ø–æ—Å–æ–±:**
```typescript
// –ü–æ–¥—Å—á–µ—Ç –≤—Å–µ—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –≤–æ –≤—Å–µ—Ö namespaces
let totalConnections = 0
io._nsps.forEach((nsp) => {
  totalConnections += nsp.sockets.size
})
```

### 3. **–ü—Ä–æ–±–ª–µ–º–∞ —Å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–µ–π –º–µ—Ç—Ä–∏–∫**

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```typescript
// –ü—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
metrics.activeConnections++
websocketConnections.set({ environment }, metrics.activeConnections)

// –ü—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏
metrics.activeConnections = Math.max(0, metrics.activeConnections - 1)
websocketConnections.set({ environment }, metrics.activeConnections)
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –º–µ—Ç—Ä–∏–∫–∞ –º–æ–∂–µ—Ç —Ä–∞—Å—Ö–æ–¥–∏—Ç—å—Å—è —Å —Ä–µ–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
- –ù–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –º–µ—Ç—Ä–∏–∫–∏

### 4. **–ü—Ä–æ–±–ª–µ–º–∞ —Å –≥–ª–æ–±–∞–ª—å–Ω–æ–π –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π**

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```typescript
globalThis.io = io
```

**–ü—Ä–æ–±–ª–µ–º—ã:**
- –í serverless —Ä–µ–∂–∏–º–µ `globalThis` –º–æ–∂–µ—Ç –±—ã—Ç—å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
- –ù–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–º –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–∏ (–Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤)

---

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### 1. **–£–ª—É—á—à–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π**

**–†–µ—à–µ–Ω–∏–µ:** –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –≤–æ –≤—Å–µ—Ö namespaces

```typescript
export const getTotalConnections = (io: TypedIOServer | null): number => {
  if (!io) return 0
  
  let total = 0
  // –ü–æ–¥—Å—á–µ—Ç –≤–æ –≤—Å–µ—Ö namespaces
  io._nsps.forEach((nsp) => {
    total += nsp.sockets.size
  })
  
  return total
}
```

**–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:**
```typescript
const io = getSocketServer()
if (io) {
  const realConnections = getTotalConnections(io)
  // –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫—É Prometheus
  websocketConnections.set({ environment }, realConnections)
  websocketActiveConnections = realConnections
}
```

### 2. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º**

**–†–µ—à–µ–Ω–∏–µ:** –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –º–µ—Ç—Ä–∏–∫–∏

```typescript
// –í handleConnection –∏ disconnect
const syncMetrics = () => {
  if (!io) return
  
  const realConnections = getTotalConnections(io)
  metrics.activeConnections = realConnections
  websocketConnections.set({ environment }, realConnections)
}

// –í—ã–∑—ã–≤–∞—Ç—å –ø–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è/–æ—Ç–∫–ª—é—á–µ–Ω–∏—è
socket.on('disconnect', () => {
  syncMetrics()  // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ—Å–ª–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è
  // ...
})
```

### 3. **–£–ª—É—á—à–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Socket.IO**

**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —á–µ—Ä–µ–∑ `globalThis.io` –∫–∞–∫ fallback

```typescript
export const getSocketServer = (): Server | null => {
  // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –º–æ–¥—É–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
  if (io) return io
  
  // Fallback –Ω–∞ globalThis (–¥–ª—è —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ –º–æ–¥—É–ª—å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω)
  if (typeof globalThis !== 'undefined' && globalThis.io) {
    io = globalThis.io
    return io
  }
  
  return null
}
```

### 4. **–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏**

**–†–µ—à–µ–Ω–∏–µ:** –†–∞—Å—à–∏—Ä–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ API route

```typescript
logger.info('[monitoring] Socket.IO availability check', {
  hasModuleIo: !!io,
  hasGlobalIo: typeof globalThis !== 'undefined' && !!globalThis.io,
  totalConnections: io ? getTotalConnections(io) : 0,
  namespaces: io ? Array.from(io._nsps.keys()) : []
})
```

### 5. **–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É —Å–ø–æ—Å–æ–±–∞ –∑–∞–ø—É—Å–∫–∞**

**–†–µ—à–µ–Ω–∏–µ:** –û–ø—Ä–µ–¥–µ–ª—è—Ç—å, –∑–∞–ø—É—â–µ–Ω –ª–∏ Socket.IO —Å–µ—Ä–≤–µ—Ä

```typescript
// –í API route
const isSocketServerRunning = () => {
  try {
    const io = getSocketServer()
    return io !== null && io.connected !== false
  } catch {
    return false
  }
}

if (!isSocketServerRunning()) {
  logger.warn('[monitoring] Socket.IO server is not running. Use "dev:with-socket" or "start" command.')
}
```

### 6. **–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Redis Adapter –¥–ª—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è**

**–î–ª—è production:** –î–æ–±–∞–≤–∏—Ç—å Redis adapter –¥–ª—è Socket.IO

```typescript
import { createAdapter } from '@socket.io/redis-adapter'
import { createClient } from 'redis'

const pubClient = createClient({ url: process.env.REDIS_URL })
const subClient = pubClient.duplicate()

await Promise.all([pubClient.connect(), subClient.connect()])

io.adapter(createAdapter(pubClient, subClient))
```

–≠—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç:
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –º–µ–∂–¥—É –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏
- –ü–æ–ª—É—á–∞—Ç—å —Ç–æ—á–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∏–∑ Redis
- –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞—Ç—å –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ

---

## üìä –¢–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

### ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

1. **–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Socket.IO** - —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —á–µ—Ä–µ–∑ `dev:with-socket`
2. **–ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** - Lucia Auth –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
3. **Namespaces** - `/chat` –∏ `/notifications` —Ä–∞–±–æ—Ç–∞—é—Ç
4. **–ú–µ—Ç—Ä–∏–∫–∏ Prometheus** - —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏/–æ—Ç–∫–ª—é—á–µ–Ω–∏–∏
5. **–ö–ª–∏–µ–Ω—Ç—Å–∫–∞—è —á–∞—Å—Ç—å** - SocketProvider —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

### ‚ö†Ô∏è –ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç —É–ª—É—á—à–µ–Ω–∏—è

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π** - –Ω–µ —É—á–∏—Ç—ã–≤–∞–µ—Ç –≤—Å–µ namespaces
2. **–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤ API routes** - –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–ª—É—á–∞—è—Ö
3. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ—Ç—Ä–∏–∫** - –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –º–µ—Ç—Ä–∏–∫–∏ –º–æ–≥—É—Ç —Ä–∞—Å—Ö–æ–¥–∏—Ç—å—Å—è —Å —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å—é
4. **Serverless —Ä–µ–∂–∏–º** - –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

---

## üîÑ –ü–ª–∞–Ω –¥–µ–π—Å—Ç–≤–∏–π

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1 (–ö—Ä–∏—Ç–∏—á–Ω–æ)

1. ‚úÖ –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (—É—á–µ—Å—Ç—å –≤—Å–µ namespaces)
2. ‚úÖ –î–æ–±–∞–≤–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –º–µ—Ç—Ä–∏–∫ —Å —Ä–µ–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
3. ‚úÖ –£–ª—É—á—à–∏—Ç—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2 (–í–∞–∂–Ω–æ)

4. –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Socket.IO —Å–µ—Ä–≤–µ—Ä–∞
5. –£–ª—É—á—à–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Socket.IO
6. –î–æ–±–∞–≤–∏—Ç—å fallback –Ω–∞ `globalThis.io`

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3 (–ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ)

7. –î–æ–±–∞–≤–∏—Ç—å Redis adapter –¥–ª—è production
8. –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–∞–∑–ª–∏—á–∏—è –º–µ–∂–¥—É —Å–ø–æ—Å–æ–±–∞–º–∏ –∑–∞–ø—É—Å–∫–∞
9. –î–æ–±–∞–≤–∏—Ç—å health check –¥–ª—è Socket.IO —Å–µ—Ä–≤–µ—Ä–∞

---

## üìù –í—ã–≤–æ–¥—ã

1. **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ Socket.IO** —Ö–æ—Ä–æ—à–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∞ —Å –º–æ–¥—É–ª—å–Ω—ã–º –ø–æ–¥—Ö–æ–¥–æ–º
2. **–û—Å–Ω–æ–≤–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞** - –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Socket.IO –≤ API routes –ø—Ä–∏ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–ø–æ—Å–æ–±–∞—Ö –∑–∞–ø—É—Å–∫–∞
3. **–ú–µ—Ç—Ä–∏–∫–∏** –º–æ–≥—É—Ç —Ä–∞—Å—Ö–æ–¥–∏—Ç—å—Å—è —Å —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—å—é –∏–∑-–∑–∞ –Ω–µ–ø–æ–ª–Ω–æ–≥–æ –ø–æ–¥—Å—á–µ—Ç–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
4. **–†–µ—à–µ–Ω–∏–µ** - —É–ª—É—á—à–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∏ –¥–æ–±–∞–≤–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –º–µ—Ç—Ä–∏–∫

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [Socket.IO Client Configuration](../configuration/socket-client.md)
- [Monitoring Dashboard](../monitoring/monitoring-pages-analysis.md)
- [Setup Guide](../setup/setup.md)






