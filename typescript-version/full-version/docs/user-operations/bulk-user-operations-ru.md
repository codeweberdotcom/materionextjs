# Документация по массовым операциям с пользователями

## Обзор

Функционал массовых операций с пользователями позволяет администраторам выполнять пакетные действия над несколькими пользователями одновременно через интерфейс управления пользователями по адресу `/en/apps/user/list`. Эта функция повышает административную эффективность, обеспечивая возможность выполнения массовых операций по удалению, активации и деактивации учетных записей пользователей.

## Возможности

### 1. Интеграция массовых операций
- **Всегда видимы**: Все кнопки действий (Экспорт + массовые операции) всегда отображаются, но отключены при отсутствии выбора допустимых пользователей
- **Единая группа**: Кнопки Экспорта и массовых операций отображаются вместе в одной адаптивной группе кнопок
- **Единообразное оформление**: Все кнопки используют один стиль MUI Button (outlined вариант)
- **Умное отключение**: Кнопки отключаются при отсутствии выбора или выборе только пользователей superadmin (по соображениям безопасности)

### 2. Поддерживаемые операции

#### Массовое удаление
- **Полное удаление**: Безвозвратно удаляет все данные пользователя
- **Анонимизация**: Заменяет личные данные, сохраняя запись пользователя
- **Безопасность**: Автоматически исключает пользователей с ролью superadmin
- **Подтверждение**: Требует явного подтверждения через диалог

#### Массовое включение
- **Пакетная активация**: Активирует несколько учетных записей пользователей одновременно
- **Проверка разрешений**: Требует разрешения `canUpdate`
- **Обратная связь**: Предоставляет уведомления об успехе/неудаче

#### Массовое отключение
- **Пакетное отключение**: Отключает несколько учетных записей пользователей одновременно
- **Проверка разрешений**: Требует разрешения `canUpdate`
- **Обратная связь**: Предоставляет уведомления об успехе/неудаче

### 3. Меры безопасности

#### Управление доступом на основе разрешений
- **Операции удаления**: Требуют разрешения `canDelete`
- **Операции со статусом**: Требуют разрешения `canUpdate`
- **Защита superadmin**: Автоматически исключает учетные записи superadmin из всех массовых операций

#### Валидация данных
- **Обработка пустого выделения**: Операции отключены при отсутствии допустимых пользователей
- **Обработка частичных неудач**: Продолжает обработку оставшихся пользователей при сбое некоторых операций
- **Предотвращение отката**: Использует атомарные операции где возможно

## Техническая реализация

### Компоненты Frontend

#### Компонент UserListTable
```typescript
// Ключевые переменные состояния
const [rowSelection, setRowSelection] = useState({})
const [bulkOperationLoading, setBulkOperationLoading] = useState(false)

// Вспомогательные функции выделения
const getSelectedUsers = () => { /* возвращает объекты выбранных пользователей */ }
const getFilteredSelectedUsers = () => { /* исключает superadmin */ }

// Функции массовых операций
const handleBulkDelete = async (mode: 'delete' | 'anonymize') => { /* ... */ }
const handleBulkStatusChange = async (activate: boolean) => { /* ... */ }
```

#### Панель массовых операций
```tsx
{Object.keys(rowSelection).some(id => rowSelection[id]) && (
  <div className='flex items-center justify-between p-4 bg-primary/5 border-bs border-primary/20'>
    <Typography>{count} пользователей выбрано</Typography>
    <div className='flex gap-2'>
      <Button onClick={handleBulkDelete}>Удалить</Button>
      <Button onClick={handleBulkActivate}>Активировать</Button>
      <Button onClick={handleBulkDeactivate}>Деактивировать</Button>
    </div>
  </div>
)}
```

### Интеграция с API

#### Используемые существующие эндпоинты
- `DELETE /api/admin/users/{id}` - Удаление отдельного пользователя
- `POST /api/admin/data-sanitization` - Анонимизация данных пользователя
- `PATCH /api/admin/users/{id}` - Обновление статуса пользователя

#### Параллельная обработка
```typescript
// Использует Promise.allSettled для одновременных вызовов API
const results = await Promise.allSettled(
  selectedUsers.map(user => fetch(`/api/admin/users/${user.id}`, { method: 'DELETE' }))
)
```

### Интернационализация

#### Добавленные ключи переводов
```json
{
  "bulkDelete": "Удалить выбранных",
  "bulkActivate": "Активировать выбранных",
  "bulkDeactivate": "Деактивировать выбранных",
  "confirmBulkDelete": "Вы уверены, что хотите удалить ${count} выбранных пользователей?",
  "bulkOperationSuccess": "Операция успешно выполнена для ${successCount} пользователей",
  "bulkOperationPartialSuccess": "Операция выполнена для ${successCount} из ${totalCount} пользователей"
}
```

#### Поддерживаемые языки
- Английский (en.json)
- Русский (ru.json)
- Французский (fr.json)
- Арабский (ar.json)

## Пользовательский опыт

### Рабочий процесс
1. **Выделение**: Пользователь выбирает несколько строк с помощью чекбоксов (кнопки всегда видимы, но отключены при отсутствии допустимого выбора)
2. **Состояние кнопок**: Кнопки массовых операций активируются при выборе допустимых пользователей
3. **Выбор действия**: Пользователь нажимает кнопку нужной массовой операции
4. **Подтверждение**: Для деструктивных действий появляется диалог
5. **Обработка**: Показываются состояния загрузки во время операции, кнопки отключаются
6. **Обратная связь**: Отображаются уведомления об успехе/ошибке
7. **Очистка**: Выделение очищается, таблица обновляется с актуальными данными

### Визуальная обратная связь
- **Состояния загрузки**: Кнопки отключены во время операций
- **Индикаторы прогресса**: Toast-уведомления о статусе операции
- **Обработка ошибок**: Подробные сообщения об ошибках неудачных операций
- **Подтверждение успеха**: Четкие сообщения об успехе с подсчетом операций

## Соображения безопасности

### Проверки разрешений
- Все операции проверяют разрешения пользователя перед выполнением
- Фронтенд проверки разрешений дополняются бэкенд валидацией
- Операции корректно завершаются неудачей при недостаточных разрешениях

### Защита данных
- Учетные записи superadmin автоматически исключаются из массовых операций
- Диалоги подтверждения для деструктивных операций
- Механизмы безопасного отката где применимо

### Обработка ошибок
- Поддержка частичных неудач (некоторые операции успешны, другие нет)
- Подробная отчетность об ошибках
- Безопасные пути отката где применимо

## Оптимизация производительности

### Эффективная обработка
- **Параллельные вызовы API**: Использует `Promise.allSettled` для одновременной обработки
- **Ограничения размера пакета**: Предотвращает перегрузку сервера слишком большим количеством одновременных запросов
- **Управление памятью**: Правильная очистка состояния выделения после операций

### Отзывчивость UI
- **Состояния загрузки**: Немедленная визуальная обратная связь во время операций
- **Обновления в реальном времени**: Данные таблицы обновляются сразу после операций без перезагрузки страницы
- **Обновления ссылок на массивы**: Использует spread-оператор для создания новых ссылок на массивы для правильной перерисовки React
- **Восстановление после ошибок**: Четкие пути для повторения неудачных операций

## Тестирование

### Модульные тесты
- Рендеринг компонентов с различными состояниями выделения
- Видимость кнопок на основе разрешений
- Мокирование вызовов API и обработка ответов
- Симуляция сценариев ошибок

### Интеграционные тесты
- Сквозные рабочие процессы массовых операций
- Валидация разрешений между ролями пользователей
- Рендеринг ключей интернационализации
- Кросс-браузерная совместимость

### Ручные сценарии тестирования
- Массовые операции с различными комбинациями ролей пользователей
- Симуляция сбоев сети
- Тестирование границ разрешений
- Обработка больших наборов выделения

## Будущие улучшения

### Потенциальные возможности
- **Массовое назначение ролей**: Изменение ролей пользователей оптом
- **Массовые email уведомления**: Отправка уведомлений выбранным пользователям
- **Экспорт выбранных**: Экспорт данных выбранных пользователей
- **Расширенная фильтрация**: Предварительная фильтрация пользователей перед массовыми операциями
- **История операций**: Отслеживание логов массовых операций

### Улучшения масштабируемости
- **Поддержка пагинации**: Обработка массовых операций через результаты пагинации
- **Система очередей**: Фоновая обработка для очень больших операций
- **Отслеживание прогресса**: Реальное время прогресса для длительных операций

## Устранение неполадок

### Распространенные проблемы
- **Панель массовых операций не отображается**: Убедитесь, что пользователи выбраны и разрешения предоставлены
- **Сбои операций**: Проверьте подключение к сети и логи сервера
- **Ошибки разрешений**: Проверьте роль пользователя и назначенные разрешения
- **Исключение superadmin**: Подтвердите правильную фильтрацию учетных записей superadmin

### Отладочная информация
- Проверьте консоль браузера на детали вызовов API
- Просмотрите логи сервера на обработку операций
- Проверьте настройки разрешений в управлении пользователями
- Подтвердите загрузку ключей интернационализации

## Справочник API

### Функции Frontend
- `getSelectedUsers()`: Возвращает массив объектов выбранных пользователей
- `getFilteredSelectedUsers()`: Возвращает выбранных пользователей исключая superadmin
- `handleBulkDelete(mode)`: Обрабатывает массовое удаление/анонимизацию
- `handleBulkStatusChange(activate)`: Обрабатывает массовые изменения статуса

### Эндпоинты Backend
- `DELETE /api/admin/users/{id}`: Удаление отдельного пользователя
- `POST /api/admin/data-sanitization`: Анонимизация данных пользователя
- `PATCH /api/admin/users/{id}`: Обновление статуса пользователя

## Заключение

Функционал массовых операций с пользователями значительно повышает административную эффективность, сохраняя безопасность и целостность данных. Реализация следует лучшим практикам производительности, пользовательского опыта и поддерживаемости, предоставляя прочную основу для будущих улучшений.









