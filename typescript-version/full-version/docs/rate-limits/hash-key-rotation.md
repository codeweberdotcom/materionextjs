# –†–æ—Ç–∞—Ü–∏—è –∫–ª—é—á–µ–π —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è Rate Limit

–î–æ–∫—É–º–µ–Ω—Ç –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å —Ä–æ—Ç–∞—Ü–∏–∏ —Å–µ–∫—Ä–µ—Ç–Ω—ã—Ö –∫–ª—é—á–µ–π –¥–ª—è —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è PII –¥–∞–Ω–Ω—ã—Ö (IP –∞–¥—Ä–µ—Å–æ–≤ –∏ email) –≤ —Å–∏—Å—Ç–µ–º–µ rate limiting.

## üîê –û–±–∑–æ—Ä

–°–∏—Å—Ç–µ–º–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç HMAC-SHA256 –¥–ª—è —Ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:
- IP –∞–¥—Ä–µ—Å–∞ ‚Üí `ipHash` –∏ `ipPrefix`
- Email ‚Üí `emailHash`

–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è `RATE_LIMIT_SECRET`.

## ‚ö†Ô∏è –ó–∞—á–µ–º –Ω—É–∂–Ω–∞ —Ä–æ—Ç–∞—Ü–∏—è

1. **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –†–µ–≥—É–ª—è—Ä–Ω–∞—è —Ä–æ—Ç–∞—Ü–∏—è —Å–Ω–∏–∂–∞–µ—Ç —Ä–∏—Å–∫ –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü–∏–∏
2. **–°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º:** –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (SOC 2, ISO 27001)
3. **–ê—É–¥–∏—Ç:** –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤–µ—Ä—Å–∏–π –∫–ª—é—á–µ–π

## üìã –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ —Ä–æ—Ç–∞—Ü–∏–∏

### 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–µ–∫—É—â–µ–π –≤–µ—Ä—Å–∏–∏

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–∏–π hashVersion –≤ –ë–î
pnpm prisma studio --schema prisma/schema.prisma
# –û—Ç–∫—Ä–æ–π—Ç–µ —Ç–∞–±–ª–∏—Ü—É RateLimitEvent –∏ –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–ª–µ hashVersion
```

### 2. –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫–ª—é—á–∞

```bash
# –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á (–º–∏–Ω–∏–º—É–º 32 —Å–∏–º–≤–æ–ª–∞)
openssl rand -hex 32

# –ò–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Node.js
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

### 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ä–æ–≥–æ –∫–ª—é—á–∞

**–í–∞–∂–Ω–æ:** –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Å—Ç–∞—Ä—ã–π –∫–ª—é—á –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ (secrets manager) –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö.

```bash
# –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ secrets manager (–ø—Ä–∏–º–µ—Ä –¥–ª—è AWS Secrets Manager)
aws secretsmanager create-secret \
  --name rate-limit-secret-v1 \
  --secret-string "old-secret-key-here" \
  --description "Rate limit secret key version 1 (deprecated)"
```

## üîÑ –ü—Ä–æ—Ü–µ—Å—Å —Ä–æ—Ç–∞—Ü–∏–∏

### –®–∞–≥ 1: –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–æ–≤–æ–≥–æ –∫–ª—é—á–∞

```bash
# –í production –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ secrets manager
export RATE_LIMIT_SECRET="new-secret-key-here"

# –ò–ª–∏ —á–µ—Ä–µ–∑ .env —Ñ–∞–π–ª (—Ç–æ–ª—å–∫–æ –¥–ª—è development)
echo "RATE_LIMIT_SECRET=new-secret-key-here" >> .env
```

### –®–∞–≥ 2: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `RATE_LIMIT_SECRET` –∏–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è. –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–µ—Ä—Å–∏–π –∫–ª—é—á–µ–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞.

### –®–∞–≥ 3: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ hashVersion

```typescript
// –í src/lib/rate-limit/services/RateLimitEngine.ts
const IP_HASH_VERSION = 2  // –£–≤–µ–ª–∏—á–∏—Ç—å –≤–µ—Ä—Å–∏—é
const EMAIL_HASH_VERSION = 2
```

### –®–∞–≥ 4: –ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

```sql
-- –û–±–Ω–æ–≤–∏—Ç—å hashVersion –¥–ª—è –Ω–æ–≤—ã—Ö –∑–∞–ø–∏—Å–µ–π
-- –°—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ —Å–æ—Ö—Ä–∞–Ω—è—Ç —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏

-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–µ–∫—É—â–µ–µ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π
SELECT "hashVersion", COUNT(*) 
FROM "RateLimitEvent" 
GROUP BY "hashVersion";
```

### –®–∞–≥ 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
pnpm test:unit -- rate-limit

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
pnpm prisma studio --schema prisma/schema.prisma
```

## üîç –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–µ—Ä—Å–∏–π –∫–ª—é—á–µ–π

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—Ç—å —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö:

### –í–∞—Ä–∏–∞–Ω—Ç 1: –•—Ä–∞–Ω–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π –≤ secrets manager

```typescript
// –ü—Å–µ–≤–¥–æ–∫–æ–¥ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≤–µ—Ä—Å–∏–π
const getHashSecret = (version: number): string => {
  switch (version) {
    case 1:
      return process.env.RATE_LIMIT_SECRET_V1 || process.env.RATE_LIMIT_SECRET
    case 2:
      return process.env.RATE_LIMIT_SECRET_V2 || process.env.RATE_LIMIT_SECRET
    default:
      return process.env.RATE_LIMIT_SECRET
  }
}
```

### –í–∞—Ä–∏–∞–Ω—Ç 2: –ú–∏–≥—Ä–∞—Ü–∏—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö

–ï—Å–ª–∏ –Ω—É–∂–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Ö—ç—à–∏ –¥–ª—è —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö (—Ç—Ä–µ–±—É–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ raw –∑–Ω–∞—á–µ–Ω–∏—è–º):

```sql
-- –í–ù–ò–ú–ê–ù–ò–ï: –≠—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ raw –∑–Ω–∞—á–µ–Ω–∏—è –µ—â–µ –¥–æ—Å—Ç—É–ø–Ω—ã
-- –í —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ raw –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –¥–ª—è GDPR compliance

-- –ï—Å–ª–∏ raw –∑–Ω–∞—á–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω—ã, –º–æ–∂–Ω–æ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å:
UPDATE "RateLimitEvent"
SET 
  "ipHash" = compute_new_hash("ipAddress", new_secret),
  "hashVersion" = 2
WHERE "hashVersion" = 1 AND "ipAddress" IS NOT NULL;
```

**–í–∞–∂–Ω–æ:** –í —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ raw –∑–Ω–∞—á–µ–Ω–∏—è –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è, –ø–æ—ç—Ç–æ–º—É –ø–µ—Ä–µ—Å—á–µ—Ç –Ω–µ–≤–æ–∑–º–æ–∂–µ–Ω. –°—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é —Ö—ç—à–∞.

## üìÖ –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π –≥—Ä–∞—Ñ–∏–∫ —Ä–æ—Ç–∞—Ü–∏–∏

- **–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–∏—Å—Ç–µ–º—ã:** –ö–∞–∂–¥—ã–µ 90 –¥–Ω–µ–π
- **–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Å–∏—Å—Ç–µ–º—ã:** –ö–∞–∂–¥—ã–µ 180 –¥–Ω–µ–π
- **–ù–∏–∑–∫–∏–π —Ä–∏—Å–∫:** –ö–∞–∂–¥—ã–µ 365 –¥–Ω–µ–π

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç —Ä–æ—Ç–∞—Ü–∏–∏

- [ ] –°–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Å–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á (–º–∏–Ω–∏–º—É–º 32 —Å–∏–º–≤–æ–ª–∞)
- [ ] –°—Ç–∞—Ä—ã–π –∫–ª—é—á —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ secrets manager
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–∫—Ä—É–∂–µ–Ω–∏—è `RATE_LIMIT_SECRET`
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω `IP_HASH_VERSION` –∏ `EMAIL_HASH_VERSION` –≤ –∫–æ–¥–µ
- [ ] –í—ã–ø–æ–ª–Ω–µ–Ω–∞ –º–∏–≥—Ä–∞—Ü–∏—è –ë–î (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è)
- [ ] –ó–∞–ø—É—â–µ–Ω—ã —Ç–µ—Å—Ç—ã
- [ ] –ü—Ä–æ–≤–µ—Ä–µ–Ω–æ, —á—Ç–æ –Ω–æ–≤—ã–µ –∑–∞–ø–∏—Å–∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
- [ ] –û–±–Ω–æ–≤–ª–µ–Ω–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- [ ] –£–≤–µ–¥–æ–º–ª–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –æ —Ä–æ—Ç–∞—Ü–∏–∏

## üö® –û—Ç–∫–∞—Ç (Rollback)

–ï—Å–ª–∏ —Ä–æ—Ç–∞—Ü–∏—è –≤—ã–∑–≤–∞–ª–∞ –ø—Ä–æ–±–ª–µ–º—ã:

1. **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—ã–π –∫–ª—é—á:**
   ```bash
   export RATE_LIMIT_SECRET="old-secret-key-here"
   ```

2. **–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ä—É—é –≤–µ—Ä—Å–∏—é –∫–æ–¥–∞:**
   ```typescript
   const IP_HASH_VERSION = 1
   const EMAIL_HASH_VERSION = 1
   ```

3. **–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ**

4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ –Ω–∞ –æ—à–∏–±–∫–∏**

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ—Å–ª–µ —Ä–æ—Ç–∞—Ü–∏–∏

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π –≤ –ë–î
pnpm prisma db execute --schema prisma/schema.prisma --stdin <<'SQL'
SELECT 
  "hashVersion",
  COUNT(*) as count,
  MIN("createdAt") as first_record,
  MAX("createdAt") as last_record
FROM "RateLimitEvent"
GROUP BY "hashVersion"
ORDER BY "hashVersion";
SQL
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

1. **–ù–∏–∫–æ–≥–¥–∞ –Ω–µ –∫–æ–º–º–∏—Ç—å—Ç–µ —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –∫–ª—é—á–∏ –≤ Git**
2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ secrets manager –≤ production**
3. **–û–≥—Ä–∞–Ω–∏—á—å—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–ª—é—á–∞–º (–ø—Ä–∏–Ω—Ü–∏–ø –Ω–∞–∏–º–µ–Ω—å—à–∏—Ö –ø—Ä–∏–≤–∏–ª–µ–≥–∏–π)**
4. **–õ–æ–≥–∏—Ä—É–π—Ç–µ —Ñ–∞–∫—Ç —Ä–æ—Ç–∞—Ü–∏–∏ (–±–µ–∑ —Å–∞–º–æ–≥–æ –∫–ª—é—á–∞)**
5. **–†–µ–≥—É–ª—è—Ä–Ω–æ –ø—Ä–æ–≤–µ—Ä—è–π—Ç–µ –¥–æ—Å—Ç—É–ø –∫ secrets manager**

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [–û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–π –≥–∞–π–¥](../monitoring/rate-limit-operations.md)
- [–ü—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏](./configuration-examples.md)
- [API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è](../api/rate-limits.md)








