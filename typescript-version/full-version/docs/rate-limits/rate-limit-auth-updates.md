# Rate limit & Auth Updates (2025-11-20)

## Summary

Внесены изменения в критические части модуля авторизации, регистрации и мониторинга чатового rate limit. Ниже описаны цели, детали реализации и влияние на API/обслуживание.

## 1. Login endpoint (`src/app/api/auth/login/route.ts`)

- **Порядок операций**: rate-limit проверка теперь выполняется *до* обращения к базе и поиска пользователя. Это закрывает timing-атаку (время ответа больше не раскрывает существование email).
- **Двухуровневый лимит**: после первой проверки по email выполняется вторая проверка по `user.id`, если пользователь найден. Таким образом, общие лимиты и индивидуальные блокировки работают одновременно.
- **Минимальное время ответа**: введена задержка в 200 мс (компенсируется с помощью `setTimeout`), чтобы уравнять ответы при существующих/несуществующих аккаунтах и при разных ветках обработки.
- **Корректный Retry-After**: `retryAfter` теперь рассчитывается как `(resetTime - Date.now()) / 1000`, что возвращает количество секунд до разблокировки.
- **Стандартизированная ошибка**: все ответы формируются через `createErrorResponse`, что гарантирует формат `{ error: { code, message, details } }` и одновременно логирует событие в Winston/Loki.

## 2. Chat rate-limit check (`src/app/api/chat/messages/check-rate-limit/route.ts`)

- Убрана двойная проверка лимита (раньше второй вызов с `increment: true` списывал попытку даже при простом опросе статуса).
- Теперь используется только первый результат с `increment: false`: в режиме `monitor` возвращается предупреждение, в `enforce` — сразу формируется ответ 429 с «симулированным» временем разблокировки (без дополнительного инкремента).
- Добавлено логирование веток `monitor/enforce`, чтобы в Grafana/Loki можно было отслеживать переходы.

## 3. Password strength (регистрация)

- Добавлена утилита `validatePassword` (`src/utils/passwordValidation.ts`) с политикой:
  - длина 8–128 символов;
  - минимум по одной строчной, прописной букве, цифре и спецсимволу;
  - запрет на популярные пароли (`password`, `123456`, `admin`, …).
- В `src/app/api/register/route.ts` пароль проверяется до создания пользователя; при нарушении требований возвращается 400 с перечнем ошибок, также через `createErrorResponse`.

## 4. Единый формат ошибок (`src/utils/apiError.ts`)

- Введена вспомогательная функция `createErrorResponse`, которая:
  - формирует JSON-ответ в виде `{ error: { code, message, details } }`;
  - автоматически добавляет заголовок `Content-Type: application/json`;
  - логирует событие в Winston (уровни `error/warn/info`), что попадает в Loki/Prometheus (при дальнейшем экспорте).
- Пока задействована в login и register; её планируется распространить на остальные API.

### 4.1 Метрики ошибок

- Для интеграции с Prometheus добавлен счётчик `api_errors_total` (`src/lib/metrics/api-errors.ts`) с лейблами `route`, `code`, `status`.
- `createErrorResponse` инкрементирует метрику автоматически, если передан `route`.
- Это позволяет писать алёрты вида:

```promql
increase(api_errors_total{route="login", code="AUTH_RATE_LIMIT_USER"}[5m]) > 3
```

и фильтровать ошибки по коду прямо в Grafana/Alertmanager.

## 5. Многоуровневая защита регистрации

- Базовый модуль `registration` удалён: теперь используются три отдельных лимита:
  1. `registration-ip` — ограничение по IP (3 попытки/час → блок на 24 часа).
  2. `registration-domain` — ограничение по домену email (10 регистраций/час).
  3. `registration-email` — одна попытка на email в сутки.
- Эндпоинт `POST /api/register` последовательно вызывает эти три `checkLimit`, возвращая код `REG_RATE_LIMIT` с указанием нарушенного модуля.
- UI (админка, блоки, журнал событий) обновлён: новые модули отображаются в списках, фильтрах и графиках.
- В ручном блокировщике добавлено поле **MailDomain**: админы могут явно блокировать домены (`yandex.ru`, `rambler.ru`). Бэкенд хранит это в `UserBlock.mailDomain`, а `rateLimitService` учитывает доменные блоки при проверке `registration-domain`.
- Модули чата теперь отображаются в сводках: в `setDefaultConfigs` добавлен `chat-rooms`, а API `/api/admin/rate-limits` включает `chat-rooms` и `chat-connections`, поэтому статистика/конфиги видны в админке без запуска сидов.
- Seed-скрипт (`prisma/seed.ts`) теперь не создаёт конфиг `registration` и удаляет его, если он остался в базе. Для применения — запустите `pnpm prisma db seed` (или соответствующую команду) после деплоя.

## 6. Мониторинг и поддержка

- Новые коды ошибок (например, `AUTH_RATE_LIMIT_USER`, `REG_WEAK_PASSWORD`) упрощают фильтрацию логов в Loki и построение алёртов в Prometheus.
- Минимальное время ответа и унифицированные коды стоит отразить в фронтенд-спеке: UI должен обрабатывать поле `error.code`, а предупреждения (например, остаток попыток) приходят в `error.details`.

## Проверка и следующие шаги

- Рекомендуется прогнать `pnpm lint/test` и smoke-тесты auth/register/chat, чтобы убедиться в корректном поведении.
- Обновить клиентскую документацию / словари переводов, если UI должен показывать новые тексты.
- Расширить применение `createErrorResponse` на остальные API, чтобы алёрты и аналитика были единообразными.








