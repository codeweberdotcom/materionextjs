# –û—Ç—á—ë—Ç: –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ S3 –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è–º –≤ –º–µ–¥–∏–∞—Ç–µ–∫–µ

**–ü–µ—Ä–∏–æ–¥:** 2025-12-01  
**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-12-01  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω

---

## üìã –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [–ê–Ω–∞–ª–∏–∑](../../analysis/architecture/analysis-media-s3-direct-access-2025-12-01.md)
- [–ü–ª–∞–Ω](../../plans/completed/plan-media-s3-direct-access-2025-12-01.md)

---

## ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ

### –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏:

1. ‚úÖ **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –Ω–∞ S3**
   - –û–ø–∏—Å–∞–Ω–∏–µ: –õ–æ–≥–∏–∫–∞ `syncToS3` –≤ `StorageService.ts` —Ç–µ–ø–µ—Ä—å –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç –∫–∞–∂–¥—ã–π –≤–∞—Ä–∏–∞–Ω—Ç
   - –†–µ–∑—É–ª—å—Ç–∞—Ç: –í–∞—Ä–∏–∞–Ω—Ç—ã (thumb, medium, large) –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
   - –§–∞–π–ª: `src/services/media/storage/StorageService.ts`

2. ‚úÖ **–ù–∞—Å—Ç—Ä–æ–µ–Ω –ø—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ MinIO bucket**
   - –û–ø–∏—Å–∞–Ω–∏–µ: Bucket `555` –Ω–∞—Å—Ç—Ä–æ–µ–Ω –¥–ª—è –ø—É–±–ª–∏—á–Ω–æ–≥–æ —á—Ç–µ–Ω–∏—è —á–µ—Ä–µ–∑ `mc anonymous set download local/555`
   - –†–µ–∑—É–ª—å—Ç–∞—Ç: –§–∞–π–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ –ø—Ä—è–º—ã–º URL –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
   - Credentials: `minioadmin` / `minioadmin123`

3. ‚úÖ **–†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ S3 –≤ MediaLibrary**
   - –û–ø–∏—Å–∞–Ω–∏–µ: –î–æ–±–∞–≤–ª–µ–Ω state `s3PublicUrlPrefix`, –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `getMediaUrl`
   - –†–µ–∑—É–ª—å—Ç–∞—Ç: –ü—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω–æ–º prefix –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –Ω–∞–ø—Ä—è–º—É—é —Å S3
   - –§–∞–π–ª: `src/views/admin/media/MediaLibrary.tsx`

---

## üêõ –ü—Ä–æ–±–ª–µ–º—ã –∏ —Ä–µ—à–µ–Ω–∏—è

### –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **–í–∞—Ä–∏–∞–Ω—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∂–∞–ª–∏—Å—å –Ω–∞ S3 –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏**
   - –û–ø–∏—Å–∞–Ω–∏–µ: –£—Å–ª–æ–≤–∏–µ `if (!alreadyOnS3)` –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫—É –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ –µ—Å–ª–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª —É–∂–µ –Ω–∞ S3
   - –†–µ—à–µ–Ω–∏–µ: –†–∞–∑–¥–µ–ª–∏–ª–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –æ—Ä–∏–≥–∏–Ω–∞–ª–∞ –∏ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤, –¥–æ–±–∞–≤–∏–ª–∏ `s3Adapter.exists()` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–∞—Ä–∏–∞–Ω—Ç–∞
   - –°—Ç–∞—Ç—É—Å: ‚úÖ –†–µ—à–µ–Ω–æ

2. **–û—à–∏–±–∫–∞ `AccessDenied` –ø—Ä–∏ –¥–æ—Å—Ç—É–ø–µ –∫ S3**
   - –û–ø–∏—Å–∞–Ω–∏–µ: MinIO bucket –Ω–µ –±—ã–ª –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–∞–∫ –ø—É–±–ª–∏—á–Ω—ã–π
   - –†–µ—à–µ–Ω–∏–µ: –°–æ–∑–¥–∞–Ω alias —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ credentials –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ `mc anonymous set download`
   - –°—Ç–∞—Ç—É—Å: ‚úÖ –†–µ—à–µ–Ω–æ

3. **–û—à–∏–±–∫–∞ `NoSuchKey` –¥–ª—è –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤**
   - –û–ø–∏—Å–∞–Ω–∏–µ: –í–∞—Ä–∏–∞–Ω—Ç—ã –Ω–µ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–ª–∏ –Ω–∞ S3 (—Ç–æ–ª—å–∫–æ s3Key –∑–∞–ø–∏—Å–∞–Ω –≤ –ë–î)
   - –†–µ—à–µ–Ω–∏–µ: –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ `await this.s3Adapter.exists(variant.s3Key)` –ø–µ—Ä–µ–¥ –ø—Ä–æ–ø—É—Å–∫–æ–º –∑–∞–≥—Ä—É–∑–∫–∏
   - –°—Ç–∞—Ç—É—Å: ‚úÖ –†–µ—à–µ–Ω–æ

4. **–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏—Å—å –∏–∑ –∫—ç—à–∞ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è —Å S3**
   - –û–ø–∏—Å–∞–Ω–∏–µ: –ë—Ä–∞—É–∑–µ—Ä –∫—ç—à–∏—Ä—É–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º `max-age=31536000`
   - –†–µ—à–µ–Ω–∏–µ: –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø –∫ S3 –ø–æ–∑–≤–æ–ª—è–µ—Ç –≤–∏–¥–µ—Ç—å —Ä–µ–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ hard reload
   - –°—Ç–∞—Ç—É—Å: ‚úÖ –û–∂–∏–¥–∞–µ–º–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ (–Ω–µ –±–∞–≥)

---

## üìä –ò–∑–º–µ–Ω—ë–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

| –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏—è |
|------|-----------|
| `src/services/media/storage/StorageService.ts` | –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ `syncToS3`: –Ω–µ–∑–∞–≤–∏—Å–∏–º–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤, –ø—Ä–æ–≤–µ—Ä–∫–∞ `s3Adapter.exists()` |
| `src/views/admin/media/MediaLibrary.tsx` | –î–æ–±–∞–≤–ª–µ–Ω `s3PublicUrlPrefix` state, –æ–±–Ω–æ–≤–ª—ë–Ω `getMediaUrl` –¥–ª—è –ø—Ä—è–º–æ–≥–æ S3 |
| MinIO bucket `555` | –ù–∞—Å—Ç—Ä–æ–µ–Ω –ø—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø –¥–ª—è —á—Ç–µ–Ω–∏—è |

---

## üìà –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ –∏–∑–º–µ–Ω–µ–Ω–∏–π:

- ‚ùå –í–∞—Ä–∏–∞–Ω—Ç—ã –Ω–µ –∑–∞–≥—Ä—É–∂–∞–ª–∏—Å—å –Ω–∞ S3 –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
- ‚ùå –ü—Ä—è–º—ã–µ URL –≤–æ–∑–≤—Ä–∞—â–∞–ª–∏ `AccessDenied`
- ‚ùå –ú–µ–¥–∏–∞—Ç–µ–∫–∞ –≤—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∞ proxy

### –ü–æ—Å–ª–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π:

- ‚úÖ –í—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –Ω–∞ S3
- ‚úÖ –§–∞–π–ª—ã –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ –ø—Ä—è–º—ã–º URL
- ‚úÖ –ú–µ–¥–∏–∞—Ç–µ–∫–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä—è–º–æ–π S3 URL –ø—Ä–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–Ω–æ–º prefix
- ‚úÖ –ü—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∞–π–ª–∞ —Å S3 —Å—Ä–∞–∑—É –≤–∏–¥–Ω–∞ –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏

---

## üéØ –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ URL

| –£—Å–ª–æ–≤–∏–µ | URL |
|---------|-----|
| –í –∫–æ—Ä–∑–∏–Ω–µ | `/api/admin/media/{id}/trash` (proxy) |
| S3 + `s3PublicUrlPrefix` –Ω–∞—Å—Ç—Ä–æ–µ–Ω | `http://localhost:9000/555/{s3Key}` (–ø—Ä—è–º–æ–π) |
| –õ–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª | `/uploads/{path}` |
| –¢–æ–ª—å–∫–æ S3 (–±–µ–∑ prefix) | `/api/admin/media/{id}/file` (proxy) |

---

## üìù –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ MinIO

```bash
# –°–æ–∑–¥–∞—Ç—å alias —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ credentials
docker exec materio-s3 mc alias set local http://localhost:9000 minioadmin minioadmin123 --api S3v4

# –°–¥–µ–ª–∞—Ç—å bucket –ø—É–±–ª–∏—á–Ω—ã–º –¥–ª—è —á—Ç–µ–Ω–∏—è
docker exec materio-s3 mc anonymous set download local/555

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ bucket
docker exec materio-s3 mc ls local/555/ --recursive
```

---

## üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

1. **–î–ª—è Production:**
   - –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å CDN –ø–µ—Ä–µ–¥ S3 –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
   - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å CORS –¥–ª—è S3 bucket
   - –†–∞—Å—Å–º–æ—Ç—Ä–µ—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ presigned URLs –¥–ª—è –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤

2. **–î–ª—è Development:**
   - –í—Å–µ–≥–¥–∞ –ø—Ä–æ–≤–µ—Ä—è—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫—É `s3PublicUrlPrefix` –≤ MediaSettings
   - –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å bucket permissions

---

## üîó –°–≤—è–∑–∞–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ ROOT_FILES_DESCRIPTION.md

–î–æ–±–∞–≤–ª–µ–Ω —Ä–∞–∑–¥–µ–ª –æ –ø—Ä—è–º–æ–º –¥–æ—Å—Ç—É–ø–µ –∫ S3 –≤ –æ–ø–∏—Å–∞–Ω–∏–∏ –º–æ–¥—É–ª—è Media.



