# ‚úÖ –û—Ç—á–µ—Ç: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–µ—Ç—Ä–∏–∫ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

**–î–∞—Ç–∞:** 2025-01-24  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–æ  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í—ã—Å–æ–∫–∏–π

---

## üéØ –¶–µ–ª—å –∑–∞–¥–∞—á–∏

–ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–æ–±–ª–µ–º—É —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –º–µ—Ç—Ä–∏–∫ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –Ω–∞ –¥–∞—à–±–æ—Ä–¥–µ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞. –ü—Ä–æ–±–ª–µ–º–∞: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –ø–æ–∫–∞–∑—ã–≤–∞–ª–æ 0, —Ö–æ—Ç—è –±—ã–ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è.

---

## üîç –ü—Ä–æ–±–ª–µ–º–∞

1. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Å—á–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–ª—Å—è `io.sockets.sockets.size`, –∫–æ—Ç–æ—Ä—ã–π —É—á–∏—Ç—ã–≤–∞–µ—Ç —Ç–æ–ª—å–∫–æ –∫–æ—Ä–Ω–µ–≤–æ–π namespace `/`, –∏–≥–Ω–æ—Ä–∏—Ä—É—è `/chat` –∏ `/notifications`
2. **–ù–µ—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏**: –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –º–µ—Ç—Ä–∏–∫–∞ `metrics.activeConnections` –º–æ–≥–ª–∞ —Ä–∞—Å—Ö–æ–¥–∏—Ç—å—Å—è —Å —Ä–µ–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ fallback**: `getSocketServer()` –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª `globalThis.io` –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç

---

## ‚úÖ –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### 1. –§—É–Ω–∫—Ü–∏—è `getTotalConnections()`

**–§–∞–π–ª:** `src/lib/sockets/index.ts`

```typescript
export const getTotalConnections = (): number => {
  const server = getSocketServer()
  if (!server) return 0
  
  let total = 0
  // –ü–æ–¥—Å—á–µ—Ç –≤–æ –≤—Å–µ—Ö namespaces
  server._nsps.forEach((nsp) => {
    total += nsp.sockets.size
  })
  
  return total
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –¢–µ–ø–µ—Ä—å —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è –≤–æ –≤—Å–µ—Ö namespaces (`/`, `/chat`, `/notifications`)

### 2. –§—É–Ω–∫—Ü–∏—è `syncMetrics()`

**–§–∞–π–ª:** `src/lib/sockets/index.ts`

```typescript
const syncMetrics = () => {
  if (!io) return
  
  const realConnections = getTotalConnections()
  metrics.activeConnections = realConnections
  
  const environment = process.env.NODE_ENV || 'development'
  websocketConnections.set({ environment }, realConnections)
  
  logger.debug('Metrics synced', {
    realConnections,
    metricsActiveConnections: metrics.activeConnections
  })
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ú–µ—Ç—Ä–∏–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è —Å —Ä–µ–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏/–æ—Ç–∫–ª—é—á–µ–Ω–∏–∏

### 3. –£–ª—É—á—à–µ–Ω–Ω—ã–π `getSocketServer()`

**–§–∞–π–ª:** `src/lib/sockets/index.ts`

```typescript
export const getSocketServer = (): Server | null => {
  // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º –º–æ–¥—É–ª—å–Ω—É—é –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é
  if (io) return io
  
  // Fallback –Ω–∞ globalThis (–¥–ª—è —Å–ª—É—á–∞–µ–≤, –∫–æ–≥–¥–∞ –º–æ–¥—É–ª—å –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–µ–Ω)
  if (typeof globalThis !== 'undefined' && globalThis.io) {
    io = globalThis.io as TypedIOServer
    return io
  }
  
  return null
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –î–æ–±–∞–≤–ª–µ–Ω fallback –Ω–∞ `globalThis.io` –¥–ª—è —Å–ª—É—á–∞–µ–≤ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥—É–ª—è

### 4. –û–±–Ω–æ–≤–ª–µ–Ω API route

**–§–∞–π–ª:** `src/app/api/admin/monitoring/dashboard/route.ts`

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `getTotalConnections()` –≤–º–µ—Å—Ç–æ `io.sockets.sockets.size`
- –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ namespaces
- –£–ª—É—á—à–µ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏

---

## üìä –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

1. `src/lib/sockets/index.ts`
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `getTotalConnections()`
   - –î–æ–±–∞–≤–ª–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `syncMetrics()`
   - –£–ª—É—á—à–µ–Ω–∞ —Ñ—É–Ω–∫—Ü–∏—è `getSocketServer()`
   - –û–±–Ω–æ–≤–ª–µ–Ω—ã `handleConnection()` –∏ `disconnect` –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è `syncMetrics()`
   - –û–±–Ω–æ–≤–ª–µ–Ω–∞ `getSocketMetrics()` –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –ø–µ—Ä–µ–¥ –≤–æ–∑–≤—Ä–∞—Ç–æ–º

2. `src/app/api/admin/monitoring/dashboard/route.ts`
   - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `getTotalConnections()` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
   - –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –ø–æ namespaces
   - –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

3. `docs/analysis/socket-io-analysis.md` (–Ω–æ–≤—ã–π)
   - –°–æ–∑–¥–∞–Ω –ø–æ–ª–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã Socket.IO
   - –í—ã—è–≤–ª–µ–Ω—ã –ø—Ä–æ–±–ª–µ–º—ã –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω—ã —Ä–µ—à–µ–Ω–∏—è

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞

- ‚úÖ –õ–∏–Ω—Ç–µ—Ä: –Ω–µ—Ç –æ—à–∏–±–æ–∫
- ‚úÖ TypeScript: –∫–æ–¥ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è
- ‚úÖ –§—É–Ω–∫—Ü–∏–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã –∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏

---

## üß™ –ö–∞–∫ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å

1. –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–µ—Ä–≤–µ—Ä —Å Socket.IO:
   ```bash
   pnpm run dev:with-socket
   ```

2. –û—Ç–∫—Ä—ã—Ç—å –¥–∞—à–±–æ—Ä–¥ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞:
   ```
   http://localhost:3000/ru/admin/monitoring/dashboard
   ```

3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –º–µ—Ç—Ä–∏–∫—É "WebSocket Connections" - –¥–æ–ª–∂–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è —Ä–µ–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π:
   - `[monitoring] Using Socket.IO real connections` - —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
   - `Metrics synced` - –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏/–æ—Ç–∫–ª—é—á–µ–Ω–∏–∏

---

## üìù –í—ã–≤–æ–¥—ã

1. ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ —Å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º –º–µ—Ç—Ä–∏–∫ WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞
2. ‚úÖ –¢–µ–ø–µ—Ä—å —É—á–∏—Ç—ã–≤–∞—é—Ç—Å—è –≤—Å–µ namespaces (`/`, `/chat`, `/notifications`)
3. ‚úÖ –ú–µ—Ç—Ä–∏–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è —Å —Ä–µ–∞–ª—å–Ω—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π
4. ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
5. ‚úÖ –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è–º–∏

---

## üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–ï—Å–ª–∏ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–∞–ª—å–Ω–µ–π—à–µ–µ —É–ª—É—á—à–µ–Ω–∏–µ:

1. –î–æ–±–∞–≤–∏—Ç—å Redis adapter –¥–ª—è –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–≥–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
2. –î–æ–±–∞–≤–∏—Ç—å health check endpoint –¥–ª—è Socket.IO
3. –£–ª—É—á—à–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø–æ —Å–ø–æ—Å–æ–±–∞–º –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞

---

## üìö –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [Socket.IO Analysis](../analysis/socket-io-analysis.md)
- [Monitoring Dashboard Analysis](../monitoring/monitoring-pages-analysis.md)







