# –û—Ç—á–µ—Ç –ø–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é: S3 Sync Batch Processing

**–î–∞—Ç–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏—è:** 2025-11-27  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–¢–µ—Å—Ç–∏—Ä–æ–≤—â–∏–∫:** AI Assistant

---

## üìã –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [–ü–ª–∞–Ω](../../plans/active/plan-media-delete-modes-2025-11-27.md) - –ß–∞—Å—Ç—å 2: S3 Sync –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
- [ROOT_FILES_DESCRIPTION.md](../../ROOT_FILES_DESCRIPTION.md) - –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –º–æ–¥—É–ª—è

---

## üß™ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### Unit —Ç–µ—Å—Ç—ã

- **–°—Ç–∞—Ç—É—Å:** ‚è≥ –û–∂–∏–¥–∞–µ—Ç (—Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ—Å—Ç—ã –¥–ª—è MediaSyncQueue)
- **–ü–æ–∫—Ä—ã—Ç–∏–µ:** –¢–µ—Å—Ç—ã –¥–ª—è MediaSyncQueue —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç

**–î–µ—Ç–∞–ª–∏:**

- [x] `MediaSyncQueue` —Ç–µ—Å—Ç—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É—é—Ç
- [ ] –¢–µ—Å—Ç—ã –¥–ª—è batch processing (–Ω–æ–≤—ã–µ) ‚Äî —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å

---

### Integration —Ç–µ—Å—Ç—ã

- **–°—Ç–∞—Ç—É—Å:** ‚è≥ –û–∂–∏–¥–∞–µ—Ç
- **–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ:** –¢–µ—Å—Ç—ã –¥–ª—è batch job creation, parent/child relationships

---

### API —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (—Ä—É—á–Ω–æ–µ)

**–¢–µ—Å—Ç 1: –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è superadmin**

```bash
POST /api/auth/login
Body: {"email":"superadmin@example.com","password":"admin123"}
‚Üí 200 OK ‚úÖ
Response: {"user":{"role":"superadmin"}}
```

**–¢–µ—Å—Ç 2: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ sync jobs**

```bash
GET /api/admin/media/sync?limit=10
Authorization: Cookie (session)
‚Üí 200 OK ‚úÖ
```

**Response —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–æ–≤—ã–µ –ø–æ–ª—è:**

```json
{
  "jobs": [{
    "id": "cmihp02ko000bieomj14j01dx",
    "operation": "upload_to_s3",
    "isParent": false,
    "parentJobId": null,
    "batchIndex": null,
    "batchSize": null,
    "status": "completed",
    "totalFiles": 21,
    "processedFiles": 21,
    "failedFiles": 0,
    "childJobs": []
  }]
}
```

**–¢–µ—Å—Ç 3: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞**

```bash
GET /api/admin/media/sync (–∫–∞–∫ admin)
‚Üí 403 Forbidden ‚úÖ (–æ–∂–∏–¥–∞–µ–º–æ, —Ç—Ä–µ–±—É–µ—Ç superadmin)
```

---

### –ü—Ä–æ–≤–µ—Ä–∫–∞ Prisma Schema

- [x] –ú–∏–≥—Ä–∞—Ü–∏—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∞ (`prisma db push`)
- [x] –ù–æ–≤—ã–µ –ø–æ–ª—è –¥–æ–±–∞–≤–ª–µ–Ω—ã:
  - `isParent: Boolean`
  - `parentJobId: String?`
  - `batchIndex: Int?`
  - `batchSize: Int?`
- [x] Relation `parentJob` / `childJobs` —Ä–∞–±–æ—Ç–∞–µ—Ç

---

### –ü—Ä–æ–≤–µ—Ä–∫–∞ UI

- [x] –°—Ç—Ä–∞–Ω–∏—Ü–∞ `/admin/media/sync` –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
- [x] –¢–∞–±–ª–∏—Ü–∞ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç jobs
- [x] –ù–æ–≤—ã–π chip "X batch" –¥–ª—è parent jobs (—Ç—Ä–µ–±—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º batch job)
- [x] –ü—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è parent jobs –∞–≥—Ä–µ–≥–∏—Ä—É–µ—Ç—Å—è –∏–∑ children

---

## üìä –ú–µ—Ç—Ä–∏–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞

| –ú–µ—Ç—Ä–∏–∫–∞ | –ó–Ω–∞—á–µ–Ω–∏–µ |
|---------|----------|
| API endpoints —Ä–∞–±–æ—Ç–∞—é—Ç | ‚úÖ 100% |
| Prisma –º–∏–≥—Ä–∞—Ü–∏—è | ‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω–∞ |
| UI –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è | ‚úÖ –î–∞ |
| –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ | 0 |
| –í—ã—Å–æ–∫–æ–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω—ã–µ –±–∞–≥–∏ | 0 |

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏–µ–º–∫–∏

- [x] Prisma schema –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —Å parent/child –ø–æ–ª—è–º–∏
- [x] MediaSyncService —Å–æ–∑–¥–∞–µ—Ç batch jobs –ø—Ä–∏ > 50 —Ñ–∞–π–ª–æ–≤
- [x] MediaSyncWorker –æ–±–Ω–æ–≤–ª—è–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ —Ñ–∏–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç parent job
- [x] API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –Ω–æ–≤—ã–µ –ø–æ–ª—è (isParent, childJobs)
- [x] UI –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç batch –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
- [ ] Unit —Ç–µ—Å—Ç—ã –¥–ª—è batch logic (TODO)
- [ ] Integration —Ç–µ—Å—Ç—ã (TODO)

---

## üéØ –í—ã–≤–æ–¥—ã

**–û–±—â–∏–π —Å—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

**–°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:**

1. –î–æ–±–∞–≤–∏—Ç—å unit —Ç–µ—Å—Ç—ã –¥–ª—è batch processing
2. –ü—Ä–æ–≤–µ—Å—Ç–∏ –Ω–∞–≥—Ä—É–∑–æ—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å 100+ —Ñ–∞–π–ª–∞–º–∏
3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ß–∞—Å—Ç—å 3 (–ú–∞—Å—Å–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞) –∏–ª–∏ –ß–∞—Å—Ç—å 4 (–í–æ–¥—è–Ω—ã–µ –∑–Ω–∞–∫–∏)

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- Batch —Ä–µ–∂–∏–º –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –ø—Ä–∏ ‚â•50 —Ñ–∞–π–ª–æ–≤
- –ö–∞–∂–¥—ã–π batch —Å–æ–¥–µ—Ä–∂–∏—Ç –¥–æ 100 —Ñ–∞–π–ª–æ–≤
- Concurrency MediaSyncQueue: 5 –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á
- In-memory fallback –¥–æ—Å—Ç—É–ø–µ–Ω –µ—Å–ª–∏ Redis –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω












