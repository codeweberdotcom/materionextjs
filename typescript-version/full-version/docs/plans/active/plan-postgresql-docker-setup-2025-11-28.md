# –ü–ª–∞–Ω: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ PostgreSQL Docker Server –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–π —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-11-28  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ó–∞–≤–µ—Ä—à—ë–Ω  
**–î–∞—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:** 2025-11-28  
**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** –í—ã—Å–æ–∫–∏–π

---

## üéØ –¶–µ–ª—å

–°–æ–∑–¥–∞—Ç—å –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—É Docker –¥–ª—è –∑–∞–ø—É—Å–∫–∞ PostgreSQL –≤–º–µ—Å—Ç–æ SQLite –¥–ª—è —Ä–µ—à–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º —Å timeout –∏ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–Ω—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ –º–µ–¥–∏–∞ —Ñ–∞–π–ª–æ–≤. –¢–∞–∫–∂–µ —É–¥–∞–ª–∏—Ç—å –≤—Å–µ SQLite-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ workaround'—ã –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ –ø–æ–¥ PostgreSQL.

---

## üìã –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã

- [–ê–Ω–∞–ª–∏–∑ SQLite –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π –¥–ª—è –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ PostgreSQL](../../analysis/architecture/analysis-sqlite-limitations-for-postgresql-migration-2025-11-28.md) ‚¨ÖÔ∏è **–í–ê–ñ–ù–û**
- [–û—Ç—á—ë—Ç: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è Media Sync –∏ SQLite timeout](../../reports/fixes/report-media-sync-sqlite-fixes-2025-11-28.md)
- [–ú–æ–¥—É–ª—å S3 (MinIO)](../completed/plan-s3-minio-docker-setup-2025-11-26.md) ‚Äî –∞–Ω–∞–ª–æ–≥–∏—á–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

---

## üîç –ü—Ä–æ–±–ª–µ–º–∞

SQLite –Ω–µ —Å–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è —Å –º–∞—Å—Å–æ–≤—ã–º–∏ –æ–ø–µ—Ä–∞—Ü–∏—è–º–∏ –º–æ–¥—É–ª—è Media:

| –ü—Ä–æ–±–ª–µ–º–∞ | –í–ª–∏—è–Ω–∏–µ |
|----------|---------|
| Single-writer lock | –¢–æ–ª—å–∫–æ 1 –∑–∞–ø–∏—Å—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ |
| Timeout –ø—Ä–∏ concurrency | `Operations timed out after N/A` |
| –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ —Ñ–∞–π–ª–∞ –ë–î | `database is locked` |
| –ù–µ—Ç –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è | –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –Ω–∞–≥—Ä—É–∑–∫—É |

**PostgreSQL —Ä–µ—à–∞–µ—Ç –≤—Å–µ —ç—Ç–∏ –ø—Ä–æ–±–ª–µ–º—ã** –±–ª–∞–≥–æ–¥–∞—Ä—è row-level locking –∏ MVCC.

---

## üî¥ SQLite Workaround'—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è

–ù–∞ –æ—Å–Ω–æ–≤–µ [–∞–Ω–∞–ª–∏–∑–∞](../../analysis/architecture/analysis-sqlite-limitations-for-postgresql-migration-2025-11-28.md) –≤—ã—è–≤–ª–µ–Ω—ã —Å–ª–µ–¥—É—é—â–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:

| Workaround | –§–∞–π–ª | –î–µ–π—Å—Ç–≤–∏–µ |
|------------|------|----------|
| `withDbRetry` wrapper | `src/lib/db/retry.ts` | –£–¥–∞–ª–∏—Ç—å/–∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å |
| `concurrency: 3` | `MediaProcessingQueue.ts` | –£–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 10 |
| `concurrency: 3` | `MediaSyncQueue.ts` | –£–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 8 |
| `concurrency: 3` | `WatermarkQueue.ts` | –£–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 5 |
| `batchSize: 50` | `MediaSyncService.ts` | –£–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 200 |
| `parallelLimit: 5` | `MediaSyncService.ts` | –£–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 20 |
| Non-blocking `.catch()` | `MediaSyncService.ts` | –í–µ—Ä–Ω—É—Ç—å `await` |
| `timeout: 10000` | `MediaSyncWorker.ts` | –£–±—Ä–∞—Ç—å/—É–≤–µ–ª–∏—á–∏—Ç—å |
| `slice(-100)` results | `MediaSyncWorker.ts` | –£–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 1000 |
| `slice(-50)` results | `MediaSyncService.ts` | –£–≤–µ–ª–∏—á–∏—Ç—å –¥–æ 500 |

---

## ‚è±Ô∏è –°—Ä–æ–∫–∏

- **–ù–∞—á–∞–ª–æ:** 2025-11-28
- **–ü–ª–∞–Ω–∏—Ä—É–µ–º–æ–µ –æ–∫–æ–Ω—á–∞–Ω–∏–µ:** 2025-11-28
- **–§–∞–∫—Ç–∏—á–µ—Å–∫–æ–µ –æ–∫–æ–Ω—á–∞–Ω–∏–µ:** ‚Äî

---

## üìä –≠—Ç–∞–ø—ã —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –≠—Ç–∞–ø 1: –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã Docker

**–¶–µ–ª—å:** –°–æ–∑–¥–∞—Ç—å docker-compose.yml —Å PostgreSQL

**–ó–∞–¥–∞—á–∏:**

- [ ] –ó–∞–¥–∞—á–∞ 1.1 - –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É `postgresql/`
- [ ] –ó–∞–¥–∞—á–∞ 1.2 - –°–æ–∑–¥–∞—Ç—å `docker-compose.yml` —Å PostgreSQL 16
- [ ] –ó–∞–¥–∞—á–∞ 1.3 - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ—Ä—Ç 5432
- [ ] –ó–∞–¥–∞—á–∞ 1.4 - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å volume –¥–ª—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö
- [ ] –ó–∞–¥–∞—á–∞ 1.5 - –î–æ–±–∞–≤–∏—Ç—å healthcheck

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:**

- [ ] PostgreSQL –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ localhost:5432
- [ ] –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏
- [ ] Healthcheck –ø—Ä–æ—Ö–æ–¥–∏—Ç

**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** 10 –º–∏–Ω—É—Ç

---

### –≠—Ç–∞–ø 2: npm —Å–∫—Ä–∏–ø—Ç—ã

**–¶–µ–ª—å:** –î–æ–±–∞–≤–∏—Ç—å —É–¥–æ–±–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

**–ó–∞–¥–∞—á–∏:**

- [ ] –ó–∞–¥–∞—á–∞ 2.1 - `pg:up` - –∑–∞–ø—É—Å–∫ PostgreSQL
- [ ] –ó–∞–¥–∞—á–∞ 2.2 - `pg:down` - –æ—Å—Ç–∞–Ω–æ–≤–∫–∞
- [ ] –ó–∞–¥–∞—á–∞ 2.3 - `pg:logs` - –ø—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
- [ ] –ó–∞–¥–∞—á–∞ 2.4 - `pg:psql` - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ psql
- [ ] –ó–∞–¥–∞—á–∞ 2.5 - `dev:with-pg` - dev —Å–µ—Ä–≤–µ—Ä —Å PostgreSQL

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:**

- [ ] –í—Å–µ –∫–æ–º–∞–Ω–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** 10 –º–∏–Ω—É—Ç

---

### –≠—Ç–∞–ø 3: –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Prisma

**–¶–µ–ª—å:** –ù–∞—Å—Ç—Ä–æ–∏—Ç—å Prisma –¥–ª—è PostgreSQL

**–ó–∞–¥–∞—á–∏:**

- [ ] –ó–∞–¥–∞—á–∞ 3.1 - –°–æ–∑–¥–∞—Ç—å `schema.postgresql.prisma` (–∫–æ–ø–∏—è schema.prisma)
- [ ] –ó–∞–¥–∞—á–∞ 3.2 - –ò–∑–º–µ–Ω–∏—Ç—å provider –Ω–∞ `postgresql`
- [ ] –ó–∞–¥–∞—á–∞ 3.3 - –î–æ–±–∞–≤–∏—Ç—å `.env.postgresql` —Å DATABASE_URL
- [ ] –ó–∞–¥–∞—á–∞ 3.4 - –°–æ–∑–¥–∞—Ç—å —Å–∫—Ä–∏–ø—Ç –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –ë–î
- [ ] –ó–∞–¥–∞—á–∞ 3.5 - –í—ã–ø–æ–ª–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é (`npx prisma migrate dev`)

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:**

- [ ] Prisma –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ PostgreSQL
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –º–µ–∂–¥—É SQLite –∏ PostgreSQL

**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** 20 –º–∏–Ω—É—Ç

---

### –≠—Ç–∞–ø 4: Seed –¥–∞–Ω–Ω—ã–µ

**–¶–µ–ª—å:** –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å seed –¥–ª—è PostgreSQL

**–ó–∞–¥–∞—á–∏:**

- [ ] –ó–∞–¥–∞—á–∞ 4.1 - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å seed.ts —Å PostgreSQL
- [ ] –ó–∞–¥–∞—á–∞ 4.2 - –ò—Å–ø—Ä–∞–≤–∏—Ç—å –Ω–µ—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ (–µ—Å–ª–∏ –µ—Å—Ç—å)
- [ ] –ó–∞–¥–∞—á–∞ 4.3 - –í—ã–ø–æ–ª–Ω–∏—Ç—å seed

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:**

- [ ] Seed –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] –í—Å–µ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–æ–∑–¥–∞–Ω—ã

**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** 15 –º–∏–Ω—É—Ç

---

### –≠—Ç–∞–ø 5: üî¥ –£–¥–∞–ª–µ–Ω–∏–µ SQLite Workaround'–æ–≤ (–ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô)

**–¶–µ–ª—å:** –£–¥–∞–ª–∏—Ç—å –≤—Å–µ SQLite-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

**–ó–∞–¥–∞—á–∏:**

#### 5.1 –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å `withDbRetry` wrapper

**–§–∞–π–ª:** `src/lib/db/retry.ts`

- [ ] –ó–∞–¥–∞—á–∞ 5.1.1 - –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –≤ `withNetworkRetry`
- [ ] –ó–∞–¥–∞—á–∞ 5.1.2 - –£–±—Ä–∞—Ç—å SQLite-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –æ—à–∏–±–æ–∫:
  ```typescript
  // –£–î–ê–õ–ò–¢–¨:
  lastError.message.includes('SQLITE_BUSY')
  lastError.message.includes('database is locked')
  ```
- [ ] –ó–∞–¥–∞—á–∞ 5.1.3 - –û—Å—Ç–∞–≤–∏—Ç—å —Ç–æ–ª—å–∫–æ —Å–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏ (connection refused, timeout)
- [ ] –ó–∞–¥–∞—á–∞ 5.1.4 - –£–º–µ–Ω—å—à–∏—Ç—å `maxRetries` —Å 5 –¥–æ 2
- [ ] –ó–∞–¥–∞—á–∞ 5.1.5 - –£–º–µ–Ω—å—à–∏—Ç—å `baseDelay` —Å 150ms –¥–æ 50ms

#### 5.2 –£–≤–µ–ª–∏—á–∏—Ç—å Concurrency –æ—á–µ—Ä–µ–¥–µ–π

**–§–∞–π–ª—ã:** `src/services/media/queue/`

- [ ] –ó–∞–¥–∞—á–∞ 5.2.1 - `MediaProcessingQueue.ts`: `concurrency: 3` ‚Üí `10`
- [ ] –ó–∞–¥–∞—á–∞ 5.2.2 - `MediaSyncQueue.ts`: `concurrency: 3` ‚Üí `8`
- [ ] –ó–∞–¥–∞—á–∞ 5.2.3 - `WatermarkQueue.ts`: `concurrency: 3` ‚Üí `5`
- [ ] –ó–∞–¥–∞—á–∞ 5.2.4 - –£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ "–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è SQLite"

#### 5.3 –£–≤–µ–ª–∏—á–∏—Ç—å Batch Config

**–§–∞–π–ª:** `src/services/media/sync/MediaSyncService.ts`

- [ ] –ó–∞–¥–∞—á–∞ 5.3.1 - `batchSize: 50` ‚Üí `200`
- [ ] –ó–∞–¥–∞—á–∞ 5.3.2 - `minFilesForBatching: 30` ‚Üí `100`
- [ ] –ó–∞–¥–∞—á–∞ 5.3.3 - `parallelLimit: 5` ‚Üí `20`
- [ ] –ó–∞–¥–∞—á–∞ 5.3.4 - –£–¥–∞–ª–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π "–æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–æ –¥–ª—è SQLite"

#### 5.4 –£–±—Ä–∞—Ç—å Non-blocking –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è

**–§–∞–π–ª:** `src/services/media/sync/MediaSyncService.ts`

- [ ] –ó–∞–¥–∞—á–∞ 5.4.1 - –í–µ—Ä–Ω—É—Ç—å `await` –ø–µ—Ä–µ–¥ `withDbRetry` (—Å—Ç—Ä–æ–∫–∞ ~445)
- [ ] –ó–∞–¥–∞—á–∞ 5.4.2 - –£–±—Ä–∞—Ç—å `.catch()` –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–≥–ª–∞—Ç—ã–≤–∞–µ—Ç –æ—à–∏–±–∫–∏
- [ ] –ó–∞–¥–∞—á–∞ 5.4.3 - –ò–ª–∏ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ –æ–±—ã—á–Ω—ã–π `await prisma.mediaSyncJob.update()`

**–î–æ:**
```typescript
withDbRetry(...).catch(err => {
  logger.warn('Progress update failed (non-critical)')
})
```

**–ü–æ—Å–ª–µ:**
```typescript
await prisma.mediaSyncJob.update({
  where: { id: jobId },
  data: { processedFiles, failedFiles, processedBytes }
})
```

#### 5.5 –£–±—Ä–∞—Ç—å Transaction Timeout

**–§–∞–π–ª:** `src/services/media/queue/MediaSyncWorker.ts`

- [ ] –ó–∞–¥–∞—á–∞ 5.5.1 - –£–±—Ä–∞—Ç—å `timeout: 10000` –∏–∑ `$transaction`
- [ ] –ó–∞–¥–∞—á–∞ 5.5.2 - –ò–ª–∏ —É–≤–µ–ª–∏—á–∏—Ç—å –¥–æ `60000` (1 –º–∏–Ω—É—Ç–∞)

#### 5.6 –£–≤–µ–ª–∏—á–∏—Ç—å –ª–∏–º–∏—Ç—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

- [ ] –ó–∞–¥–∞—á–∞ 5.6.1 - `MediaSyncWorker.ts`: `slice(-100)` ‚Üí `slice(-1000)`
- [ ] –ó–∞–¥–∞—á–∞ 5.6.2 - `MediaSyncService.ts`: `slice(-50)` ‚Üí `slice(-500)`

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:**

- [ ] –í—Å–µ SQLite-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ workaround'—ã —É–¥–∞–ª–µ–Ω—ã
- [ ] –ö–æ–¥ –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø—Ä–æ SQLite —É–¥–∞–ª–µ–Ω—ã

**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** 30 –º–∏–Ω—É—Ç

---

### –≠—Ç–∞–ø 6: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

**–¶–µ–ª—å:** –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç

**–ó–∞–¥–∞—á–∏:**

- [ ] –ó–∞–¥–∞—á–∞ 6.1 - –ó–∞–≥—Ä—É–∑–∏—Ç—å 100 —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ –º–µ–¥–∏–∞—Ç–µ–∫—É
- [ ] –ó–∞–¥–∞—á–∞ 6.2 - –ó–∞–≥—Ä—É–∑–∏—Ç—å 1000 —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ –º–µ–¥–∏–∞—Ç–µ–∫—É
- [ ] –ó–∞–¥–∞—á–∞ 6.3 - –ó–∞–ø—É—Å—Ç–∏—Ç—å S3 —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –Ω–∞ 1000+ —Ñ–∞–π–ª–æ–≤
- [ ] –ó–∞–¥–∞—á–∞ 6.4 - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ timeout –æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö
- [ ] –ó–∞–¥–∞—á–∞ 6.5 - –ó–∞–º–µ—Ä–∏—Ç—å –≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:**

- [ ] –ù–µ—Ç `timed out` –æ—à–∏–±–æ–∫
- [ ] –ù–µ—Ç `database is locked` –æ—à–∏–±–æ–∫
- [ ] –í—Ä–µ–º—è sync < 2 –º–∏–Ω—É—Ç –¥–ª—è 1000 —Ñ–∞–π–ª–æ–≤

**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** 20 –º–∏–Ω—É—Ç

---

### –≠—Ç–∞–ø 7: –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

**–¶–µ–ª—å:** –°–æ–∑–¥–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

**–ó–∞–¥–∞—á–∏:**

- [ ] –ó–∞–¥–∞—á–∞ 7.1 - –°–æ–∑–¥–∞—Ç—å `postgresql/README.md`
- [ ] –ó–∞–¥–∞—á–∞ 7.2 - –û–ø–∏—Å–∞—Ç—å –∑–∞–ø—É—Å–∫ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫—É
- [ ] –ó–∞–¥–∞—á–∞ 7.3 - –û–ø–∏—Å–∞—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É SQLite –∏ PostgreSQL
- [ ] –ó–∞–¥–∞—á–∞ 7.4 - –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∏–º–µ—Ä—ã ENV –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
- [ ] –ó–∞–¥–∞—á–∞ 7.5 - –ó–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —É–¥–∞–ª—ë–Ω–Ω—ã–µ SQLite workaround'—ã

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:**

- [ ] README —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** 15 –º–∏–Ω—É—Ç

---

### –≠—Ç–∞–ø 8: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞

**–¶–µ–ª—å:** –û–±–Ω–æ–≤–∏—Ç—å –æ–±—â—É—é –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é

**–ó–∞–¥–∞—á–∏:**

- [ ] –ó–∞–¥–∞—á–∞ 8.1 - –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é "–ú–æ–¥—É–ª—å PostgreSQL" –≤ `ROOT_FILES_DESCRIPTION.md`
- [ ] –ó–∞–¥–∞—á–∞ 8.2 - –û–±–Ω–æ–≤–∏—Ç—å `STATUS_INDEX.md`
- [ ] –ó–∞–¥–∞—á–∞ 8.3 - –°–æ–∑–¥–∞—Ç—å –æ—Ç—á—ë—Ç –æ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- [ ] –ó–∞–¥–∞—á–∞ 8.4 - –û–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–∏–∑ SQLite –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π (–ø–æ–º–µ—Ç–∏—Ç—å –∫–∞–∫ —Ä–µ—à—ë–Ω–Ω—ã–µ)

**–ö—Ä–∏—Ç–µ—Ä–∏–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è:**

- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞
- [ ] –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª—ë–Ω

**–û—Ü–µ–Ω–∫–∞ –≤—Ä–µ–º–µ–Ω–∏:** 10 –º–∏–Ω—É—Ç

---

## üìà –ü—Ä–æ–≥—Ä–µ—Å—Å

- **–í—ã–ø–æ–ª–Ω–µ–Ω–æ:** 0%
- **–û—Å—Ç–∞–ª–æ—Å—å:** 100%
- **–¢–µ–∫—É—â–∏–π —ç—Ç–∞–ø:** –≠—Ç–∞–ø 1

---

## ‚ö†Ô∏è –†–∏—Å–∫–∏ –∏ –º–∏—Ç–∏–≥–∞—Ü–∏—è

1. **–ö–æ–Ω—Ñ–ª–∏–∫—Ç –ø–æ—Ä—Ç–∞ 5432**
   - –û–ø–∏—Å–∞–Ω–∏–µ —Ä–∏—Å–∫–∞: –ü–æ—Ä—Ç –º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º PostgreSQL
   - –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å: –°—Ä–µ–¥–Ω—è—è
   - –í–ª–∏—è–Ω–∏–µ: –ù–∏–∑–∫–æ–µ
   - –ú–∏—Ç–∏–≥–∞—Ü–∏—è: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –ø–æ—Ä—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, 5433)

2. **–ù–µ—Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å SQL**
   - –û–ø–∏—Å–∞–Ω–∏–µ —Ä–∏—Å–∫–∞: SQLite-—Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –º–æ–≥—É—Ç –Ω–µ —Ä–∞–±–æ—Ç–∞—Ç—å
   - –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å: –ù–∏–∑–∫–∞—è (Prisma –∞–±—Å—Ç—Ä–∞–≥–∏—Ä—É–µ—Ç)
   - –í–ª–∏—è–Ω–∏–µ: –ù–∏–∑–∫–æ–µ
   - –ú–∏—Ç–∏–≥–∞—Ü–∏—è: Prisma –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç —Ä–∞–∑–ª–∏—á–∏—è

3. **–ü–æ—Ç–µ—Ä—è –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏**
   - –û–ø–∏—Å–∞–Ω–∏–µ —Ä–∏—Å–∫–∞: –î–∞–Ω–Ω—ã–µ –≤ SQLite –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
   - –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å: ‚Äî
   - –í–ª–∏—è–Ω–∏–µ: –î–ª—è dev –¥–∞–Ω–Ω—ã—Ö ‚Äî –Ω–∏–∑–∫–æ–µ
   - –ú–∏—Ç–∏–≥–∞—Ü–∏—è: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å seed –¥–ª—è –Ω–æ–≤–æ–π –ë–î

4. **–†–µ–≥—Ä–µ—Å—Å–∏–∏ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è workaround'–æ–≤**
   - –û–ø–∏—Å–∞–Ω–∏–µ —Ä–∏—Å–∫–∞: –ö–æ–¥ –º–æ–∂–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ
   - –í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å: –ù–∏–∑–∫–∞—è
   - –í–ª–∏—è–Ω–∏–µ: –°—Ä–µ–¥–Ω–µ–µ
   - –ú–∏—Ç–∏–≥–∞—Ü–∏—è: –¢—â–∞—Ç–µ–ª—å–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –≠—Ç–∞–ø–µ 6

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ü–ª–∞–Ω —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:

- [ ] –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ psql
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –º–∏–≥—Ä–∞—Ü–∏–∏ Prisma
- [ ] –¢–µ—Å—Ç –º–∞—Å—Å–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–¥–∏–∞ (100 —Ñ–∞–π–ª–æ–≤)
- [ ] –¢–µ—Å—Ç –º–∞—Å—Å–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –º–µ–¥–∏–∞ (1000+ —Ñ–∞–π–ª–æ–≤)
- [ ] –¢–µ—Å—Ç S3 —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –±–µ–∑ timeout
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ concurrency (–ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø–∏—Å–∏)
- [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è SQLite-–æ—à–∏–±–æ–∫ –≤ –ª–æ–≥–∞—Ö

### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏–µ–º–∫–∏:

- [ ] PostgreSQL –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- [ ] Prisma —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è
- [ ] –ú–∞—Å—Å–æ–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –º–µ–¥–∏–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ timeout
- [ ] S3 —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ
- [ ] –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ 1000 —Ñ–∞–π–ª–æ–≤ < 2 –º–∏–Ω—É—Ç

---

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

### –ß—Ç–æ –Ω—É–∂–Ω–æ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å:

- [ ] README –≤ –ø–∞–ø–∫–µ postgresql/
- [ ] –û–±–Ω–æ–≤–∏—Ç—å package.json —Å–æ —Å–∫—Ä–∏–ø—Ç–∞–º–∏
- [ ] –û–±–Ω–æ–≤–∏—Ç—å ROOT_FILES_DESCRIPTION.md
- [ ] –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—é SQLite ‚Üî PostgreSQL
- [ ] –°–ø–∏—Å–æ–∫ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö SQLite workaround'–æ–≤

---

## ‚úÖ –ß–µ–∫-–ª–∏—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è

- [ ] –í—Å–µ —ç—Ç–∞–ø—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã
- [ ] Docker PostgreSQL —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] Prisma –º–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
- [ ] Seed –¥–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã
- [ ] SQLite workaround'—ã —É–¥–∞–ª–µ–Ω—ã
- [ ] Concurrency —É–≤–µ–ª–∏—á–µ–Ω
- [ ] Batch size —É–≤–µ–ª–∏—á–µ–Ω
- [ ] –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–π–¥–µ–Ω–æ
- [ ] –ù–µ—Ç timeout –æ—à–∏–±–æ–∫
- [ ] –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞
- [ ] –û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω
- [ ] –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω –≤ STATUS_INDEX.md

---

## üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤ (–ø–ª–∞–Ω)

```
postgresql/
‚îú‚îÄ‚îÄ docker-compose.yml    # PostgreSQL –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
‚îî‚îÄ‚îÄ README.md             # –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏

prisma/
‚îú‚îÄ‚îÄ schema.prisma         # SQLite (—Ç–µ–∫—É—â–∏–π, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
‚îî‚îÄ‚îÄ schema.postgresql.prisma  # PostgreSQL (–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π)

.env                      # SQLite –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
.env.postgresql           # PostgreSQL –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
```

---

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è PostgreSQL (–ø–ª–∞–Ω)

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ |
|----------|----------|
| Image | `postgres:16-alpine` |
| Container name | `materio-postgresql` |
| Port | 5432 |
| Database | `materio` |
| User | `materio` |
| Password | `materio123` |
| Volume | `materio-postgresql-data` |

---

## üåê URL –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

```env
# PostgreSQL
DATABASE_URL="postgresql://materio:materio123@localhost:5432/materio?schema=public"

# SQLite (—Ç–µ–∫—É—â–∏–π)
DATABASE_URL="file:./dev3.db"
```

---

## üîÑ –ö–æ–º–∞–Ω–¥—ã –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è

```bash
# –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å PostgreSQL
pnpm pg:up
pnpm dev:with-pg

# –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ SQLite
pnpm pg:down
pnpm dev
```

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ (–æ–∂–∏–¥–∞–µ–º–æ–µ)

| –ü–∞—Ä–∞–º–µ—Ç—Ä | SQLite (–±—ã–ª–æ) | PostgreSQL (–±—É–¥–µ—Ç) | –£–ª—É—á—à–µ–Ω–∏–µ |
|----------|:-------------:|:------------------:|:---------:|
| **Concurrency –æ—á–µ—Ä–µ–¥–µ–π** | 3 | 10 | **3.3x** |
| **Batch size** | 50 | 200 | **4x** |
| **Parallel limit** | 5 | 20 | **4x** |
| **Retry –ø–æ–ø—ã—Ç–∫–∏** | 5 | 1-2 | **2.5x –º–µ–Ω—å—à–µ** |
| **1000 —Ñ–∞–π–ª–æ–≤ sync** | ~5 –º–∏–Ω + timeout | ~1 –º–∏–Ω | **5x –±—ã—Å—Ç—Ä–µ–µ** |
| **Timeout –æ—à–∏–±–∫–∏** | –ß–∞—Å—Ç–æ | ~0 | **‚àû** |

---

## üóÇÔ∏è –§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è (–≠—Ç–∞–ø 5)

| # | –§–∞–π–ª | –ò–∑–º–µ–Ω–µ–Ω–∏–µ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|:-:|------|-----------|:---------:|
| 1 | `src/lib/db/retry.ts` | –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è PostgreSQL | üî¥ |
| 2 | `src/services/media/queue/MediaProcessingQueue.ts` | `concurrency: 3` ‚Üí `10` | üî¥ |
| 3 | `src/services/media/queue/MediaSyncQueue.ts` | `concurrency: 3` ‚Üí `8` | üî¥ |
| 4 | `src/services/media/queue/WatermarkQueue.ts` | `concurrency: 3` ‚Üí `5` | üü† |
| 5 | `src/services/media/sync/MediaSyncService.ts` | Batch config + —É–±—Ä–∞—Ç—å `.catch()` | üî¥ |
| 6 | `src/services/media/queue/MediaSyncWorker.ts` | –£–±—Ä–∞—Ç—å timeout + —É–≤–µ–ª–∏—á–∏—Ç—å limits | üü† |

---

## üí° –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è (–±—É–¥—É—â–µ–µ)

–ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –º–∏–≥—Ä–∞—Ü–∏–∏ –º–æ–∂–Ω–æ:

1. **Connection pooling** ‚Äî PgBouncer –¥–ª—è production
2. **Slow query logging** ‚Äî –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ–¥–ª–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
3. **Backup/restore** ‚Äî pg_dump —Å–∫—Ä–∏–ø—Ç—ã
4. **–ò–Ω–¥–µ–∫—Å—ã** ‚Äî –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —á–∞—Å—Ç—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
5. **Partitioning** ‚Äî –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã Media (–µ—Å–ª–∏ > 1M –∑–∞–ø–∏—Å–µ–π)

---

## üìù –ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π

- 2025-11-28: –°–æ–∑–¥–∞–Ω –ø–ª–∞–Ω
- 2025-11-28: –î–æ–±–∞–≤–ª–µ–Ω –≠—Ç–∞–ø 5 (—É–¥–∞–ª–µ–Ω–∏–µ SQLite workaround'–æ–≤) –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞
- 2025-11-28: –î–æ–±–∞–≤–ª–µ–Ω –≠—Ç–∞–ø 6 (—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏)
- 2025-11-28: –û–±–Ω–æ–≤–ª–µ–Ω—ã –∫—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏–µ–º–∫–∏
