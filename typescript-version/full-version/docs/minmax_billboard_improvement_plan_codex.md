# План улучшений для доски объявлений (сжатая версия)
**Фокус:** безопасность PII, корректность данных, тесты, операционка. Без «nice-to-have» и длинных описаний.

## 1) PII/безопасность (срочно)
- Завершить полное хэширование IP/email в событиях и блоках, исключить сырые данные.
- Ротация секретов: ввести версионирование ключей и процедуру смены (env + runbook).
- Retention: очистка RateLimitEvent (90 дней) и UserBlock (перманентные по бизнес‑политике), автоматический cron/скрипт.
- Маскирование логов (IP/email) и контроль экспорта (Sentry/метрики).

> Обновление 2025‑11‑16: временно включено сохранение сырых IP/email в событиях (recordEvent) вместе с хэшами по запросу. Требуется решение: либо вернуться к полной PII-маскировке, либо переключиться на шифрование (ipEnc/emailEnc) с ротацией ключей и ограниченным доступом.

## 2) Корректность и UX блокировок
- Всегда показывать последнюю причину/номер нарушения из RateLimitEvent, даже после истечения окна.
- История блоков в модалке: гарантировать загрузку событий, без «Авто/—».
- Ручные блоки: читаемые Target (email/IP/CIDR/ASN), автор с ссылкой, понятный статус «Навсегда».
- Проверка/обогащение: блоки module=all видны при фильтре модулей; CI/DRY API для списков.

## 3) Тестирование (критический минимум)
- Unit/интеграционные тесты для: RateLimitService (consume, block, warn), PrismaStore/RedisStore (fallback), API `/admin/rate-limits` (states/events) и `/admin/blocks`.
- Snapshot тесты UI фильтров/истории в /admin/blocks (минимум happy-path).

## 4) Операционная документация
- Runbook: как крутить конфиги лимитов, смотреть историю, снимать блок, ротация секретов, retention.
- Алерты/метрики: какие графики смотреть, пороги, что делать при «штормах».
- Гайд по приватности (PII): что хранится, сколько живёт, как выполнить «право на забвение».

## 5) Минимальный процесс
- План‑итерация на 1–2 недели: взять по одному пункту из блоков (PII→UX→тесты→дока), не раздувать до десятков задач.
- Отдельный backlog для «nice-to-have» (AES/CMK, consent manager, глубокая оптимизация Redis), но не блокировать текущий спринт.
