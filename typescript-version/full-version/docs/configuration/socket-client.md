# Конфигурация клиентского Socket.IO

## Обзор

Клиентские соединения Socket.IO инициализируются компонентом `src/components/SocketManager.tsx`. Он:

- получает session-token через `/api/auth/session-token` (с учётом `NEXT_PUBLIC_API_URL`);
- открывает два неймспейса (`/chat` и `/notifications`);
- поддерживает автоматические переподключения и heartbeat-`ping` каждые 30 секунд;
- выводит единичное предупреждение, если сервер Socket.IO недоступен, вместо лавины ошибок в браузере.

## Переменные окружения

| Переменная | Назначение | Значение по умолчанию |
|------------|------------|-----------------------|
| `NEXT_PUBLIC_ENABLE_SOCKET_IO` | Глобальный переключатель SocketManager. Установите `false`, чтобы полностью отключить подключение на фронтенде. | `true` |
| `NEXT_PUBLIC_SOCKET_URL` | Базовый URL Socket.IO сервера. Оставьте пустым, чтобы использовать тот же хост/порт, что и Next.js. Пример внешнего значения: `http://localhost:3003`. | пусто |
| `NEXT_PUBLIC_SOCKET_PATH` | Путь к эндпоинту Socket.IO, если сервер развёрнут за reverse-proxy. | `/socket.io` |
| `NEXT_PUBLIC_API_URL` | Используется для получения session-token через REST API. Переопределите при вынесении API на другой домен. | `http://localhost:3000/api` |

Все переменные продублированы в `.env` и `.env.example`. После изменения необходимо перезапустить dev-сервер.

## Типовые сценарии

1. **Разработка без сервера сокетов**  
   Установите `NEXT_PUBLIC_ENABLE_SOCKET_IO=false`. SocketManager не будет выполнять HTTP-запросы и создавать соединения.

2. **Отдельный сервер Socket.IO**  
   Запустите `pnpm run dev:with-socket`. Если фронтенд обслуживается другим доменом/портом, пропишите `NEXT_PUBLIC_SOCKET_URL` (и при необходимости `NEXT_PUBLIC_SOCKET_PATH`), чтобы клиент подключался к правильному адресу.

3. **Только локальный Next.js**  
   Оставьте переменные по умолчанию: клиент подключится к тому же хосту, где запущен Next.js, и будет использовать встроенный сервер сокетов из `dev:with-socket`.

## Поведение при ошибках

- Если токен получить не удалось (ошибка или статус ≠ 200), выводится предупреждение, и соединения не создаются.
- Если сервер сокетов недоступен, в консоли появится единичное предупреждение с подсказкой запустить `pnpm run dev:with-socket` или отключить сокеты через `NEXT_PUBLIC_ENABLE_SOCKET_IO=false`.
- При размонтировании компонента либо при смене пользователя сокеты закрываются, а `ping`-интервал очищается, чтобы избежать "зависших" соединений.
